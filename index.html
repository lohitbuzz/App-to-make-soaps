<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lohit SOAP App v1.6</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --primary: #0f766e;
      --primary-soft: #ecfdf3;
      --primary-dark: #115e59;
      --text: #111827;
      --muted: #6b7280;
      --danger: #dc2626;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .app-shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    header {
      margin-bottom: 12px;
    }

    .app-title {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      display: flex;
      align-items: baseline;
      gap: 8px;
    }

    .app-title span {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--muted);
    }

    .app-subtitle {
      margin-top: 4px;
      font-size: 0.9rem;
      color: var(--muted);
    }

    /* Tabs */
    .tab-bar {
      display: flex;
      gap: 8px;
      margin: 12px 0;
      overflow-x: auto;
    }

    .tab-btn {
      flex: 1;
      min-width: 0;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      font-size: 0.9rem;
      font-weight: 500;
      text-align: center;
      cursor: pointer;
      white-space: nowrap;
    }

    .tab-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .main-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 16px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .main-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding: 14px 16px 16px;
      margin-bottom: 10px;
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .card-subtitle {
      margin: 0 0 8px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .field-label {
      display: block;
      font-size: 0.8rem;
      font-weight: 500;
      margin-bottom: 4px;
      color: #374151;
    }

    .input,
    .select,
    .textarea {
      width: 100%;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: 8px 10px;
      font-size: 0.9rem;
      font-family: inherit;
      background: #f9fafb;
      outline: none;
      transition: border-color 0.12s ease, box-shadow 0.12s ease;
    }

    .input:focus,
    .select:focus,
    .textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(15, 118, 110, 0.2);
      background: #ffffff;
    }

    .textarea {
      resize: vertical;
    }

    .btn-primary,
    .btn-secondary,
    .btn-ghost {
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.9rem;
      font-weight: 500;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-secondary {
      background: #eef2ff;
      color: #1e293b;
      border: 1px solid #e0e7ff;
    }

    .btn-ghost {
      background: transparent;
      border: 1px dashed var(--border);
      color: var(--muted);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .muted {
      color: var(--muted);
      font-size: 0.8rem;
    }

    .grid-two {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    @media (max-width: 700px) {
      .grid-two {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 4px;
    }

    .chip {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .chip-selected {
      background: var(--primary);
      color: #ffffff;
      border-color: var(--primary);
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.85rem;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .checkbox-label input {
      margin: 0;
    }

    .attachment-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .attachment-status {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .output-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .output-header h3 {
      margin: 0;
      font-size: 0.95rem;
    }

    .copy-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .output-box {
      margin-bottom: 10px;
    }

    .output-box textarea {
      font-size: 0.85rem;
      background: #f9fafb;
    }

    .feedback-bar {
      font-size: 0.8rem;
      padding: 8px 10px;
      border-radius: var(--radius-md);
      background: #ecfeff;
      border: 1px solid #bae6fd;
      color: #0f172a;
      margin-top: 6px;
    }

    .feedback-chips {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .feedback-chip {
      border-radius: 999px;
      padding: 2px 8px;
      background: #e5f3ff;
      font-size: 0.75rem;
    }

    .hidden {
      display: none;
    }

    .hidden-input {
      display: none;
    }

    /* Overlay */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .overlay.hidden {
      display: none;
    }

    .overlay-inner {
      background: #ffffff;
      border-radius: var(--radius-lg);
      padding: 14px 14px 16px;
      max-width: 480px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: var(--shadow-soft);
    }

    @media (max-width: 768px) {
      .overlay-inner {
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
      }
    }

    .overlay-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .overlay-header h3 {
      margin: 0;
      font-size: 1rem;
    }

    .overlay-close {
      border: none;
      background: transparent;
      font-size: 1.5rem;
      cursor: pointer;
      line-height: 1;
    }

    .photo-preview {
      flex: 1;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f3f4f6;
    }

    .photo-preview img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .overlay-privacy {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .privacy-chip {
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid #22c55e;
      background: #ecfdf3;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .privacy-chip.active {
      background: #22c55e;
      color: white;
    }

    .privacy-text {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .overlay-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 6px;
    }

    .error-text {
      color: var(--danger);
      font-size: 0.8rem;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="app-title">
        Lohit SOAP App <span>v1.6 ‚Äì Stable</span>
      </div>
      <div class="app-subtitle">
        Appointment / Surgery SOAPs + Toolbox Lite. Mobile-friendly, clinic-safe, Avimark-compatible text.
      </div>
    </header>

    <div class="tab-bar">
      <button class="tab-btn active" data-tab="appointmentTab">Appointment</button>
      <button class="tab-btn" data-tab="surgeryTab">Surgery</button>
      <button class="tab-btn" data-tab="toolboxTab">Toolbox Lite</button>
    </div>

    <div class="main-grid">
      <!-- LEFT: INPUT AREA -->
      <div>
        <!-- APPOINTMENT TAB -->
        <section id="appointmentTab" class="tab-panel">
          <h2 class="section-title">Appointment mode</h2>

          <div class="card">
            <h3 class="card-title">Basic info</h3>
            <div class="grid-two">
              <div>
                <label for="apptCaseLabel" class="field-label">Case label / patient name (optional)</label>
                <input id="apptCaseLabel" class="input" placeholder="Eg. Milo ‚Äì itchy ears" />
              </div>
              <div>
                <label for="apptVisitType" class="field-label">Visit type</label>
                <select id="apptVisitType" class="select">
                  <option value="sick">Sick visit</option>
                  <option value="wellness">Wellness / vaccine</option>
                  <option value="recheck">Recheck</option>
                  <option value="tech">Tech appointment</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>

            <div class="grid-two" style="margin-top: 8px;">
              <div>
                <label for="apptWeight" class="field-label">Weight (kg, optional)</label>
                <input id="apptWeight" type="number" step="0.01" class="input" placeholder="Eg. 12.3" />
              </div>
              <div>
                <label class="field-label">TPR (optional)</label>
                <input id="apptTPR" class="input" placeholder="Eg. T 38.5, P 100, R 24" />
              </div>
            </div>

            <div style="margin-top: 8px;">
              <label class="field-label">Attachments (optional)</label>
              <div class="attachment-row">
                <label for="apptPhotoInput" class="btn-secondary">üì∑ Take photo</label>
                <input
                  id="apptPhotoInput"
                  type="file"
                  accept="image/*"
                  capture="environment"
                  class="hidden-input"
                />
                <span id="apptPhotoStatus" class="attachment-status">No photo selected</span>
              </div>
              <p class="muted" style="margin-top:4px;">
                For now, attached images are just for your notes; SOAPs use your typed inputs.
              </p>
            </div>
          </div>

          <div class="card">
            <h3 class="card-title">SOAP inputs</h3>
            <label for="apptReason" class="field-label">Reason for visit / presenting complaint</label>
            <textarea id="apptReason" class="textarea" rows="2"></textarea>

            <label for="apptHistory" class="field-label" style="margin-top:6px;">History (owner‚Äôs description, duration, meds)</label>
            <textarea id="apptHistory" class="textarea" rows="3"></textarea>

            <label for="apptPE" class="field-label" style="margin-top:6px;">Physical exam notes (data only)</label>
            <textarea id="apptPE" class="textarea" rows="3" placeholder="Eg. BAR, MM pink, CRT &lt;2s, HR 120, no murmur, lungs clear, etc."></textarea>

            <label for="apptDiagnostics" class="field-label" style="margin-top:6px;">Diagnostics performed / results (data only)</label>
            <textarea id="apptDiagnostics" class="textarea" rows="3" placeholder="Eg. SNAP 4Dx negative, ear cytology 2+ cocci, 1+ yeast."></textarea>

            <label for="apptAssessment" class="field-label" style="margin-top:6px;">Assessment notes (optional)</label>
            <textarea id="apptAssessment" class="textarea" rows="2" placeholder="Eg. Otitis externa (R), likely allergic."></textarea>

            <label for="apptPlan" class="field-label" style="margin-top:6px;">Plan notes (drugs / treatments you know you want)</label>
            <textarea id="apptPlan" class="textarea" rows="3"></textarea>

            <label for="apptMeds" class="field-label" style="margin-top:6px;">Medications dispensed (optional list)</label>
            <textarea id="apptMeds" class="textarea" rows="2" placeholder="Eg. Apoquel 5.4mg PO SID x14d; Mometamax 4 gtt BID x10d."></textarea>
          </div>

          <div class="card">
            <h3 class="card-title">Generate Appointment SOAP</h3>
            <div class="btn-row">
              <button id="runApptSoapBtn" class="btn-primary">Generate SOAP (Appointment)</button>
            </div>
            <div id="apptError" class="error-text hidden"></div>
          </div>
        </section>

        <!-- SURGERY TAB -->
        <section id="surgeryTab" class="tab-panel hidden">
          <h2 class="section-title">Surgery mode</h2>

          <div class="card">
            <h3 class="card-title">Basic info</h3>
            <div class="grid-two">
              <div>
                <label for="surgCaseLabel" class="field-label">Case label / patient name (optional)</label>
                <input id="surgCaseLabel" class="input" placeholder="Eg. Bella ‚Äì spay" />
              </div>
              <div>
                <label for="surgSpecies" class="field-label">Species</label>
                <select id="surgSpecies" class="select">
                  <option value="dog">Dog</option>
                  <option value="cat">Cat</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>

            <div class="grid-two" style="margin-top:8px;">
              <div>
                <label for="surgWeight" class="field-label">Weight (kg)</label>
                <input id="surgWeight" type="number" step="0.01" class="input" />
              </div>
              <div>
                <label class="field-label">TPR (optional)</label>
                <input id="surgTPR" class="input" placeholder="Eg. T 38.4, P 90, R 20" />
              </div>
            </div>

            <div style="margin-top:8px;">
              <label class="field-label">Attachments (optional)</label>
              <div class="attachment-row">
                <label for="surgPhotoInput" class="btn-secondary">üì∑ Take photo</label>
                <input
                  id="surgPhotoInput"
                  type="file"
                  accept="image/*"
                  capture="environment"
                  class="hidden-input"
                />
                <span id="surgPhotoStatus" class="attachment-status">No photo selected</span>
              </div>
            </div>
          </div>

          <div class="card">
            <h3 class="card-title">Surgery details</h3>

            <label for="surgeryType" class="field-label">Surgery template</label>
            <select id="surgeryType" class="select">
              <option value="canine_spay_standard">Canine spay ‚Äì standard</option>
              <option value="canine_spay_rescue">Canine spay ‚Äì rescue</option>
              <option value="canine_neuter_standard">Canine neuter ‚Äì standard</option>
              <option value="canine_neuter_rescue">Canine neuter ‚Äì rescue</option>
              <option value="dental_cohat_rads">Dental ‚Äì COHAT with radiographs</option>
              <option value="dental_cohat_no_rads">Dental ‚Äì COHAT without radiographs</option>
              <option value="mass_removal">Mass removal</option>
              <option value="cystotomy">Cystotomy</option>
              <option value="pyometra_spay">Pyometra spay</option>
              <option value="exploratory_laparotomy">Exploratory laparotomy</option>
              <option value="enterotomy">Enterotomy</option>
              <option value="gastrotomy">Gastrotomy</option>
              <option value="gastropexy">Gastropexy</option>
              <option value="feline_urinary_unblock">Feline urethral unblock</option>
              <option value="custom">Custom / other</option>
            </select>

            <label class="field-label" style="margin-top:6px;">ASA status</label>
            <div id="asaChipGroup" class="chip-group">
              <button type="button" data-value="1" class="chip chip-selected">ASA I</button>
              <button type="button" data-value="2" class="chip">ASA II</button>
              <button type="button" data-value="3" class="chip">ASA III</button>
              <button type="button" data-value="4" class="chip">ASA IV</button>
              <button type="button" data-value="5" class="chip">ASA V</button>
            </div>
            <input type="hidden" id="asaStatus" value="1" />

            <label class="field-label" style="margin-top:6px;">IV catheter</label>
            <div class="grid-two">
              <div>
                <label class="field-label">Gauge</label>
                <div id="ivGaugeGroup" class="chip-group">
                  <button type="button" class="chip chip-selected" data-value="22g">22G</button>
                  <button type="button" class="chip" data-value="20g">20G</button>
                  <button type="button" class="chip" data-value="18g">18G</button>
                  <button type="button" class="chip" data-value="24g">24G</button>
                </div>
                <input type="hidden" id="ivGauge" value="22g" />
              </div>
              <div>
                <label class="field-label">Site / side</label>
                <div id="ivSiteGroup" class="chip-group">
                  <button type="button" class="chip chip-selected" data-value="cephalic_left">L cephalic</button>
                  <button type="button" class="chip" data-value="cephalic_right">R cephalic</button>
                  <button type="button" class="chip" data-value="saphenous_left">L saphenous</button>
                  <button type="button" class="chip" data-value="saphenous_right">R saphenous</button>
                </div>
                <input type="hidden" id="ivSite" value="cephalic_left" />
              </div>
            </div>

            <label for="ettSize" class="field-label" style="margin-top:6px;">ET tube size (mm)</label>
            <input id="ettSize" class="input" placeholder="Eg. 8.0 cuffed" />

            <label class="field-label" style="margin-top:8px;">IV fluids</label>
            <div class="chip-group" id="fluidsModeGroup">
              <button type="button" class="chip chip-selected" data-mode="dog_default">Dog default (5 mL/kg/hr)</button>
              <button type="button" class="chip" data-mode="cat_default">Cat default (3 mL/kg/hr)</button>
              <button type="button" class="chip" data-mode="custom">Custom rate</button>
              <button type="button" class="chip" data-mode="declined">Declined</button>
            </div>

            <div class="grid-two" style="margin-top:8px;">
              <div>
                <label for="fluidRate" class="field-label">Custom rate (mL/kg/hr)</label>
                <input id="fluidRate" type="number" step="0.1" class="input" placeholder="Eg. 5" disabled />
              </div>
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input id="bolusGiven" type="checkbox" />
                  <span>Bolus given (will describe in SOAP)</span>
                </label>
              </div>
            </div>
          </div>

          <div class="card">
            <h3 class="card-title">Anesthesia & surgery notes</h3>

            <label for="premeds" class="field-label">Premedications (drug, dose, route)</label>
            <textarea id="premeds" class="textarea" rows="2"
              placeholder="Eg. Dexmedetomidine, Hydromorphone, Midazolam 5 mg/ml, etc."></textarea>

            <label for="induction" class="field-label" style="margin-top:6px;">Induction / maintenance</label>
            <textarea id="induction" class="textarea" rows="2"
              placeholder="Eg. Propofol to effect, Isoflurane/O2, Locoregional blocks."></textarea>

            <label for="intraOpMeds" class="field-label" style="margin-top:6px;">Intra-op medications</label>
            <textarea id="intraOpMeds" class="textarea" rows="2"
              placeholder="Eg. Fentanyl CRI, lidocaine block (list sites), meloxicam, etc."></textarea>

            <label for="procedureNotes" class="field-label" style="margin-top:6px;">Surgical procedure notes</label>
            <textarea id="procedureNotes" class="textarea" rows="3"
              placeholder="Key details: approach, findings, closures, drains, samples sent."></textarea>

            <div class="grid-two" style="margin-top:6px;">
              <div>
                <label for="anesthesiaDuration" class="field-label">Anesthesia duration (optional)</label>
                <input id="anesthesiaDuration" class="input" placeholder="Eg. 75 min" />
              </div>
              <div>
                <label for="surgeryDuration" class="field-label">Surgery duration (optional)</label>
                <input id="surgeryDuration" class="input" placeholder="Eg. 45 min" />
              </div>
            </div>

            <label class="field-label" style="margin-top:6px;">Recovery quality</label>
            <div id="recoveryGroup" class="chip-group">
              <button type="button" class="chip chip-selected" data-value="smooth">Smooth</button>
              <button type="button" class="chip" data-value="mild_dysphoria">Mild dysphoria</button>
              <button type="button" class="chip" data-value="moderate_dysphoria">Moderate dysphoria</button>
              <button type="button" class="chip" data-value="rough">Rough</button>
            </div>
            <input type="hidden" id="recoveryQuality" value="smooth" />

            <label for="recoveryNotes" class="field-label">Recovery notes</label>
            <textarea id="recoveryNotes" class="textarea" rows="2"></textarea>

            <label for="postOpMeds" class="field-label" style="margin-top:6px;">Post-op medications dispensed</label>
            <textarea id="postOpMeds" class="textarea" rows="2"
              placeholder="Eg. Robenacoxib, Gabapentin, Trazodone, etc."></textarea>
          </div>

          <div class="card">
            <h3 class="card-title">Generate Surgery SOAP</h3>
            <div class="btn-row">
              <button id="runSurgSoapBtn" class="btn-primary">Generate SOAP (Surgery)</button>
            </div>
            <div id="surgError" class="error-text hidden"></div>
          </div>
        </section>

        <!-- TOOLBOX TAB -->
        <section id="toolboxTab" class="tab-panel hidden">
          <h2 class="section-title">Toolbox Lite</h2>

          <div class="card">
            <h3 class="card-title">Attachments (optional)</h3>
            <p class="card-subtitle">
              Attach lab PDFs, screenshots, or photos of printouts. For now, helpers use pasted text; photos are future Vision.
            </p>

            <div class="attachment-row">
              <label for="toolboxPhotoInput" class="btn-secondary">üì∑ Take photo</label>
              <input
                id="toolboxPhotoInput"
                type="file"
                accept="image/*"
                capture="environment"
                class="hidden-input"
              />
              <span id="toolboxPhotoStatus" class="attachment-status">No photo selected</span>
            </div>
          </div>

          <!-- BLOODWORK HELPER -->
          <div class="card">
            <h3 class="card-title">Bloodwork Helper Lite</h3>
            <p class="card-subtitle">Paste CBC/chem/UA text (optional if photos attached).</p>

            <textarea
              id="bloodworkText"
              class="textarea"
              rows="5"
              placeholder="Copy/paste the lab report text or values here."
            ></textarea>

            <div class="grid-two" style="margin-top:6px;">
              <div>
                <label for="bloodworkDetail" class="field-label">Detail level</label>
                <select id="bloodworkDetail" class="select">
                  <option value="short">Short</option>
                  <option value="standard">Standard</option>
                  <option value="expanded">Expanded</option>
                </select>
              </div>
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input id="bloodworkIncludeDiff" type="checkbox" checked />
                  <span>Include differential list</span>
                </label>
                <label class="checkbox-label">
                  <input id="bloodworkClientSummary" type="checkbox" />
                  <span>Add client-friendly summary</span>
                </label>
              </div>
            </div>

            <div class="btn-row" style="margin-top:8px;">
              <button id="runBloodworkHelperBtn" class="btn-primary">Run Bloodwork Helper</button>
            </div>

            <label for="bloodworkOutput" class="field-label" style="margin-top:6px;">Bloodwork Helper output</label>
            <textarea id="bloodworkOutput" class="textarea" rows="8" readonly></textarea>
          </div>

          <!-- EMAIL / CLIENT COMMUNICATION HELPER -->
          <div class="card">
            <h3 class="card-title">Email / Client Communication Helper</h3>
            <p class="card-subtitle">Draft owner emails or written call summaries.</p>

            <div class="grid-two">
              <div>
                <label for="emailScenario" class="field-label">Template type</label>
                <select id="emailScenario" class="select">
                  <option value="bloodwork_followup">Bloodwork follow-up</option>
                  <option value="dental_estimate">Dental estimate + pre-op sedation</option>
                  <option value="post_op_checkin">Post-op check-in</option>
                  <option value="general_update">General medical update</option>
                  <option value="medication_change">Medication change / refill</option>
                  <option value="custom">Custom / other</option>
                </select>
              </div>
              <div>
                <label for="emailTone" class="field-label">Tone</label>
                <select id="emailTone" class="select">
                  <option value="standard">Standard professional</option>
                  <option value="warm">Warm & reassuring</option>
                  <option value="concise">Very concise</option>
                </select>
              </div>
            </div>

            <label for="emailContext" class="field-label" style="margin-top:6px;">
              What do you want to say? (brief notes)
            </label>
            <textarea
              id="emailContext"
              class="textarea"
              rows="4"
              placeholder="Eg. CBC normal, mild ALT elevation, dog bright and eating, recommend recheck in 1 month."
            ></textarea>

            <div class="btn-row" style="margin-top:8px;">
              <button id="runEmailHelperBtn" class="btn-primary">Generate email text</button>
            </div>

            <label for="emailOutput" class="field-label" style="margin-top:6px;">Email / message output</label>
            <textarea id="emailOutput" class="textarea" rows="8" readonly></textarea>
          </div>

          <!-- QUICK CALL NOTE HELPER -->
          <div class="card">
            <h3 class="card-title">Quick Call Note Helper</h3>
            <p class="card-subtitle">
              One-paragraph ‚Äúspoke with owner‚Äù notes that paste nicely into Avimark.
            </p>

            <label for="callContext" class="field-label">Call details</label>
            <textarea
              id="callContext"
              class="textarea"
              rows="4"
              placeholder="Eg. Discussed bloodwork results, dog is eating/drinking, mild cough, owner okay to monitor..."
            ></textarea>

            <div class="grid-two" style="margin-top:6px;">
              <div>
                <label for="callStyle" class="field-label">Style</label>
                <select id="callStyle" class="select">
                  <option value="standard">Standard SOAP-style</option>
                  <option value="very_brief">Very brief</option>
                  <option value="detailed">More detailed</option>
                </select>
              </div>
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input id="callFollowupFlag" type="checkbox" />
                  <span>Include reminder for follow-up</span>
                </label>
              </div>
            </div>

            <div class="btn-row" style="margin-top:8px;">
              <button id="runCallHelperBtn" class="btn-primary">Generate call note</button>
            </div>

            <label for="callOutput" class="field-label" style="margin-top:6px;">Call note output</label>
            <textarea id="callOutput" class="textarea" rows="6" readonly></textarea>
          </div>
        </section>
      </div>

      <!-- RIGHT: OUTPUT AREA -->
      <div>
        <div class="card">
          <div class="output-header">
            <h3>SOAP output</h3>
            <div class="copy-group">
              <button id="copyFullBtn" class="btn-secondary">Copy full SOAP</button>
            </div>
          </div>

          <div class="output-box">
            <div class="output-header">
              <h3>Subjective</h3>
              <button id="copySubjBtn" class="btn-ghost">Copy</button>
            </div>
            <textarea id="subjectiveOutput" class="textarea" rows="3" readonly></textarea>
          </div>

          <div class="output-box">
            <div class="output-header">
              <h3>Objective</h3>
              <button id="copyObjBtn" class="btn-ghost">Copy</button>
            </div>
            <textarea id="objectiveOutput" class="textarea" rows="4" readonly></textarea>
          </div>

          <div class="output-box">
            <div class="output-header">
              <h3>Assessment</h3>
              <button id="copyAssessBtn" class="btn-ghost">Copy</button>
            </div>
            <textarea id="assessmentOutput" class="textarea" rows="3" readonly></textarea>
          </div>

          <div class="output-box">
            <div class="output-header">
              <h3>Plan</h3>
              <button id="copyPlanBtn" class="btn-ghost">Copy</button>
            </div>
            <textarea id="planOutput" class="textarea" rows="4" readonly></textarea>
          </div>

          <div class="output-box">
            <div class="output-header">
              <h3>Medications dispensed</h3>
              <button id="copyMedsBtn" class="btn-ghost">Copy</button>
            </div>
            <textarea id="medsOutput" class="textarea" rows="2" readonly></textarea>
          </div>

          <div class="output-box">
            <div class="output-header">
              <h3>Aftercare</h3>
              <button id="copyAftercareBtn" class="btn-ghost">Copy</button>
            </div>
            <textarea id="aftercareOutput" class="textarea" rows="3" readonly></textarea>
          </div>

          <div class="btn-row">
            <button id="copyPlanMedsAftercareBtn" class="btn-secondary">
              Copy Plan + Meds + Aftercare
            </button>
          </div>

          <div id="feedbackBar" class="feedback-bar hidden"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- PHOTO / PRIVACY OVERLAY -->
  <div id="photoOverlay" class="overlay hidden">
    <div class="overlay-inner">
      <div class="overlay-header">
        <h3>Photo capture</h3>
        <button type="button" id="photoOverlayClose" class="overlay-close">‚úï</button>
      </div>

      <div id="photoPreviewContainer" class="photo-preview">
        <p class="muted">No photo loaded yet.</p>
      </div>

      <div class="overlay-privacy">
        <button type="button" id="privacyToggle" class="privacy-chip active">
          ‚úÖ Tap for Privacy ‚Äì Clinic-Safe
        </button>
        <p class="privacy-text">
          v1.6: privacy is manual only. For anything with owner/pet names, microchip, or IDs,
          blur/crop before sharing outside the clinic.
        </p>
      </div>

      <label for="photoNote" class="field-label">Optional note about this image</label>
      <textarea
        id="photoNote"
        class="textarea"
        rows="3"
        placeholder="Eg. Pre-op bloodwork screenshot, values checked."
      ></textarea>

      <div class="overlay-actions">
        <button type="button" id="photoAttachBtn" class="btn-primary">Attach</button>
        <button type="button" id="photoDiscardBtn" class="btn-secondary">Discard</button>
      </div>
    </div>
  </div>

  <script>
    // ================== CONFIG ==================
    // If your backend uses different URLs, change these three:
    const SOAP_API_URL = "/api/generate-soap";
    const TOOLBOX_BLOODWORK_URL = "/api/toolbox/bloodwork-lite";
    const TOOLBOX_EMAIL_URL = "/api/toolbox/email-helper-lite"; // reused for email + call note

    // ================== UTILS ==================
    function setText(id, value) {
      const el = document.getElementById(id);
      if (el) el.value = value ?? "";
    }

    function getText(id) {
      const el = document.getElementById(id);
      return el ? el.value.trim() : "";
    }

    function showError(id, msg) {
      const el = document.getElementById(id);
      if (!el) return;
      if (msg) {
        el.textContent = msg;
        el.classList.remove("hidden");
      } else {
        el.textContent = "";
        el.classList.add("hidden");
      }
    }

    function copyToClipboard(text) {
      if (!text) return;
      navigator.clipboard.writeText(text).catch((err) =>
        console.error("Copy failed", err)
      );
    }

    // ================== TABS ==================
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabPanels = document.querySelectorAll(".tab-panel");

    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const target = btn.dataset.tab;
        tabButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        tabPanels.forEach((panel) => {
          if (panel.id === target) panel.classList.remove("hidden");
          else panel.classList.add("hidden");
        });
      });
    });

    // ================== CHIP GROUP HELPERS ==================
    function setupSingleSelectChipGroup(groupId, hiddenInputId) {
      const group = document.getElementById(groupId);
      const hidden = hiddenInputId ? document.getElementById(hiddenInputId) : null;
      if (!group) return;

      group.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if (!btn || !btn.dataset.value) return;
        group.querySelectorAll(".chip").forEach((c) => c.classList.remove("chip-selected"));
        btn.classList.add("chip-selected");
        if (hidden) hidden.value = btn.dataset.value;
      });
    }

    setupSingleSelectChipGroup("asaChipGroup", "asaStatus");
    setupSingleSelectChipGroup("ivGaugeGroup", "ivGauge");
    setupSingleSelectChipGroup("ivSiteGroup", "ivSite");
    setupSingleSelectChipGroup("recoveryGroup", "recoveryQuality");

    // Fluids chips
    const fluidsGroup = document.getElementById("fluidsModeGroup");
    const fluidRateInput = document.getElementById("fluidRate");
    if (fluidsGroup && fluidRateInput) {
      fluidsGroup.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-mode]");
        if (!btn) return;
        fluidsGroup.querySelectorAll(".chip").forEach((c) => c.classList.remove("chip-selected"));
        btn.classList.add("chip-selected");
        const mode = btn.dataset.mode;
        if (mode === "custom") {
          fluidRateInput.disabled = false;
          fluidRateInput.value = "";
          fluidRateInput.focus();
        } else {
          fluidRateInput.disabled = true;
          if (mode === "dog_default") fluidRateInput.value = "5";
          if (mode === "cat_default") fluidRateInput.value = "3";
          if (mode === "declined") fluidRateInput.value = "";
        }
        fluidRateInput.dataset.mode = mode;
      });
      // default
      fluidRateInput.dataset.mode = "dog_default";
      fluidRateInput.value = "5";
    }

    // ================== PHOTO OVERLAY ==================
    let lastSelectedFile = null;
    let currentPhotoContext = null;

    const overlay = document.getElementById("photoOverlay");
    const previewContainer = document.getElementById("photoPreviewContainer");
    const privacyChip = document.getElementById("privacyToggle");
    const photoNote = document.getElementById("photoNote");

    function openPhotoOverlay(file, context) {
      currentPhotoContext = context;
      lastSelectedFile = file;
      photoNote.value = "";
      privacyChip.classList.add("active");
      privacyChip.textContent = "‚úÖ Tap for Privacy ‚Äì Clinic-Safe";

      previewContainer.innerHTML = "";
      if (file) {
        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        previewContainer.appendChild(img);
      } else {
        previewContainer.innerHTML =
          "<p class='muted'>No photo loaded yet.</p>";
      }
      overlay.classList.remove("hidden");
    }

    function closePhotoOverlay() {
      overlay.classList.add("hidden");
    }

    document
      .getElementById("photoOverlayClose")
      .addEventListener("click", closePhotoOverlay);

    document.getElementById("photoDiscardBtn").addEventListener("click", () => {
      // reset relevant input & status
      if (currentPhotoContext === "appt") {
        document.getElementById("apptPhotoInput").value = "";
        document.getElementById("apptPhotoStatus").textContent = "No photo selected";
      } else if (currentPhotoContext === "surg") {
        document.getElementById("surgPhotoInput").value = "";
        document.getElementById("surgPhotoStatus").textContent = "No photo selected";
      } else if (currentPhotoContext === "toolbox") {
        document.getElementById("toolboxPhotoInput").value = "";
        document.getElementById("toolboxPhotoStatus").textContent = "No photo selected";
      }
      lastSelectedFile = null;
      currentPhotoContext = null;
      closePhotoOverlay();
    });

    document.getElementById("photoAttachBtn").addEventListener("click", () => {
      const note = photoNote.value.trim();
      let label = "Photo attached (Clinic-Safe)";
      if (note) label += " ‚Äì " + note;
      if (currentPhotoContext === "appt") {
        document.getElementById("apptPhotoStatus").textContent = label;
      } else if (currentPhotoContext === "surg") {
        document.getElementById("surgPhotoStatus").textContent = label;
      } else if (currentPhotoContext === "toolbox") {
        document.getElementById("toolboxPhotoStatus").textContent = label;
      }
      closePhotoOverlay();
    });

    privacyChip.addEventListener("click", () => {
      const active = privacyChip.classList.toggle("active");
      privacyChip.textContent = active
        ? "‚úÖ Tap for Privacy ‚Äì Clinic-Safe"
        : "‚ö†Ô∏è Privacy off (not for sharing)";
    });

    function hookPhotoInput(inputId, context) {
      const input = document.getElementById(inputId);
      if (!input) return;
      input.addEventListener("change", () => {
        if (input.files && input.files.length > 0) {
          openPhotoOverlay(input.files[0], context);
        }
      });
    }

    hookPhotoInput("apptPhotoInput", "appt");
    hookPhotoInput("surgPhotoInput", "surg");
    hookPhotoInput("toolboxPhotoInput", "toolbox");

    // ================== SOAP GENERATION ==================
    const feedbackBar = document.getElementById("feedbackBar");

    function setSoapOutputs(data) {
      setText("subjectiveOutput", data.subjective || "");
      setText("objectiveOutput", data.objective || "");
      setText("assessmentOutput", data.assessment || "");
      setText("planOutput", data.plan || "");
      setText("medsOutput", data.medsDispensed || data.meds || "");
      setText("aftercareOutput", data.aftercare || "");
      if (data.feedback) {
        feedbackBar.textContent = data.feedback;
        feedbackBar.classList.remove("hidden");
      } else {
        feedbackBar.classList.add("hidden");
      }
    }

    async function callSoapApi(payload, errorId) {
      showError(errorId, "");
      feedbackBar.classList.add("hidden");
      try {
        const res = await fetch(SOAP_API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error("Network error");
        const data = await res.json();
        // support both structured and simple text response
        if (data.subjective || data.plan || data.aftercare) {
          setSoapOutputs(data);
        } else if (data.soap) {
          setText("subjectiveOutput", data.soap);
          setText("objectiveOutput", "");
          setText("assessmentOutput", "");
          setText("planOutput", "");
          setText("medsOutput", "");
          setText("aftercareOutput", "");
          feedbackBar.classList.add("hidden");
        } else {
          setSoapOutputs({});
        }
      } catch (err) {
        console.error(err);
        showError(errorId, "Sorry, something went wrong generating the SOAP.");
      }
    }

    document.getElementById("runApptSoapBtn").addEventListener("click", () => {
      const payload = {
        mode: "appointment",
        caseLabel: getText("apptCaseLabel"),
        visitType: document.getElementById("apptVisitType").value,
        weightKg: getText("apptWeight"),
        tpr: getText("apptTPR"),
        reason: getText("apptReason"),
        history: getText("apptHistory"),
        pe: getText("apptPE"),
        diagnostics: getText("apptDiagnostics"),
        assessmentNotes: getText("apptAssessment"),
        planNotes: getText("apptPlan"),
        medsNotes: getText("apptMeds"),
      };
      callSoapApi(payload, "apptError");
    });

    document.getElementById("runSurgSoapBtn").addEventListener("click", () => {
      const payload = {
        mode: "surgery",
        caseLabel: getText("surgCaseLabel"),
        species: document.getElementById("surgSpecies").value,
        weightKg: getText("surgWeight"),
        tpr: getText("surgTPR"),
        surgeryType: document.getElementById("surgeryType").value,
        asaStatus: document.getElementById("asaStatus").value,
        ivGauge: document.getElementById("ivGauge").value,
        ivSite: document.getElementById("ivSite").value,
        ettSize: getText("ettSize"),
        fluidsMode: fluidRateInput.dataset.mode,
        fluidRate: getText("fluidRate"),
        bolusGiven: document.getElementById("bolusGiven").checked,
        premeds: getText("premeds"),
        induction: getText("induction"),
        intraOpMeds: getText("intraOpMeds"),
        procedureNotes: getText("procedureNotes"),
        anesthesiaDuration: getText("anesthesiaDuration"),
        surgeryDuration: getText("surgeryDuration"),
        recoveryQuality: document.getElementById("recoveryQuality").value,
        recoveryNotes: getText("recoveryNotes"),
        postOpMeds: getText("postOpMeds"),
      };
      callSoapApi(payload, "surgError");
    });

    // ================== TOOLBOX: BLOODWORK ==================
    document
      .getElementById("runBloodworkHelperBtn")
      .addEventListener("click", async () => {
        const text = getText("bloodworkText");
        const detail = document.getElementById("bloodworkDetail").value;
        const includeDiff = document.getElementById("bloodworkIncludeDiff").checked;
        const clientSummary =
          document.getElementById("bloodworkClientSummary").checked;
        const output = document.getElementById("bloodworkOutput");
        output.value = "Thinking about the lab work‚Ä¶";
        try {
          const res = await fetch(TOOLBOX_BLOODWORK_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              type: "bloodwork_lite",
              text,
              detail,
              includeDifferentials: includeDiff,
              clientSummary,
            }),
          });
          if (!res.ok) throw new Error("Network");
          const data = await res.json();
          output.value = data.result || data.text || "(No response text)";
        } catch (err) {
          console.error(err);
          output.value = "Sorry, something went wrong running the Bloodwork Helper.";
        }
      });

    // ================== TOOLBOX: EMAIL HELPER ==================
    async function callEmailHelper(payload, outputElementId) {
      const output = document.getElementById(outputElementId);
      output.value = "Drafting text‚Ä¶";
      try {
        const res = await fetch(TOOLBOX_EMAIL_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error("Network");
        const data = await res.json();
        output.value = data.result || data.text || "(No response text)";
      } catch (err) {
        console.error(err);
        output.value = "Sorry, something went wrong generating this text.";
      }
    }

    document
      .getElementById("runEmailHelperBtn")
      .addEventListener("click", () => {
        const scenario = document.getElementById("emailScenario").value;
        const tone = document.getElementById("emailTone").value;
        const context = getText("emailContext");
        callEmailHelper(
          {
            tool: "email_helper_lite",
            scenario,
            tone,
            context,
          },
          "emailOutput"
        );
      });

    // Quick Call Note uses same endpoint, different tool flag
    document.getElementById("runCallHelperBtn").addEventListener("click", () => {
      const context = getText("callContext");
      const style = document.getElementById("callStyle").value;
      const includeFollowup =
        document.getElementById("callFollowupFlag").checked;
      callEmailHelper(
        {
          tool: "call_note_helper",
          style,
          includeFollowup,
          context,
        },
        "callOutput"
      );
    });

    // ================== COPY BUTTONS ==================
    function getFullSoapText() {
      return (
        "Subjective:\n" +
        getText("subjectiveOutput") +
        "\n\nObjective:\n" +
        getText("objectiveOutput") +
        "\n\nAssessment:\n" +
        getText("assessmentOutput") +
        "\n\nPlan:\n" +
        getText("planOutput") +
        "\n\nMedications Dispensed:\n" +
        getText("medsOutput") +
        "\n\nAftercare:\n" +
        getText("aftercareOutput")
      );
    }

    document.getElementById("copyFullBtn").addEventListener("click", () => {
      copyToClipboard(getFullSoapText());
    });
    document.getElementById("copySubjBtn").addEventListener("click", () => {
      copyToClipboard(getText("subjectiveOutput"));
    });
    document.getElementById("copyObjBtn").addEventListener("click", () => {
      copyToClipboard(getText("objectiveOutput"));
    });
    document.getElementById("copyAssessBtn").addEventListener("click", () => {
      copyToClipboard(getText("assessmentOutput"));
    });
    document.getElementById("copyPlanBtn").addEventListener("click", () => {
      copyToClipboard(getText("planOutput"));
    });
    document.getElementById("copyMedsBtn").addEventListener("click", () => {
      copyToClipboard(getText("medsOutput"));
    });
    document.getElementById("copyAftercareBtn").addEventListener("click", () => {
      copyToClipboard(getText("aftercareOutput"));
    });

    document
      .getElementById("copyPlanMedsAftercareBtn")
      .addEventListener("click", () => {
        const text =
          "Plan:\n" +
          getText("planOutput") +
          "\n\nMedications Dispensed:\n" +
          getText("medsOutput") +
          "\n\nAftercare:\n" +
          getText("aftercareOutput");
        copyToClipboard(text);
      });
  </script>
</body>
</html>
