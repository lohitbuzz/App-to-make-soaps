<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lohit SOAP App v1.6 – Stable</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --primary: #0f766e;
      --primary-dark: #115e59;
      --text: #111827;
      --muted: #6b7280;
      --danger: #dc2626;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.08);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .app-shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    header { margin-bottom: 12px; }

    .app-title {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      display: flex;
      align-items: baseline;
      gap: 8px;
    }

    .app-title span {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--muted);
    }

    .app-subtitle {
      margin-top: 4px;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .tab-bar {
      display: flex;
      gap: 8px;
      margin: 12px 0;
      overflow-x: auto;
    }

    .tab-btn {
      flex: 1;
      min-width: 0;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      font-size: 0.9rem;
      font-weight: 500;
      text-align: center;
      cursor: pointer;
      white-space: nowrap;
    }

    .tab-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .main-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 16px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .main-grid { grid-template-columns: minmax(0, 1fr); }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding: 14px 16px 16px;
      margin-bottom: 10px;
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .card-subtitle {
      margin: 0 0 8px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .field-label {
      display: block;
      font-size: 0.8rem;
      font-weight: 500;
      margin-bottom: 4px;
      color: #374151;
    }

    .input,
    .select,
    .textarea {
      width: 100%;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: 8px 10px;
      font-size: 0.9rem;
      font-family: inherit;
      background: #f9fafb;
      outline: none;
      transition: border-color 0.12s ease, box-shadow 0.12s ease;
    }

    .input:focus,
    .select:focus,
    .textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(15, 118, 110, 0.2);
      background: #ffffff;
    }

    .textarea { resize: vertical; }

    .btn-primary,
    .btn-secondary,
    .btn-ghost {
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.9rem;
      font-weight: 500;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover { background: var(--primary-dark); }

    .btn-secondary {
      background: #eef2ff;
      color: #1e293b;
      border: 1px solid #e0e7ff;
    }

    .btn-ghost {
      background: transparent;
      border: 1px dashed var(--border);
      color: var(--muted);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .muted {
      color: var(--muted);
      font-size: 0.8rem;
    }

    .grid-two {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    @media (max-width: 700px) {
      .grid-two { grid-template-columns: minmax(0, 1fr); }
    }

    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 4px;
    }

    .chip {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .chip-selected {
      background: var(--primary);
      color: #ffffff;
      border-color: var(--primary);
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.85rem;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .checkbox-label input { margin: 0; }

    .output-box {
      margin-bottom: 10px;
    }

    .feedback-bar {
      font-size: 0.8rem;
      padding: 8px 10px;
      border-radius: var(--radius-md);
      background: #ecfeff;
      border: 1px solid #bae6fd;
      color: #0f172a;
      margin-top: 6px;
    }

    .hidden { display: none; }

    .error-text {
      color: var(--danger);
      font-size: 0.8rem;
      margin-top: 4px;
    }

    .attachment-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .attachment-status {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .hidden-input { display: none; }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="app-title">
        Lohit SOAP App <span>v1.6 – Assistant-backed</span>
      </div>
      <div class="app-subtitle">
        Appointment / Surgery SOAPs + Toolbox Lite. Uses your backend /api/run and your Assistant rules.
      </div>
    </header>

    <div class="tab-bar">
      <button class="tab-btn active" data-tab="appointmentTab">Appointment</button>
      <button class="tab-btn" data-tab="surgeryTab">Surgery</button>
      <button class="tab-btn" data-tab="toolboxTab">Toolbox</button>
      <button class="tab-btn" data-tab="consultTab">Consult</button>
    </div>

    <div class="main-grid">
      <!-- LEFT: INPUTS -->
      <div>
        <!-- Appointment -->
        <section id="appointmentTab" class="tab-panel">
          <h2 class="section-title">Appointment mode</h2>

          <div class="card">
            <h3 class="card-title">Basic info</h3>
            <div class="grid-two">
              <div>
                <label for="apptCaseLabel" class="field-label">Case label / patient name (optional)</label>
                <input id="apptCaseLabel" class="input" placeholder="Eg. Milo – itchy ears" />
              </div>
              <div>
                <label for="apptVisitType" class="field-label">Visit type</label>
                <select id="apptVisitType" class="select">
                  <option value="sick">Sick visit</option>
                  <option value="wellness">Wellness / vaccine</option>
                  <option value="recheck">Recheck</option>
                  <option value="tech">Tech appointment</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>

            <div class="grid-two" style="margin-top:8px;">
              <div>
                <label for="apptWeight" class="field-label">Weight (kg, optional)</label>
                <input id="apptWeight" type="number" step="0.01" class="input" />
              </div>
              <div>
                <label for="apptAgeYears" class="field-label">Age (years, optional)</label>
                <input id="apptAgeYears" type="number" step="0.1" class="input" />
              </div>
            </div>

            <div style="margin-top:8px;">
              <label for="apptTPR" class="field-label">TPR (optional)</label>
              <input id="apptTPR" class="input" placeholder="Eg. T 38.5, P 100, R 24" />
            </div>
          </div>

          <div class="card">
            <h3 class="card-title">SOAP inputs</h3>
            <label for="apptReason" class="field-label">Reason for visit / presenting complaint</label>
            <textarea id="apptReason" class="textarea" rows="2"></textarea>

            <label for="apptHistory" class="field-label" style="margin-top:6px;">
              History (owner description, duration, meds)
            </label>
            <textarea id="apptHistory" class="textarea" rows="3"></textarea>

            <label for="apptPE" class="field-label" style="margin-top:6px;">
              Physical exam notes (data only)
            </label>
            <textarea id="apptPE" class="textarea" rows="3"
              placeholder="Eg. BAR, MM pink, CRT &lt;2s, HR 120, no murmur, lungs clear, etc."></textarea>

            <label for="apptDiagnostics" class="field-label" style="margin-top:6px;">
              Diagnostics (data only)
            </label>
            <textarea id="apptDiagnostics" class="textarea" rows="3"
              placeholder="Eg. SNAP 4Dx negative, ear cytology 2+ cocci, 1+ yeast."></textarea>

            <label for="apptAssessment" class="field-label" style="margin-top:6px;">
              Assessment notes (optional)
            </label>
            <textarea id="apptAssessment" class="textarea" rows="2"
              placeholder="Eg. Otitis externa (R), likely allergic."></textarea>

            <label for="apptPlan" class="field-label" style="margin-top:6px;">
              Plan notes (treatments you know you want)
            </label>
            <textarea id="apptPlan" class="textarea" rows="3"></textarea>

            <label for="apptMeds" class="field-label" style="margin-top:6px;">
              Medications dispensed (optional list)
            </label>
            <textarea id="apptMeds" class="textarea" rows="2"
              placeholder="Eg. Apoquel 5.4mg PO SID x14d; Mometamax 4 gtt BID x10d."></textarea>

            <div class="checkbox-group" style="margin-top:8px;">
              <label class="checkbox-label">
                <input id="apptStrictMode" type="checkbox" />
                <span>Strict mode (no assumed normals)</span>
              </label>
            </div>
          </div>

          <div class="card">
            <h3 class="card-title">Generate Appointment SOAP</h3>
            <div class="btn-row">
              <button id="runApptSoapBtn" class="btn-primary">Generate SOAP (Appointment)</button>
            </div>
            <div id="apptError" class="error-text hidden"></div>
          </div>
        </section>

        <!-- Surgery -->
        <section id="surgeryTab" class="tab-panel hidden">
          <h2 class="section-title">Surgery mode</h2>

          <div class="card">
            <h3 class="card-title">Basic info</h3>
            <div class="grid-two">
              <div>
                <label for="surgCaseLabel" class="field-label">Case label / patient name (optional)</label>
                <input id="surgCaseLabel" class="input" placeholder="Eg. Bella – spay" />
              </div>
              <div>
                <label for="surgSpecies" class="field-label">Species</label>
                <select id="surgSpecies" class="select">
                  <option value="dog">Dog</option>
                  <option value="cat">Cat</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>

            <div class="grid-two" style="margin-top:8px;">
              <div>
                <label for="surgWeight" class="field-label">Weight (kg)</label>
                <input id="surgWeight" type="number" step="0.01" class="input" />
              </div>
              <div>
                <label for="surgAgeYears" class="field-label">Age (years, optional)</label>
                <input id="surgAgeYears" type="number" step="0.1" class="input" />
              </div>
            </div>

            <div style="margin-top:8px;">
              <label for="surgTPR" class="field-label">TPR (optional)</label>
              <input id="surgTPR" class="input" placeholder="Eg. T 38.4, P 90, R 20" />
            </div>

            <div class="checkbox-group" style="margin-top:8px;">
              <label class="checkbox-label">
                <input id="surgQuickMode" type="checkbox" />
                <span>Quick mode (tech-friendly, minimal required fields)</span>
              </label>
              <label class="checkbox-label">
                <input id="surgStrictMode" type="checkbox" />
                <span>Strict mode (no assumed normals)</span>
              </label>
            </div>
          </div>

          <div class="card">
            <h3 class="card-title">Surgery details</h3>

            <label for="surgeryType" class="field-label">Surgery template</label>
            <select id="surgeryType" class="select">
              <option value="canine_spay_standard">Canine spay – standard</option>
              <option value="canine_spay_rescue">Canine spay – rescue</option>
              <option value="canine_neuter_standard">Canine neuter – standard</option>
              <option value="canine_neuter_rescue">Canine neuter – rescue</option>
              <option value="dental_cohat_rads">Dental – COHAT with radiographs</option>
              <option value="dental_cohat_no_rads">Dental – COHAT without radiographs</option>
              <option value="mass_removal">Mass removal</option>
              <option value="cystotomy">Cystotomy</option>
              <option value="pyometra_spay">Pyometra spay</option>
              <option value="exploratory_laparotomy">Exploratory laparotomy</option>
              <option value="enterotomy">Enterotomy</option>
              <option value="gastrotomy">Gastrotomy</option>
              <option value="gastropexy">Gastropexy</option>
              <option value="feline_urinary_unblock">Feline urethral unblock</option>
              <option value="custom">Custom / other</option>
            </select>

            <label class="field-label" style="margin-top:6px;">ASA status</label>
            <div id="asaChipGroup" class="chip-group">
              <button type="button" class="chip chip-selected" data-value="1">ASA I</button>
              <button type="button" class="chip" data-value="2">ASA II</button>
              <button type="button" class="chip" data-value="3">ASA III</button>
              <button type="button" class="chip" data-value="4">ASA IV</button>
              <button type="button" class="chip" data-value="5">ASA V</button>
            </div>
            <input type="hidden" id="asaStatus" value="1" />

            <label class="field-label" style="margin-top:6px;">IV catheter</label>
            <div class="grid-two">
              <div>
                <label class="field-label">Gauge</label>
                <div id="ivGaugeGroup" class="chip-group">
                  <button type="button" class="chip chip-selected" data-value="22g">22G</button>
                  <button type="button" class="chip" data-value="20g">20G</button>
                  <button type="button" class="chip" data-value="18g">18G</button>
                  <button type="button" class="chip" data-value="24g">24G</button>
                </div>
                <input type="hidden" id="ivGauge" value="22g" />
              </div>
              <div>
                <label class="field-label">Site / side</label>
                <div id="ivSiteGroup" class="chip-group">
                  <button type="button" class="chip chip-selected" data-value="cephalic_left">L cephalic</button>
                  <button type="button" class="chip" data-value="cephalic_right">R cephalic</button>
                  <button type="button" class="chip" data-value="saphenous_left">L saphenous</button>
                  <button type="button" class="chip" data-value="saphenous_right">R saphenous</button>
                </div>
                <input type="hidden" id="ivSite" value="cephalic_left" />
              </div>
            </div>

            <label for="ettSize" class="field-label" style="margin-top:6px;">
              ET tube size (mm)
            </label>
            <input id="ettSize" class="input" placeholder="Eg. 8.0 cuffed" />

            <label class="field-label" style="margin-top:8px;">IV fluids</label>
            <div id="fluidsModeGroup" class="chip-group">
              <button type="button" class="chip chip-selected" data-mode="dog_default">
                Dog default (5 mL/kg/hr)
              </button>
              <button type="button" class="chip" data-mode="cat_default">
                Cat default (3 mL/kg/hr)
              </button>
              <button type="button" class="chip" data-mode="custom">
                Custom rate
              </button>
              <button type="button" class="chip" data-mode="declined">
                Declined
              </button>
            </div>

            <div class="grid-two" style="margin-top:8px;">
              <div>
                <label for="fluidRate" class="field-label">Custom rate (mL/kg/hr)</label>
                <input id="fluidRate" type="number" step="0.1" class="input" disabled />
              </div>
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input id="bolusGiven" type="checkbox" />
                  <span>Bolus given (describe in Plan)</span>
                </label>
              </div>
            </div>
          </div>

          <div class="card">
            <h3 class="card-title">Anesthesia & surgery notes</h3>

            <label for="premeds" class="field-label">Premedications (drug, dose, route)</label>
            <textarea id="premeds" class="textarea" rows="2"
              placeholder="Eg. Dexmedetomidine, Hydromorphone, Midazolam [5 mg/ml] ..."></textarea>

            <label for="induction" class="field-label" style="margin-top:6px;">
              Induction / maintenance
            </label>
            <textarea id="induction" class="textarea" rows="2"
              placeholder="Eg. Propofol to effect, Isoflurane/O2, local blocks."></textarea>

            <label for="intraOpMeds" class="field-label" style="margin-top:6px;">
              Intra-op medications
            </label>
            <textarea id="intraOpMeds" class="textarea" rows="2"
              placeholder="Eg. Fentanyl CRI, meloxicam, lidocaine blocks, etc."></textarea>

            <label for="procedureNotes" class="field-label" style="margin-top:6px;">
              Surgical procedure notes
            </label>
            <textarea id="procedureNotes" class="textarea" rows="3"
              placeholder="Approach, key findings, closure details, samples."></textarea>

            <div class="grid-two" style="margin-top:6px;">
              <div>
                <label for="anesthesiaDuration" class="field-label">Anesthesia duration (optional)</label>
                <input id="anesthesiaDuration" class="input" placeholder="Eg. 75 min" />
              </div>
              <div>
                <label for="surgeryDuration" class="field-label">Surgery duration (optional)</label>
                <input id="surgeryDuration" class="input" placeholder="Eg. 45 min" />
              </div>
            </div>

            <label class="field-label" style="margin-top:6px;">Recovery quality</label>
            <div id="recoveryGroup" class="chip-group">
              <button type="button" class="chip chip-selected" data-value="smooth">Smooth</button>
              <button type="button" class="chip" data-value="mild_dysphoria">Mild dysphoria</button>
              <button type="button" class="chip" data-value="moderate_dysphoria">Moderate dysphoria</button>
              <button type="button" class="chip" data-value="rough">Rough</button>
            </div>
            <input type="hidden" id="recoveryQuality" value="smooth" />

            <label for="recoveryNotes" class="field-label">
              Recovery notes
            </label>
            <textarea id="recoveryNotes" class="textarea" rows="2"></textarea>

            <label for="postOpMeds" class="field-label" style="margin-top:6px;">
              Post-op meds dispensed
            </label>
            <textarea id="postOpMeds" class="textarea" rows="2"
              placeholder="Eg. Robenacoxib, Gabapentin, Trazodone, etc."></textarea>
          </div>

          <div class="card">
            <h3 class="card-title">Generate Surgery SOAP</h3>
            <div class="btn-row">
              <button id="runSurgSoapBtn" class="btn-primary">Generate SOAP (Surgery)</button>
            </div>
            <div id="surgError" class="error-text hidden"></div>
          </div>
        </section>

        <!-- Toolbox -->
        <section id="toolboxTab" class="tab-panel hidden">
          <h2 class="section-title">Toolbox Lite</h2>

          <div class="card">
            <h3 class="card-title">Bloodwork Helper Lite</h3>
            <p class="card-subtitle">Paste CBC/chem/UA text.</p>

            <textarea id="bloodworkText" class="textarea" rows="5"
              placeholder="Paste lab text here."></textarea>

            <div class="grid-two" style="margin-top:6px;">
              <div>
                <label for="bloodworkDetail" class="field-label">Detail level</label>
                <select id="bloodworkDetail" class="select">
                  <option value="short">Short</option>
                  <option value="standard">Standard</option>
                </select>
              </div>
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input id="bloodworkIncludeDiffs" type="checkbox" checked />
                  <span>Include differentials</span>
                </label>
                <label class="checkbox-label">
                  <input id="bloodworkClientFriendly" type="checkbox" />
                  <span>Include client-friendly explanation</span>
                </label>
              </div>
            </div>

            <div class="btn-row" style="margin-top:8px;">
              <button id="runBloodworkBtn" class="btn-primary">Run Bloodwork Helper</button>
            </div>

            <label for="bloodworkOutput" class="field-label" style="margin-top:6px;">
              Bloodwork Helper output
            </label>
            <textarea id="bloodworkOutput" class="textarea" rows="8" readonly></textarea>
          </div>

          <div class="card">
            <h3 class="card-title">Email / Client Communication Helper</h3>

            <div class="grid-two">
              <div>
                <label for="emailType" class="field-label">Template type</label>
                <select id="emailType" class="select">
                  <option value="bloodwork-followup">Bloodwork follow-up</option>
                  <option value="dental-estimate">Dental estimate</option>
                  <option value="general-update">General update</option>
                  <option value="vaccine-reminder">Vaccine reminder</option>
                </select>
              </div>
              <div>
                <label for="emailTimeframe" class="field-label">Timeframe</label>
                <input id="emailTimeframe" class="input" placeholder="Eg. within 1–2 weeks" />
              </div>
            </div>

            <div class="grid-two" style="margin-top:6px;">
              <div>
                <label for="emailPetName" class="field-label">Pet name (optional)</label>
                <input id="emailPetName" class="input" />
              </div>
              <div>
                <label for="emailOwnerName" class="field-label">Owner name (optional)</label>
                <input id="emailOwnerName" class="input" />
              </div>
            </div>

            <label for="emailNotes" class="field-label" style="margin-top:6px;">
              Notes / key points to include
            </label>
            <textarea id="emailNotes" class="textarea" rows="4"></textarea>

            <div class="btn-row" style="margin-top:8px;">
              <button id="runEmailBtn" class="btn-primary">Generate email text</button>
            </div>

            <label for="emailOutput" class="field-label" style="margin-top:6px;">
              Email output
            </label>
            <textarea id="emailOutput" class="textarea" rows="8" readonly></textarea>
          </div>
        </section>

        <!-- Consult -->
        <section id="consultTab" class="tab-panel hidden">
          <h2 class="section-title">Consult helper</h2>

          <div class="card">
            <h3 class="card-title">Free-text consult</h3>
            <p class="card-subtitle">
              For your own notes / brainstorming; does NOT output SOAP headings.
            </p>

            <label for="consultMessage" class="field-label">Consult question / case summary</label>
            <textarea id="consultMessage" class="textarea" rows="6"
              placeholder="Describe the case or ask your question."></textarea>

            <div class="btn-row" style="margin-top:8px;">
              <button id="runConsultBtn" class="btn-primary">Run consult</button>
            </div>

            <label for="consultOutput" class="field-label" style="margin-top:6px;">
              Consult output
            </label>
            <textarea id="consultOutput" class="textarea" rows="10" readonly></textarea>
          </div>
        </section>
      </div>

      <!-- RIGHT: SOAP OUTPUT -->
      <div>
        <div class="card">
          <h3 class="card-title">SOAP output</h3>
          <p class="card-subtitle">
            Output from /api/run (mode "soap") using your Assistant rules. Paste directly into Avimark.
          </p>

          <div class="btn-row" style="margin-bottom:6px;">
            <button id="copySoapBtn" class="btn-secondary">Copy full SOAP</button>
          </div>

          <div class="output-box">
            <textarea id="soapOutput" class="textarea" rows="22" readonly></textarea>
          </div>

          <div id="feedbackBar" class="feedback-bar hidden"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =============== UTILITIES ===============
    function $(id) { return document.getElementById(id); }
    function getText(id) { return ($(id)?.value || "").trim(); }
    function setText(id, value) { if ($(id)) $(id).value = value || ""; }

    function showError(id, msg) {
      const el = $(id);
      if (!el) return;
      if (msg) {
        el.textContent = msg;
        el.classList.remove("hidden");
      } else {
        el.textContent = "";
        el.classList.add("hidden");
      }
    }

    function copyToClipboard(text) {
      if (!text) return;
      navigator.clipboard.writeText(text).catch(err => console.error("Copy failed", err));
    }

    // =============== TABS ===============
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabPanels = document.querySelectorAll(".tab-panel");

    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.dataset.tab;
        tabButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        tabPanels.forEach(panel => {
          if (panel.id === target) panel.classList.remove("hidden");
          else panel.classList.add("hidden");
        });
      });
    });

    // =============== CHIP GROUP HELPERS ===============
    function setupSingleSelectChipGroup(groupId, hiddenInputId) {
      const group = $(groupId);
      const hidden = hiddenInputId ? $(hiddenInputId) : null;
      if (!group) return;
      group.addEventListener("click", e => {
        const btn = e.target.closest("button");
        if (!btn || !btn.dataset.value) return;
        group.querySelectorAll(".chip").forEach(c => c.classList.remove("chip-selected"));
        btn.classList.add("chip-selected");
        if (hidden) hidden.value = btn.dataset.value;
      });
    }

    setupSingleSelectChipGroup("asaChipGroup", "asaStatus");
    setupSingleSelectChipGroup("ivGaugeGroup", "ivGauge");
    setupSingleSelectChipGroup("ivSiteGroup", "ivSite");
    setupSingleSelectChipGroup("recoveryGroup", "recoveryQuality");

    // Fluids chip group
    const fluidsGroup = $("fluidsModeGroup");
    const fluidRateInput = $("fluidRate");
    if (fluidsGroup && fluidRateInput) {
      fluidsGroup.addEventListener("click", e => {
        const btn = e.target.closest("button[data-mode]");
        if (!btn) return;
        fluidsGroup.querySelectorAll(".chip").forEach(c => c.classList.remove("chip-selected"));
        btn.classList.add("chip-selected");
        const mode = btn.dataset.mode;
        fluidRateInput.dataset.mode = mode;
        if (mode === "custom") {
          fluidRateInput.disabled = false;
          fluidRateInput.value = "";
          fluidRateInput.focus();
        } else {
          fluidRateInput.disabled = true;
          if (mode === "dog_default") fluidRateInput.value = "5";
          if (mode === "cat_default") fluidRateInput.value = "3";
          if (mode === "declined") fluidRateInput.value = "";
        }
      });
      // default
      fluidRateInput.dataset.mode = "dog_default";
      fluidRateInput.value = "5";
    }

    // =============== FEEDBACK BAR (local heuristic) ===============
    function buildMissingFieldsSummary(payload) {
      const missing = [];

      if (payload.soapType === "appointment") {
        if (!payload.reason) missing.push("Reason for visit");
        if (!payload.pe) missing.push("PE summary");
        if (!payload.diagnostics) missing.push("Diagnostics data");
      }

      if (payload.soapType === "surgery") {
        const quick = !!payload.quickMode;
        if (!payload.surgeryType) missing.push("Surgery template");
        if (!payload.weightKg) missing.push("Weight (kg)");
        if (!payload.asaStatus) missing.push("ASA status");
        if (!payload.ivGauge) missing.push("IV catheter gauge");
        if (!payload.ivSite) missing.push("IV catheter site");
        if (!payload.ettSize) missing.push("ET tube size");
        if (!quick) {
          if (!payload.premeds) missing.push("Premeds");
          if (!payload.induction) missing.push("Induction/maintenance");
        }
      }

      if (!missing.length) {
        return "Looks good. You can refine details any time or re-run after adding more specifics.";
      }

      return "You can improve this SOAP by adding: " + missing.join(", ") + ".";
    }

    function showFeedback(payload) {
      const bar = $("feedbackBar");
      const msg = buildMissingFieldsSummary(payload);
      bar.textContent = msg;
      bar.classList.remove("hidden");
    }

    function clearFeedback() {
      const bar = $("feedbackBar");
      bar.classList.add("hidden");
      bar.textContent = "";
    }

    // =============== /api/run CALL ===============
    async function callApiRun(body, errorId, onResult) {
      showError(errorId, "");
      try {
        const res = await fetch("/api/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        if (!res.ok) throw new Error("Network error");
        const data = await res.json();
        onResult(data.result || "");
      } catch (err) {
        console.error(err);
        onResult("");
        showError(errorId, "Error: backend call failed.");
      }
    }

    // =============== APPOINTMENT SOAP ===============
    $("runApptSoapBtn").addEventListener("click", () => {
      const payload = {
        soapType: "appointment",
        strictMode: $("apptStrictMode").checked,
        caseLabel: getText("apptCaseLabel"),
        visitType: $("apptVisitType").value,
        weightKg: getText("apptWeight"),
        ageYears: getText("apptAgeYears"),
        tpr: getText("apptTPR"),
        reason: getText("apptReason"),
        history: getText("apptHistory"),
        pe: getText("apptPE"),
        diagnostics: getText("apptDiagnostics"),
        assessmentNotes: getText("apptAssessment"),
        planNotes: getText("apptPlan"),
        medsNotes: getText("apptMeds")
      };

      clearFeedback();
      showFeedback(payload);

      $("soapOutput").value = "Generating Appointment SOAP…";

      callApiRun({ mode: "soap", payload }, "apptError", text => {
        $("soapOutput").value = text;
      });
    });

    // =============== SURGERY SOAP ===============
    $("runSurgSoapBtn").addEventListener("click", () => {
      const payload = {
        soapType: "surgery",
        strictMode: $("surgStrictMode").checked,
        quickMode: $("surgQuickMode").checked,
        caseLabel: getText("surgCaseLabel"),
        species: $("surgSpecies").value,
        weightKg: getText("surgWeight"),
        ageYears: getText("surgAgeYears"),
        tpr: getText("surgTPR"),
        surgeryType: $("surgeryType").value,
        asaStatus: $("asaStatus").value,
        ivGauge: $("ivGauge").value,
        ivSite: $("ivSite").value,
        ettSize: getText("ettSize"),
        fluidsMode: fluidRateInput.dataset.mode,
        fluidRate: getText("fluidRate"),
        bolusGiven: $("bolusGiven").checked,
        premeds: getText("premeds"),
        induction: getText("induction"),
        intraOpMeds: getText("intraOpMeds"),
        procedureNotes: getText("procedureNotes"),
        anesthesiaDuration: getText("anesthesiaDuration"),
        surgeryDuration: getText("surgeryDuration"),
        recoveryQuality: $("recoveryQuality").value,
        recoveryNotes: getText("recoveryNotes"),
        postOpMeds: getText("postOpMeds")
      };

      clearFeedback();
      showFeedback(payload);

      $("soapOutput").value = "Generating Surgery SOAP…";

      callApiRun({ mode: "soap", payload }, "surgError", text => {
        $("soapOutput").value = text;
      });
    });

    // =============== TOOLBOX: BLOODWORK ===============
    $("runBloodworkBtn").addEventListener("click", () => {
      const payload = {
        text: getText("bloodworkText"),
        detailLevel: $("bloodworkDetail").value,
        includeDiffs: $("bloodworkIncludeDiffs").checked,
        includeClientFriendly: $("bloodworkClientFriendly").checked
      };

      $("bloodworkOutput").value = "Thinking about the lab work…";

      callApiRun({ mode: "toolbox-bloodwork", payload }, null, text => {
        $("bloodworkOutput").value = text;
      });
    });

    // =============== TOOLBOX: EMAIL ===============
    $("runEmailBtn").addEventListener("click", () => {
      const payload = {
        emailType: $("emailType").value,
        petName: getText("emailPetName"),
        ownerName: getText("emailOwnerName"),
        timeframe: getText("emailTimeframe"),
        notes: getText("emailNotes")
      };

      $("emailOutput").value = "Drafting email…";

      callApiRun({ mode: "toolbox-email", payload }, null, text => {
        $("emailOutput").value = text;
      });
    });

    // =============== CONSULT ===============
    $("runConsultBtn").addEventListener("click", () => {
      const payload = { message: getText("consultMessage") };

      $("consultOutput").value = "Thinking through the case…";

      callApiRun({ mode: "consult", payload }, null, text => {
        $("consultOutput").value = text;
      });
    });

    // =============== COPY SOAP ===============
    $("copySoapBtn").addEventListener("click", () => {
      copyToClipboard(getText("soapOutput"));
    });
  </script>
</body>
</html>