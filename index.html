<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lohit SOAP App v1.6.3 – Assistant-backed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --primary: #0f766e;
      --primary-dark: #115e59;
      --text: #111827;
      --muted: #6b7280;
      --danger: #dc2626;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.08);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .app-shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    header { margin-bottom: 12px; }

    .app-title {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      display: flex;
      align-items: baseline;
      gap: 8px;
    }

    .app-title span {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--muted);
    }

    .app-subtitle {
      margin-top: 4px;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .tab-bar {
      display: flex;
      gap: 8px;
      margin: 12px 0;
      overflow-x: auto;
    }

    .tab-btn {
      flex: 1;
      min-width: 0;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      font-size: 0.9rem;
      font-weight: 500;
      text-align: center;
      cursor: pointer;
      white-space: nowrap;
    }

    .tab-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .main-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 16px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .main-grid { grid-template-columns: minmax(0, 1fr); }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding: 14px 16px 16px;
      margin-bottom: 10px;
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .card-subtitle {
      margin: 0 0 8px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .field-label {
      display: block;
      font-size: 0.8rem;
      font-weight: 500;
      margin-bottom: 4px;
      color: #374151;
    }

    .input,
    .select,
    .textarea {
      width: 100%;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: 8px 10px;
      font-size: 0.9rem;
      font-family: inherit;
      background: #f9fafb;
      outline: none;
      transition: border-color 0.12s ease, box-shadow 0.12s ease;
    }

    .input:focus,
    .select:focus,
    .textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(15, 118, 110, 0.2);
      background: #ffffff;
    }

    .textarea { resize: vertical; }

    .btn-primary,
    .btn-secondary,
    .btn-ghost {
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.9rem;
      font-weight: 500;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover { background: #115e59; }

    .btn-secondary {
      background: #eef2ff;
      color: #1e293b;
      border: 1px solid #e0e7ff;
    }

    .btn-ghost {
      background: transparent;
      border: 1px dashed var(--border);
      color: var(--muted);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .muted {
      color: var(--muted);
      font-size: 0.8rem;
    }

    .grid-two {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    @media (max-width: 700px) {
      .grid-two { grid-template-columns: minmax(0, 1fr); }
    }

    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 4px;
    }

    .chip {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .chip-selected {
      background: var(--primary);
      color: #ffffff;
      border-color: var(--primary);
    }

    .toggle-group {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid var(--border);
      overflow: hidden;
      font-size: 0.8rem;
    }

    .toggle-option {
      padding: 4px 10px;
      cursor: pointer;
      background: #f9fafb;
      color: var(--muted);
      border-right: 1px solid var(--border);
    }

    .toggle-option:last-child { border-right: none; }

    .toggle-option.active {
      background: #dcfce7;
      color: #065f46;
      font-weight: 600;
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.85rem;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .checkbox-label input { margin: 0; }

    .output-box { margin-bottom: 10px; }

    .feedback-bar {
      font-size: 0.8rem;
      padding: 8px 10px;
      border-radius: var(--radius-md);
      background: #ecfeff;
      border: 1px solid #bae6fd;
      color: #0f172a;
      margin-top: 6px;
    }

    .hidden { display: none; }

    .error-text {
      color: var(--danger);
      font-size: 0.8rem;
      margin-top: 4px;
    }

    .attachment-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .attachment-status {
      font-size: 0.8rem;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .status-pill.pending {
      background: #fee2e2;
      color: #b91c1c;
    }

    .status-pill.safe {
      background: #dcfce7;
      color: #166534;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="app-title">
        Lohit SOAP App <span>v1.6.3 – Assistant-backed</span>
      </div>
      <div class="app-subtitle">
        Appointment / Surgery SOAPs + Toolbox Lite. Uses your /api/run endpoint and Assistant rules.
      </div>
    </header>

    <div class="tab-bar">
      <button class="tab-btn active" data-tab="appointmentTab">Appointment</button>
      <button class="tab-btn" data-tab="surgeryTab">Surgery</button>
      <button class="tab-btn" data-tab="toolboxTab">Toolbox</button>
      <button class="tab-btn" data-tab="consultTab">Consult</button>
    </div>

    <div class="main-grid">
      <!-- LEFT COLUMN -->
      <div>
        <!-- Global attachments card -->
        <div class="card">
          <h3 class="card-title">Attachments (optional)</h3>
          <p class="card-subtitle">
            Attach lab PDFs, screenshots, or photos of printouts. Shared across SOAPs and Toolbox.
            For now, redact private info manually before upload if needed.
          </p>

          <div class="attachment-row">
            <button id="takePhotoBtn" class="btn-secondary">Take photo</button>
            <button id="uploadFileBtn" class="btn-ghost">Upload file</button>
            <input id="sharedFileInput" type="file" accept="image/*,.pdf" style="display:none;" />
            <span class="attachment-status" id="attachmentStatus">
              <span class="status-pill pending">No file</span>
              <span>Local preview only; Vision tools come later.</span>
            </span>
          </div>

          <div id="attachmentPreviewWrapper" class="hidden" style="margin-top:8px;">
            <span class="field-label">Preview (images only)</span>
            <div style="border-radius:12px;border:1px solid var(--border);overflow:hidden;max-height:200px;">
              <img id="attachmentPreviewImg" src="" alt="Preview"
                   style="width:100%;display:block;object-fit:contain;background:#000;" />
            </div>
            <div class="btn-row">
              <button id="clearAttachmentBtn" class="btn-ghost">Remove file</button>
            </div>
          </div>
        </div>

        <!-- Appointment tab -->
        <section id="appointmentTab" class="tab-panel">
          <h2 class="section-title">Appointment mode</h2>

          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
              <h3 class="card-title">Input style</h3>
              <div class="toggle-group" id="apptModeToggle">
                <div class="toggle-option active" data-mode="simple">Simple</div>
                <div class="toggle-option" data-mode="advanced">Advanced</div>
              </div>
            </div>
            <p class="card-subtitle">
              Simple = one big notes box (talk/type everything). Advanced = structured fields.
            </p>

            <!-- Simple -->
            <div id="apptSimpleBlock">
              <label for="apptQuickNotes" class="field-label">
                Quick notes (I’ll parse this into SOAP)
              </label>
              <textarea id="apptQuickNotes" class="textarea" rows="6"
                placeholder="Eg. 6yo MN Lab, itchy ears 2 weeks, cytology 2+ cocci 1+ yeast, treated with Mometamax, Apoquel, recheck in 2 weeks."></textarea>
            </div>

            <!-- Advanced -->
            <div id="apptAdvancedBlock" class="hidden">
              <div class="grid-two">
                <div>
                  <label for="apptCaseLabel" class="field-label">Case label / patient name (optional)</label>
                  <input id="apptCaseLabel" class="input" placeholder="Eg. Milo – itchy ears" />
                </div>
                <div>
                  <label for="apptVisitType" class="field-label">Visit type</label>
                  <select id="apptVisitType" class="select">
                    <option value="sick">Sick visit</option>
                    <option value="wellness">Wellness / vaccine</option>
                    <option value="recheck">Recheck</option>
                    <option value="tech">Tech appointment</option>
                    <option value="other">Other</option>
                  </select>
                </div>
              </div>

              <div class="grid-two" style="margin-top:8px;">
                <div>
                  <label for="apptWeight" class="field-label">Weight (kg, optional)</label>
                  <input id="apptWeight" type="number" step="0.01" class="input" />
                </div>
                <div>
                  <label for="apptAgeYears" class="field-label">Age (years, optional)</label>
                  <input id="apptAgeYears" type="number" step="0.1" class="input" />
                </div>
              </div>

              <div style="margin-top:8px;">
                <label for="apptTPR" class="field-label">TPR (optional)</label>
                <input id="apptTPR" class="input" placeholder="Eg. T 38.5, P 100, R 24" />
              </div>

              <hr style="margin:10px 0;border:none;border-top:1px dashed var(--border);" />

              <label for="apptReason" class="field-label">Reason for visit</label>
              <textarea id="apptReason" class="textarea" rows="2"></textarea>

              <label for="apptHistory" class="field-label" style="margin-top:6px;">
                History
              </label>
              <textarea id="apptHistory" class="textarea" rows="3"></textarea>

              <label for="apptPE" class="field-label" style="margin-top:6px;">
                Physical exam notes (data only)
              </label>
              <textarea id="apptPE" class="textarea" rows="3"
                placeholder="Eg. BAR, MM pink, CRT <2s, HR 120, no murmur, lungs clear, etc."></textarea>

              <label for="apptDiagnostics" class="field-label" style="margin-top:6px;">
                Diagnostics (data only)
              </label>
              <textarea id="apptDiagnostics" class="textarea" rows="3"
                placeholder="Eg. SNAP 4Dx negative, ear cytology 2+ cocci, 1+ yeast."></textarea>

              <label for="apptAssessment" class="field-label" style="margin-top:6px;">
                Assessment notes (optional)
              </label>
              <textarea id="apptAssessment" class="textarea" rows="2"></textarea>

              <label for="apptPlan" class="field-label" style="margin-top:6px;">
                Plan notes
              </label>
              <textarea id="apptPlan" class="textarea" rows="3"></textarea>

              <label for="apptMeds" class="field-label" style="margin-top:6px;">
                Medications dispensed (optional)
              </label>
              <textarea id="apptMeds" class="textarea" rows="2"></textarea>
            </div>

            <div class="checkbox-group" style="margin-top:8px;">
              <label class="checkbox-label">
                <input id="apptStrictMode" type="checkbox" />
                <span>Strict mode (no assumed normals)</span>
              </label>
            </div>
          </div>

          <div class="card">
            <h3 class="card-title">Generate Appointment SOAP</h3>
            <div class="btn-row">
              <button id="runApptSoapBtn" class="btn-primary">Generate SOAP (Appointment)</button>
            </div>
            <div id="apptError" class="error-text hidden"></div>
          </div>
        </section>

        <!-- Surgery tab -->
        <section id="surgeryTab" class="tab-panel hidden">
          <h2 class="section-title">Surgery mode</h2>

          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
              <h3 class="card-title">Input style</h3>
              <div class="toggle-group" id="surgModeToggle">
                <div class="toggle-option active" data-mode="simple">Simple</div>
                <div class="toggle-option" data-mode="advanced">Advanced</div>
              </div>
            </div>
            <p class="card-subtitle">
              Simple = one big notes box (tech/rapid). Advanced = full structured surgery entry.
            </p>

            <!-- Simple -->
            <div id="surgSimpleBlock">
              <label for="surgQuickNotes" class="field-label">
                Quick surgery notes (I’ll parse into full SOAP)
              </label>
              <textarea id="surgQuickNotes" class="textarea" rows="6"
                placeholder="Eg. 2yo FS Lab, ASA II, 22g L cephalic, 8.0 ET tube, dog fluids default, ovariohysterectomy uneventful, closure standard 3-layer, recovery smooth."></textarea>
            </div>

            <!-- Advanced -->
            <div id="surgAdvancedBlock" class="hidden">
              <div class="grid-two">
                <div>
                  <label for="surgCaseLabel" class="field-label">Case label / patient name (optional)</label>
                  <input id="surgCaseLabel" class="input" placeholder="Eg. Bella – spay" />
                </div>
                <div>
                  <label for="surgSpecies" class="field-label">Species</label>
                  <select id="surgSpecies" class="select">
                    <option value="dog">Dog</option>
                    <option value="cat">Cat</option>
                    <option value="other">Other</option>
                  </select>
                </div>
              </div>

              <div class="grid-two" style="margin-top:8px;">
                <div>
                  <label for="surgWeight" class="field-label">Weight (kg)</label>
                  <input id="surgWeight" type="number" step="0.01" class="input" />
                </div>
                <div>
                  <label for="surgAgeYears" class="field-label">Age (years, optional)</label>
                  <input id="surgAgeYears" type="number" step="0.1" class="input" />
                </div>
              </div>

              <div style="margin-top:8px;">
                <label for="surgTPR" class="field-label">TPR (optional)</label>
                <input id="surgTPR" class="input" placeholder="Eg. T 38.4, P 90, R 20" />
              </div>

              <div class="checkbox-group" style="margin-top:8px;">
                <label class="checkbox-label">
                  <input id="surgQuickMode" type="checkbox" />
                  <span>Quick mode (tech-friendly, minimal required fields)</span>
                </label>
                <label class="checkbox-label">
                  <input id="surgStrictMode" type="checkbox" />
                  <span>Strict mode (no assumed normals)</span>
                </label>
              </div>
            </div>
          </div>

          <div id="surgAdvancedDetailCard" class="card hidden">
            <h3 class="card-title">Surgery details</h3>

            <label for="surgeryType" class="field-label">Surgery template</label>
            <select id="surgeryType" class="select">
              <option value="canine_spay_standard">Canine spay – standard</option>
              <option value="canine_spay_rescue">Canine spay – rescue</option>
              <option value="canine_neuter_standard">Canine neuter – standard</option>
              <option value="canine_neuter_rescue">Canine neuter – rescue</option>
              <option value="dental_cohat_rads">Dental – COHAT with radiographs</option>
              <option value="dental_cohat_no_rads">Dental – COHAT without radiographs</option>
              <option value="mass_removal">Mass removal</option>
              <option value="cystotomy">Cystotomy</option>
              <option value="pyometra_spay">Pyometra spay</option>
              <option value="exploratory_laparotomy">Exploratory laparotomy</option>
              <option value="enterotomy">Enterotomy</option>
              <option value="gastrotomy">Gastrotomy</option>
              <option value="gastropexy">Gastropexy</option>
              <option value="feline_urinary_unblock">Feline urethral unblock</option>
              <option value="custom">Custom / other</option>
            </select>

            <label class="field-label" style="margin-top:6px;">ASA status</label>
            <div id="asaChipGroup" class="chip-group">
              <button type="button" class="chip chip-selected" data-value="1">ASA I</button>
              <button type="button" class="chip" data-value="2">ASA II</button>
              <button type="button" class="chip" data-value="3">ASA III</button>
              <button type="button" class="chip" data-value="4">ASA IV</button>
              <button type="button" class="chip" data-value="5">ASA V</button>
            </div>
            <input type="hidden" id="asaStatus" value="1" />

            <label class="field-label" style="margin-top:6px;">IV catheter</label>
            <div class="grid-two">
              <div>
                <label class="field-label">Gauge</label>
                <div id="ivGaugeGroup" class="chip-group">
                  <button type="button" class="chip chip-selected" data-value="22g">22G</button>
                  <button type="button" class="chip" data-value="20g">20G</button>
                  <button type="button" class="chip" data-value="18g">18G</button>
                  <button type="button" class="chip" data-value="24g">24G</button>
                </div>
                <input type="hidden" id="ivGauge" value="22g" />
              </div>
              <div>
                <label class="field-label">Site / side</label>
                <div id="ivSiteGroup" class="chip-group">
                  <button type="button" class="chip chip-selected" data-value="cephalic_left">L cephalic</button>
                  <button type="button" class="chip" data-value="cephalic_right">R cephalic</button>
                  <button type="button" class="chip" data-value="saphenous_left">L saphenous</button>
                  <button type="button" class="chip" data-value="saphenous_right">R saphenous</button>
                </div>
                <input type="hidden" id="ivSite" value="cephalic_left" />
              </div>
            </div>

            <label for="ettSize" class="field-label" style="margin-top:6px;">
              ET tube size (mm)
            </label>
            <input id="ettSize" class="input" placeholder="Eg. 8.0 cuffed" />

            <label class="field-label" style="margin-top:8px;">IV fluids</label>
            <div id="fluidsModeGroup" class="chip-group">
              <button type="button" class="chip chip-selected" data-mode="dog_default">
                Dog default (5 mL/kg/hr)
              </button>
              <button type="button" class="chip" data-mode="cat_default">
                Cat default (3 mL/kg/hr)
              </button>
              <button type="button" class="chip" data-mode="custom">
                Custom rate
              </button>
              <button type="button" class="chip" data-mode="declined">
                Declined
              </button>
            </div>

            <div class="grid-two" style="margin-top:8px;">
              <div>
                <label for="fluidRate" class="field-label">Custom rate (mL/kg/hr)</label>
                <input id="fluidRate" type="number" step="0.1" class="input" disabled />
              </div>
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input id="bolusGiven" type="checkbox" />
                  <span>Bolus given (describe in Plan)</span>
                </label>
              </div>
            </div>
          </div>

          <div id="surgAdvancedAnesthesiaCard" class="card hidden">
            <h3 class="card-title">Anesthesia & surgery notes</h3>

            <label for="premeds" class="field-label">Premedications (drug, dose, route)</label>
            <textarea id="premeds" class="textarea" rows="2"></textarea>

            <label for="induction" class="field-label" style="margin-top:6px;">
              Induction / maintenance
            </label>
            <textarea id="induction" class="textarea" rows="2"></textarea>

            <label for="intraOpMeds" class="field-label" style="margin-top:6px;">
              Intra-op medications
            </label>
            <textarea id="intraOpMeds" class="textarea" rows="2"></textarea>

            <label for="procedureNotes" class="field-label" style="margin-top:6px;">
              Surgical procedure notes
            </label>
            <textarea id="procedureNotes" class="textarea" rows="3"></textarea>

            <div class="grid-two" style="margin-top:6px;">
              <div>
                <label for="anesthesiaDuration" class="field-label">Anesthesia duration (optional)</label>
                <input id="anesthesiaDuration" class="input" placeholder="Eg. 75 min" />
              </div>
              <div>
                <label for="surgeryDuration" class="field-label">Surgery duration (optional)</label>
                <input id="surgeryDuration" class="input" placeholder="Eg. 45 min" />
              </div>
            </div>

            <label class="field-label" style="margin-top:6px;">Recovery quality</label>
            <div id="recoveryGroup" class="chip-group">
              <button type="button" class="chip chip-selected" data-value="smooth">Smooth</button>
              <button type="button" class="chip" data-value="mild_dysphoria">Mild dysphoria</button>
              <button type="button" class="chip" data-value="moderate_dysphoria">Moderate dysphoria</button>
              <button type="button" class="chip" data-value="rough">Rough</button>
            </div>
            <input type="hidden" id="recoveryQuality" value="smooth" />

            <label for="recoveryNotes" class="field-label">
              Recovery notes
            </label>
            <textarea id="recoveryNotes" class="textarea" rows="2"></textarea>

            <label for="postOpMeds" class="field-label" style="margin-top:6px;">
              Post-op meds dispensed
            </label>
            <textarea id="postOpMeds" class="textarea" rows="2"></textarea>
          </div>

          <div class="card">
            <h3 class="card-title">Generate Surgery SOAP</h3>
            <div class="btn-row">
              <button id="runSurgSoapBtn" class="btn-primary">Generate SOAP (Surgery)</button>
            </div>
            <div id="surgError" class="error-text hidden"></div>
          </div>
        </section>

        <!-- Toolbox tab -->
        <section id="toolboxTab" class="tab-panel hidden">
          <h2 class="section-title">Toolbox Lite</h2>

          <!-- Bloodwork helper -->
          <div class="card">
            <h3 class="card-title">Bloodwork Helper Lite</h3>
            <p class="card-subtitle">
              Paste CBC/chem/UA text. Attachments above are shared if you need the image for context.
            </p>

            <label for="bloodworkText" class="field-label">Lab text (paste here)</label>
            <textarea id="bloodworkText" class="textarea" rows="5"
              placeholder="Paste lab text here. Vision tools will come later for images."></textarea>

            <div class="grid-two" style="margin-top:6px;">
              <div>
                <label for="bloodworkDetail" class="field-label">Detail level</label>
                <select id="bloodworkDetail" class="select">
                  <option value="short">Short</option>
                  <option value="standard">Standard</option>
                </select>
              </div>
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input id="bloodworkIncludeDiffs" type="checkbox" checked />
                  <span>Include differentials</span>
                </label>
                <label class="checkbox-label">
                  <input id="bloodworkClientFriendly" type="checkbox" />
                  <span>Include client-friendly explanation</span>
                </label>
              </div>
            </div>

            <div class="btn-row" style="margin-top:8px;">
              <button id="runBloodworkBtn" class="btn-primary">Run Bloodwork Helper</button>
              <button id="copyBloodworkOutputBtn" class="btn-secondary">Copy output</button>
            </div>

            <label for="bloodworkOutput" class="field-label" style="margin-top:6px;">
              Bloodwork Helper output
            </label>
            <textarea id="bloodworkOutput" class="textarea" rows="8" readonly></textarea>

            <div style="margin-top:6px;border-top:1px dashed var(--border);padding-top:6px;">
              <label for="bloodworkRefineInput" class="field-label">Feedback / refine (optional)</label>
              <textarea id="bloodworkRefineInput" class="textarea" rows="2"
                placeholder="Eg. Emphasize ALT more, mention CK is normal, shorten client explanation."></textarea>
              <div class="btn-row">
                <button id="refineBloodworkBtn" class="btn-ghost">Refine output</button>
              </div>
            </div>
          </div>

          <!-- Email helper -->
          <div class="card">
            <h3 class="card-title">Email / Client Communication Helper</h3>

            <div class="grid-two">
              <div>
                <label for="emailType" class="field-label">Template type</label>
                <select id="emailType" class="select">
                  <option value="bloodwork-followup">Bloodwork follow-up</option>
                  <option value="dental-estimate">Dental estimate</option>
                  <option value="general-update">General update</option>
                  <option value="vaccine-reminder">Vaccine reminder</option>
                </select>
              </div>
              <div>
                <label for="emailTimeframe" class="field-label">Timeframe</label>
                <input id="emailTimeframe" class="input" placeholder="Eg. within 1–2 weeks" />
              </div>
            </div>

            <div class="grid-two" style="margin-top:6px;">
              <div>
                <label for="emailPetName" class="field-label">Pet name (optional)</label>
                <input id="emailPetName" class="input" />
              </div>
              <div>
                <label for="emailOwnerName" class="field-label">Owner name (optional)</label>
                <input id="emailOwnerName" class="input" />
              </div>
            </div>

            <label for="emailNotes" class="field-label" style="margin-top:6px;">
              Notes / key points to include
            </label>
            <textarea id="emailNotes" class="textarea" rows="4"></textarea>

            <div class="btn-row" style="margin-top:8px;">
              <button id="runEmailBtn" class="btn-primary">Generate email text</button>
              <button id="copyEmailOutputBtn" class="btn-secondary">Copy email</button>
            </div>

            <label for="emailOutput" class="field-label" style="margin-top:6px;">
              Email output
            </label>
            <textarea id="emailOutput" class="textarea" rows="8" readonly></textarea>

            <div style="margin-top:6px;border-top:1px dashed var(--border);padding-top:6px;">
              <label for="emailRefineInput" class="field-label">Feedback / refine (optional)</label>
              <textarea id="emailRefineInput" class="textarea" rows="2"
                placeholder="Eg. Make tone softer, mention pre-visit sedation option, shorten closing."></textarea>
              <div class="btn-row">
                <button id="refineEmailBtn" class="btn-ghost">Refine email</button>
              </div>
            </div>
          </div>
        </section>

        <!-- Consult tab -->
        <section id="consultTab" class="tab-panel hidden">
          <h2 class="section-title">Consult helper</h2>

          <div class="card">
            <h3 class="card-title">Free-text consult</h3>
            <p class="card-subtitle">
              For your own notes / brainstorming; does NOT output SOAP headings.
            </p>

            <label for="consultMessage" class="field-label">Consult question / case summary</label>
            <textarea id="consultMessage" class="textarea" rows="6"
              placeholder="Describe the case or ask your question."></textarea>

            <div class="btn-row" style="margin-top:8px;">
              <button id="runConsultBtn" class="btn-primary">Run consult</button>
            </div>

            <label for="consultOutput" class="field-label" style="margin-top:6px;">
              Consult output
            </label>
            <textarea id="consultOutput" class="textarea" rows="10" readonly></textarea>
          </div>
        </section>
      </div>

      <!-- RIGHT COLUMN: SOAP OUTPUT -->
      <div>
        <div class="card">
          <h3 class="card-title">SOAP output</h3>
          <p class="card-subtitle">
            Output from /api/run (mode "soap") using your Assistant rules. Paste directly into Avimark.
          </p>

          <div class="btn-row" style="margin-bottom:6px;">
            <button id="copySoapBtn" class="btn-secondary">Copy full SOAP</button>
          </div>

          <div class="output-box">
            <textarea id="soapOutput" class="textarea" rows="22" readonly></textarea>
          </div>

          <div id="feedbackBar" class="feedback-bar hidden"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function $(id) { return document.getElementById(id); }
    function getText(id) { return ($(id) && $(id).value || "").trim(); }
    function setText(id, v) { if ($(id)) $(id).value = v || ""; }
    function showError(id, msg) {
      var el = $(id);
      if (!el) return;
      if (msg) {
        el.textContent = msg;
        el.classList.remove("hidden");
      } else {
        el.textContent = "";
        el.classList.add("hidden");
      }
    }
    function copyToClipboard(text) {
      if (!text) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).catch(function(){});
      }
    }
    async function callApiRun(body, errorId, onResult) {
      if (errorId) showError(errorId, "");
      try {
        const res = await fetch("/api/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        if (!res.ok) throw new Error("Network error");
        const data = await res.json();
        if (typeof onResult === "function") onResult(data.result || "");
      } catch (err) {
        console.error(err);
        if (typeof onResult === "function") onResult("");
        if (errorId) showError(errorId, "Error: backend call failed.");
      }
    }

    document.addEventListener("DOMContentLoaded", function () {
      // Tabs
      var tabButtons = document.querySelectorAll(".tab-btn");
      var tabPanels = document.querySelectorAll(".tab-panel");
      tabButtons.forEach(function(btn) {
        btn.addEventListener("click", function() {
          var target = btn.getAttribute("data-tab");
          tabButtons.forEach(function(b){ b.classList.remove("active"); });
          btn.classList.add("active");
          tabPanels.forEach(function(panel){
            if (panel.id === target) panel.classList.remove("hidden");
            else panel.classList.add("hidden");
          });
        });
      });

      // Chip groups
      function setupChipGroup(groupId, hiddenId) {
        var group = $(groupId);
        var hidden = $(hiddenId);
        if (!group) return;
        group.addEventListener("click", function(e) {
          var btn = e.target.closest("button[data-value]");
          if (!btn) return;
          group.querySelectorAll(".chip").forEach(function(c){ c.classList.remove("chip-selected"); });
          btn.classList.add("chip-selected");
          if (hidden) hidden.value = btn.getAttribute("data-value");
        });
      }
      setupChipGroup("asaChipGroup", "asaStatus");
      setupChipGroup("ivGaugeGroup", "ivGauge");
      setupChipGroup("ivSiteGroup", "ivSite");
      setupChipGroup("recoveryGroup", "recoveryQuality");

      // Fluids chips
      var fluidsGroup = $("fluidsModeGroup");
      var fluidRateInput = $("fluidRate");
      if (fluidsGroup && fluidRateInput) {
        fluidsGroup.addEventListener("click", function(e) {
          var btn = e.target.closest("button[data-mode]");
          if (!btn) return;
          fluidsGroup.querySelectorAll(".chip").forEach(function(c){ c.classList.remove("chip-selected"); });
          btn.classList.add("chip-selected");
          var mode = btn.getAttribute("data-mode");
          fluidRateInput.dataset.mode = mode;
          if (mode === "custom") {
            fluidRateInput.disabled = false;
            fluidRateInput.value = "";
            fluidRateInput.focus();
          } else {
            fluidRateInput.disabled = true;
            if (mode === "dog_default") fluidRateInput.value = "5";
            if (mode === "cat_default") fluidRateInput.value = "3";
            if (mode === "declined") fluidRateInput.value = "";
          }
        });
        fluidRateInput.dataset.mode = "dog_default";
        fluidRateInput.value = "5";
      }

      // Simple vs Advanced toggles
      function setupModeToggle(toggleId, simpleId, advancedId, extraIds) {
        var toggle = $(toggleId);
        var simple = $(simpleId);
        var adv = $(advancedId);
        var extra = extraIds || [];
        if (!toggle || !simple || !adv) return;
        toggle.addEventListener("click", function(e) {
          var opt = e.target.closest(".toggle-option");
          if (!opt) return;
          var mode = opt.getAttribute("data-mode");
          toggle.querySelectorAll(".toggle-option").forEach(function(o){ o.classList.remove("active"); });
          opt.classList.add("active");
          if (mode === "simple") {
            simple.classList.remove("hidden");
            adv.classList.add("hidden");
            extra.forEach(function(id){ var el=$(id); if(el) el.classList.add("hidden"); });
          } else {
            simple.classList.add("hidden");
            adv.classList.remove("hidden");
            extra.forEach(function(id){ var el=$(id); if(el) el.classList.remove("hidden"); });
          }
        });
      }
      setupModeToggle("apptModeToggle", "apptSimpleBlock", "apptAdvancedBlock");
      setupModeToggle("surgModeToggle", "surgSimpleBlock", "surgAdvancedBlock",
        ["surgAdvancedDetailCard", "surgAdvancedAnesthesiaCard"]);

      // Feedback bar
      var feedbackBar = $("feedbackBar");
      function buildMissingSummary(payload) {
        var missing = [];
        if (payload.soapType === "appointment") {
          if (payload.modeDetail === "simple" && !payload.quickNotes) {
            missing.push("quick notes");
          }
          if (payload.modeDetail === "advanced") {
            if (!payload.reason) missing.push("reason for visit");
            if (!payload.pe) missing.push("PE summary");
            if (!payload.diagnostics) missing.push("diagnostics data");
          }
        }
        if (payload.soapType === "surgery") {
          if (payload.modeDetail === "simple" && !payload.quickNotes) {
            missing.push("quick surgery notes");
          }
          if (payload.modeDetail === "advanced") {
            if (!payload.surgeryType) missing.push("surgery template");
            if (!payload.weightKg) missing.push("weight");
            if (!payload.asaStatus) missing.push("ASA status");
            if (!payload.ivGauge) missing.push("IV catheter gauge");
            if (!payload.ivSite) missing.push("IV catheter site");
            if (!payload.ettSize) missing.push("ET tube size");
          }
        }
        if (!missing.length) {
          return "Looks good. You can still refine details or re-run after adding more specifics.";
        }
        return "You can improve this SOAP by adding: " + missing.join(", ") + ".";
      }
      function showFeedback(payload) {
        if (!feedbackBar) return;
        feedbackBar.textContent = buildMissingSummary(payload);
        feedbackBar.classList.remove("hidden");
      }
      function clearFeedback() {
        if (!feedbackBar) return;
        feedbackBar.classList.add("hidden");
        feedbackBar.textContent = "";
      }

      // Appointment SOAP
      var runApptSoapBtn = $("runApptSoapBtn");
      if (runApptSoapBtn) {
        runApptSoapBtn.addEventListener("click", function() {
          var apptModeEl = document.querySelector("#apptModeToggle .toggle-option.active");
          var apptMode = apptModeEl ? apptModeEl.getAttribute("data-mode") : "simple";
          var payload = {
            soapType: "appointment",
            strictMode: $("apptStrictMode").checked,
            modeDetail: apptMode
          };
          if (apptMode === "simple") {
            payload.quickNotes = getText("apptQuickNotes");
          } else {
            payload.caseLabel = getText("apptCaseLabel");
            payload.visitType = $("apptVisitType").value;
            payload.weightKg = getText("apptWeight");
            payload.ageYears = getText("apptAgeYears");
            payload.tpr = getText("apptTPR");
            payload.reason = getText("apptReason");
            payload.history = getText("apptHistory");
            payload.pe = getText("apptPE");
            payload.diagnostics = getText("apptDiagnostics");
            payload.assessmentNotes = getText("apptAssessment");
            payload.planNotes = getText("apptPlan");
            payload.medsNotes = getText("apptMeds");
          }
          clearFeedback();
          showFeedback(payload);
          setText("soapOutput", "Generating Appointment SOAP…");
          callApiRun({ mode: "soap", payload: payload }, "apptError", function(text) {
            setText("soapOutput", text);
          });
        });
      }

      // Surgery SOAP
      var runSurgSoapBtn = $("runSurgSoapBtn");
      if (runSurgSoapBtn) {
        runSurgSoapBtn.addEventListener("click", function() {
          var surgModeEl = document.querySelector("#surgModeToggle .toggle-option.active");
          var surgMode = surgModeEl ? surgModeEl.getAttribute("data-mode") : "simple";
          var payload = {
            soapType: "surgery",
            strictMode: $("surgStrictMode").checked,
            modeDetail: surgMode
          };
          if (surgMode === "simple") {
            payload.quickNotes = getText("surgQuickNotes");
          } else {
            payload.quickMode = $("surgQuickMode").checked;
            payload.caseLabel = getText("surgCaseLabel");
            payload.species = $("surgSpecies").value;
            payload.weightKg = getText("surgWeight");
            payload.ageYears = getText("surgAgeYears");
            payload.tpr = getText("surgTPR");
            payload.surgeryType = $("surgeryType").value;
            payload.asaStatus = $("asaStatus").value;
            payload.ivGauge = $("ivGauge").value;
            payload.ivSite = $("ivSite").value;
            payload.ettSize = getText("ettSize");
            if (fluidRateInput) {
              payload.fluidsMode = fluidRateInput.dataset.mode;
              payload.fluidRate = getText("fluidRate");
            }
            payload.bolusGiven = $("bolusGiven").checked;
            payload.premeds = getText("premeds");
            payload.induction = getText("induction");
            payload.intraOpMeds = getText("intraOpMeds");
            payload.procedureNotes = getText("procedureNotes");
            payload.anesthesiaDuration = getText("anesthesiaDuration");
            payload.surgeryDuration = getText("surgeryDuration");
            payload.recoveryQuality = $("recoveryQuality").value;
            payload.recoveryNotes = getText("recoveryNotes");
            payload.postOpMeds = getText("postOpMeds");
          }
          clearFeedback();
          showFeedback(payload);
          setText("soapOutput", "Generating Surgery SOAP…");
          callApiRun({ mode: "soap", payload: payload }, "surgError", function(text) {
            setText("soapOutput", text);
          });
        });
      }

      // Copy SOAP
      var copySoapBtn = $("copySoapBtn");
      if (copySoapBtn) {
        copySoapBtn.addEventListener("click", function() {
          copyToClipboard(getText("soapOutput"));
        });
      }

      // Toolbox: bloodwork
      var runBloodworkBtn = $("runBloodworkBtn");
      if (runBloodworkBtn) {
        runBloodworkBtn.addEventListener("click", function() {
          var payload = {
            text: getText("bloodworkText"),
            detailLevel: $("bloodworkDetail").value,
            includeDiffs: $("bloodworkIncludeDiffs").checked,
            includeClientFriendly: $("bloodworkClientFriendly").checked
          };
          setText("bloodworkOutput", "Thinking about the lab work…");
          callApiRun({ mode: "toolbox-bloodwork", payload: payload }, null, function(text) {
            setText("bloodworkOutput", text);
          });
        });
      }

      var copyBloodworkOutputBtn = $("copyBloodworkOutputBtn");
      if (copyBloodworkOutputBtn) {
        copyBloodworkOutputBtn.addEventListener("click", function() {
          copyToClipboard(getText("bloodworkOutput"));
        });
      }

      var refineBloodworkBtn = $("refineBloodworkBtn");
      if (refineBloodworkBtn) {
        refineBloodworkBtn.addEventListener("click", function() {
          var existing = getText("bloodworkOutput");
          var refine = getText("bloodworkRefineInput");
          if (!existing || !refine) return;
          setText("bloodworkOutput", "Refining bloodwork summary…");
          var payload = {
            text: existing,
            detailLevel: $("bloodworkDetail").value,
            includeDiffs: $("bloodworkIncludeDiffs").checked,
            includeClientFriendly: $("bloodworkClientFriendly").checked,
            refineInstructions: refine
          };
          callApiRun({ mode: "toolbox-bloodwork", payload: payload }, null, function(text) {
            setText("bloodworkOutput", text);
          });
        });
      }

      // Toolbox: email
      var runEmailBtn = $("runEmailBtn");
      if (runEmailBtn) {
        runEmailBtn.addEventListener("click", function() {
          var payload = {
            emailType: $("emailType").value,
            petName: getText("emailPetName"),
            ownerName: getText("emailOwnerName"),
            timeframe: getText("emailTimeframe"),
            notes: getText("emailNotes")
          };
          setText("emailOutput", "Drafting email…");
          callApiRun({ mode: "toolbox-email", payload: payload }, null, function(text) {
            setText("emailOutput", text);
          });
        });
      }

      var copyEmailOutputBtn = $("copyEmailOutputBtn");
      if (copyEmailOutputBtn) {
        copyEmailOutputBtn.addEventListener("click", function() {
          copyToClipboard(getText("emailOutput"));
        });
      }

      var refineEmailBtn = $("refineEmailBtn");
      if (refineEmailBtn) {
        refineEmailBtn.addEventListener("click", function() {
          var existing = getText("emailOutput");
          var refine = getText("emailRefineInput");
          if (!existing || !refine) return;
          setText("emailOutput", "Refining email…");
          var payload = {
            emailType: $("emailType").value,
            petName: getText("emailPetName"),
            ownerName: getText("emailOwnerName"),
            timeframe: getText("emailTimeframe"),
            notes: getText("emailNotes"),
            refineInstructions: refine,
            existingDraft: existing
          };
          callApiRun({ mode: "toolbox-email", payload: payload }, null, function(text) {
            setText("emailOutput", text);
          });
        });
      }

      // Consult
      var runConsultBtn = $("runConsultBtn");
      if (runConsultBtn) {
        runConsultBtn.addEventListener("click", function() {
          var payload = { message: getText("consultMessage") };
          setText("consultOutput", "Thinking through the case…");
          callApiRun({ mode: "consult", payload: payload }, null, function(text) {
            setText("consultOutput", text);
          });
        });
      }

      // Attachments
      var fileInput = $("sharedFileInput");
      var statusEl = $("attachmentStatus");
      var previewWrapper = $("attachmentPreviewWrapper");
      var previewImg = $("attachmentPreviewImg");

      function updateAttachmentStatus(hasImage) {
        if (!statusEl) return;
        if (!hasImage) {
          statusEl.innerHTML =
            '<span class="status-pill pending">No file</span><span>Local preview only; Vision tools come later.</span>';
          if (previewWrapper) previewWrapper.classList.add("hidden");
        } else {
          statusEl.innerHTML =
            '<span class="status-pill safe">Image loaded</span><span>Used only for this session.</span>';
          if (previewWrapper) previewWrapper.classList.remove("hidden");
        }
      }
      updateAttachmentStatus(false);

      var takePhotoBtn = $("takePhotoBtn");
      if (takePhotoBtn && fileInput) {
        takePhotoBtn.addEventListener("click", function() {
          fileInput.removeAttribute("multiple");
          fileInput.setAttribute("accept", "image/*");
          fileInput.setAttribute("capture", "environment");
          fileInput.click();
        });
      }

      var uploadFileBtn = $("uploadFileBtn");
      if (uploadFileBtn && fileInput) {
        uploadFileBtn.addEventListener("click", function() {
          fileInput.removeAttribute("capture");
          fileInput.setAttribute("accept", "image/*,.pdf");
          fileInput.click();
        });
      }

      if (fileInput) {
        fileInput.addEventListener("change", function(e) {
          var file = e.target.files && e.target.files[0];
          if (!file) {
            if (previewImg) previewImg.src = "";
            updateAttachmentStatus(false);
            return;
          }
          if (file.type && file.type.indexOf("image/") === 0) {
            var reader = new FileReader();
            reader.onload = function(ev) {
              if (previewImg) previewImg.src = ev.target.result;
              updateAttachmentStatus(true);
            };
            reader.readAsDataURL(file);
          } else {
            if (previewImg) previewImg.src = "";
            updateAttachmentStatus(false);
            statusEl.innerHTML =
              '<span class="status-pill safe">File attached</span><span>PDF preview not shown; keep it local-only.</span>';
          }
        });
      }

      var clearAttachmentBtn = $("clearAttachmentBtn");
      if (clearAttachmentBtn && fileInput) {
        clearAttachmentBtn.addEventListener("click", function() {
          fileInput.value = "";
          if (previewImg) previewImg.src = "";
          updateAttachmentStatus(false);
        });
      }
    });
  </script>
</body>
</html>