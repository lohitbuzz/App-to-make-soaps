<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lohit SOAP App v1.7.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f5f7fa;
      --card-bg: #ffffff;
      --border: #d0d7e2;
      --accent: #007b5f;
      --accent-soft: #e5f5f0;
      --accent-dark: #005642;
      --text-main: #1f2933;
      --text-muted: #6b778c;
      --danger: #c92c2c;
      --radius-lg: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    h1, h2, h3, h4 {
      margin: 0;
      font-weight: 600;
    }

    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title-block small {
      color: var(--text-muted);
      font-size: 13px;
    }

    .mode-select-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
      min-width: 180px;
      font-size: 13px;
    }

    .mode-select-row-top {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .mode-select-row-bottom {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    select {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 12px;
      font-size: 14px;
      background: #fff;
      appearance: none;
    }

    .tab-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .tab-button {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 14px;
      font-size: 14px;
      background: #fff;
      cursor: pointer;
      transition: background 0.15s, color 0.15s, border-color 0.15s;
    }

    .tab-button.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .layout-main {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.3fr);
      gap: 12px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .layout-main {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 16px 18px;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.04);
    }

    .card-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .card-header-row h2 {
      font-size: 16px;
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .field-group label {
      font-weight: 500;
    }

    .field-group small {
      color: var(--text-muted);
      font-size: 12px;
    }

    input[type="text"],
    textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
    }

    textarea {
      min-height: 70px;
    }

    .btn-primary {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 10px 16px;
      background: var(--accent);
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 4px;
      transition: background 0.15s, transform 0.05s;
    }

    .btn-primary:hover {
      background: var(--accent-dark);
    }

    .btn-primary:active {
      transform: translateY(1px);
    }

    .btn-ghost,
    .btn-small,
    .btn-soft {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 12px;
      font-size: 13px;
      background: #fff;
      cursor: pointer;
      transition: background 0.15s, color 0.15s, border-color 0.15s;
    }

    .btn-ghost {
      border-color: var(--accent);
      color: var(--accent-dark);
    }

    .btn-ghost:hover {
      background: var(--accent-soft);
    }

    .btn-soft {
      background: #f9fafb;
    }

    .btn-soft:hover {
      background: #eef1f7;
    }

    .btn-small {
      padding: 4px 10px;
      font-size: 12px;
    }

    .btn-danger {
      border-color: var(--danger);
      color: var(--danger);
    }

    .btn-danger:hover {
      background: #fee;
    }

    .attachments-banner {
      grid-column: 1 / -1;
      margin-top: 4px;
    }

    .attachments-actions {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .btn-disabled-soft {
      border-radius: 999px;
      border: 1px dashed var(--border);
      padding: 6px 12px;
      font-size: 13px;
      color: var(--text-muted);
      background: #f9fafb;
      cursor: default;
    }

    .attachments-list {
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .attachments-list ul {
      margin: 4px 0 0;
      padding-left: 18px;
    }

    .attachments-list li {
      margin-bottom: 2px;
    }

    .status-text {
      font-size: 13px;
      color: var(--text-muted);
    }

    .status-text.error {
      color: var(--danger);
    }

    .output-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .output-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .output-controls label {
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .soap-split-container {
      display: none;
      margin-top: 4px;
    }

    .soap-split-container.active {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
    }

    .soap-split-container textarea {
      min-height: 60px;
    }

    .soap-split-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .feedback-block {
      margin-top: 10px;
      border-top: 1px dashed var(--border);
      padding-top: 8px;
      font-size: 13px;
    }

    .feedback-block textarea {
      min-height: 60px;
    }

    .footer-note {
      margin-top: 10px;
      font-size: 11px;
      text-align: right;
      color: var(--text-muted);
    }

    .surgery-mode-toggle {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid var(--border);
      overflow: hidden;
      font-size: 12px;
    }

    .surgery-mode-toggle button {
      border: none;
      padding: 4px 10px;
      background: transparent;
      cursor: pointer;
    }

    .surgery-mode-toggle button.active {
      background: var(--accent-soft);
      color: var(--accent-dark);
      font-weight: 600;
    }

    .accordion {
      border-top: 1px solid var(--border);
      margin-top: 6px;
      padding-top: 6px;
    }

    .accordion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      font-size: 13px;
      color: var(--text-muted);
      padding: 4px 0;
    }

    .accordion-header span {
      font-weight: 500;
    }

    .accordion-body {
      margin-top: 6px;
      display: none;
    }

    .accordion-body.open {
      display: block;
    }

    .qr-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .qr-modal.hidden {
      display: none;
    }

    .qr-modal-content {
      background: #ffffff;
      border-radius: 16px;
      padding: 16px 18px 14px;
      width: 280px;
      max-width: 90vw;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.3);
    }

    .qr-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .qr-modal-header h3 {
      font-size: 15px;
      margin: 0;
    }

    .qr-close-btn {
      border: none;
      background: transparent;
      font-size: 20px;
      line-height: 1;
      cursor: pointer;
      color: var(--text-muted);
    }

    #qrCodeContainer {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 0;
    }

    .qr-help-text {
      font-size: 12px;
      color: var(--text-muted);
      margin: 0;
      text-align: center;
    }

    .note-small {
      font-size: 11px;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="header-row">
      <div class="title-block">
        <h1>Lohit SOAP App</h1>
        <small>v1.7.0 · Appointment · Surgery · Toolbox · Consult</small>
        <div class="tab-row">
          <button class="tab-button active" data-tab="appointment" id="tabAppointment">Appointment</button>
          <button class="tab-button" data-tab="surgery" id="tabSurgery">Surgery</button>
          <button class="tab-button" data-tab="toolbox" id="tabToolbox">Toolbox</button>
          <button class="tab-button" data-tab="consult" id="tabConsult">Consult</button>
        </div>
      </div>
      <div class="mode-select-row">
        <div class="mode-select-row-top">
          <span>Mode:</span>
          <select id="modeSelect">
            <option value="Help Me">Help Me</option>
            <option value="Strict">Strict</option>
          </select>
        </div>
        <div class="mode-select-row-bottom">
          <button class="btn-soft btn-small" id="clearCaseBtn">Clear case</button>
          <button class="btn-soft btn-small btn-danger" id="clearAttachmentsBtn">Clear attachments</button>
        </div>
      </div>
    </header>

    <!-- Attachments banner (local only) -->
    <section class="card attachments-banner">
      <h2 style="font-size:15px;margin-bottom:4px;">Attachments (local only)</h2>
      <p class="note-small">
        Use this to add redacted photos / screenshots / PDFs from desktop or phone.
        For now, attachments stay on this device; upcoming versions will add Vision parsing + privacy gate.
      </p>
      <div class="attachments-actions">
        <button class="btn-ghost" id="attachmentsQrBtn">Open on phone (QR)</button>
        <button class="btn-soft btn-small" id="captureScreenBtn">Capture screen (desktop only)</button>
        <button class="btn-soft btn-small" id="uploadFileBtn">Upload file / photo</button>
      </div>
      <input type="file" id="fileInput" multiple style="display:none;" />
      <div class="attachments-list" id="attachmentsList">
        No attachments yet.
      </div>
    </section>

    <main class="layout-main">
      <!-- LEFT COLUMN: active tab content -->
      <div id="leftColumn">
        <!-- Appointment tab -->
        <section class="card" id="appointmentSection">
          <div class="card-header-row">
            <div>
              <h2>Appointment SOAP</h2>
              <div class="card-subtitle">
                Minimal inputs; brain fills standard PE and structure.
              </div>
            </div>
            <button class="btn-ghost btn-small" id="qrAppointmentBtn">Open on phone (QR)</button>
          </div>

          <div class="field-group">
            <label for="apptReason">Reason</label>
            <small>e.g., Ear infection recheck, pruritus, vomiting, wellness exam.</small>
            <input id="apptReason" type="text" />
          </div>

          <div class="field-group">
            <label for="apptHistory">History</label>
            <small>Brief history, onset, medications, relevant background.</small>
            <textarea id="apptHistory"></textarea>
          </div>

          <div class="field-group">
            <label for="apptPE">PE (findings only)</label>
            <small>Only abnormalities or notable findings. Leave blank for templated normal PE.</small>
            <textarea id="apptPE"></textarea>
          </div>

          <div class="field-group">
            <label for="apptDiagnostics">Diagnostics (data-only)</label>
            <small>CBC/chem/UA summaries, imaging impressions, cytology shorthand, etc. No interpretation here.</small>
            <textarea id="apptDiagnostics"></textarea>
          </div>

          <div class="field-group">
            <label for="apptAssessment">Assessment (optional steering)</label>
            <small>Optional: working diagnoses, problems, or differentials to steer the Plan.</small>
            <textarea id="apptAssessment"></textarea>
          </div>

          <div class="field-group">
            <label for="apptPlan">Plan (your notes)</label>
            <small>Optional: specific items you want included in the Plan (e.g., meds, recheck timing).</small>
            <textarea id="apptPlan"></textarea>
          </div>

          <div class="field-group">
            <label for="apptMeds">Meds dispensed</label>
            <small>Optional: list meds dispensed if you want to lock these in.</small>
            <textarea id="apptMeds"></textarea>
          </div>

          <button class="btn-primary" id="generateApptBtn">
            Generate SOAP (Appointment)
          </button>
        </section>

        <!-- Surgery tab -->
        <section class="card" id="surgerySection" style="display:none;">
          <div class="card-header-row">
            <div>
              <h2>Surgery SOAP</h2>
              <div class="card-subtitle">
                Simple: brain does most of the work. Advanced: use templates + notes.
              </div>
            </div>
            <button class="btn-ghost btn-small" id="qrSurgeryBtn">Open on phone (QR)</button>
          </div>

          <div class="field-group">
            <label>Surgery input mode</label>
            <div class="surgery-mode-toggle">
              <button type="button" id="sxModeSimpleBtn" class="active">Simple</button>
              <button type="button" id="sxModeAdvancedBtn">Advanced</button>
            </div>
            <small>Switch between 2–3 box simple mode and template-driven advanced mode.</small>
          </div>

          <!-- Simple surgery -->
          <div id="sxSimpleSection">
            <div class="field-group">
              <label for="sxSimpleCaseInfo">Case info</label>
              <small>Signalment, name, brief context (e.g., “rescue, obese, in heat, anxious”).</small>
              <textarea id="sxSimpleCaseInfo"></textarea>
            </div>

            <div class="field-group">
              <label for="sxSimpleProcedure">Procedure notes</label>
              <small>Key intra-op details, complications, extra procedures, anything notable.</small>
              <textarea id="sxSimpleProcedure"></textarea>
            </div>

            <div class="field-group">
              <label for="sxSimpleStyle">How should I make it?</label>
              <small>Instructions to the brain (e.g., “Use our standard rescue spay SOAP, emphasize difficult pedicles, keep Assessment short”).</small>
              <textarea id="sxSimpleStyle"></textarea>
            </div>
          </div>

          <!-- Advanced surgery -->
          <div id="sxAdvancedSection" style="display:none;">
            <div class="field-group">
              <label for="sxTemplate">Surgery template</label>
              <small>This steers the template. You can override anything with notes below.</small>
              <select id="sxTemplate">
                <option value="Canine spay – standard">Canine spay – standard</option>
                <option value="Canine neuter – standard">Canine neuter – standard</option>
                <option value="Feline spay – standard">Feline spay – standard</option>
                <option value="Feline neuter – standard">Feline neuter – standard</option>
                <option value="Dental – COHAT (with radiographs)">Dental – COHAT (with radiographs)</option>
                <option value="Dental – COHAT (no radiographs)">Dental – COHAT (no radiographs)</option>
                <option value="Mass removal – standard">Mass removal – standard</option>
                <option value="Cystotomy – standard">Cystotomy – standard</option>
                <option value="Pyometra spay">Pyometra spay</option>
                <option value="Exploratory laparotomy">Exploratory laparotomy</option>
                <option value="Enterotomy">Enterotomy</option>
                <option value="Gastrotomy">Gastrotomy</option>
                <option value="Gastropexy">Gastropexy</option>
                <option value="Feline urethral unblock">Feline urethral unblock</option>
              </select>
            </div>

            <div class="field-group">
              <label for="sxCaseLabel">Case label / notes</label>
              <small>e.g., Daisy – left TPLO, Max – dental with 308 extractions.</small>
              <input id="sxCaseLabel" type="text" />
            </div>

            <div class="field-group">
              <label for="sxProcedureNotes">Procedure notes</label>
              <small>Key intra-op details, complications, extra procedures.</small>
              <textarea id="sxProcedureNotes"></textarea>
            </div>

            <div class="field-group">
              <label for="sxRecovery">Recovery</label>
              <small>Recovery quality, dysphoria, extra sedation given, concerns, post-op instructions to emphasize.</small>
              <textarea id="sxRecovery"></textarea>
            </div>

            <div class="field-group">
              <label for="sxMeds">Meds dispensed</label>
              <small>Optional: list post-op meds dispensed if you want to lock them in.</small>
              <textarea id="sxMeds"></textarea>
            </div>
          </div>

          <button class="btn-primary" id="generateSxBtn">
            Generate SOAP (Surgery)
          </button>
        </section>

        <!-- Toolbox tab -->
        <section class="card" id="toolboxSection" style="display:none;">
          <div class="card-header-row">
            <div>
              <h2>Toolbox Lite</h2>
              <div class="card-subtitle">
                Quick helper for bloodwork blurbs, client emails, and other small text.
              </div>
            </div>
            <button class="btn-ghost btn-small" id="qrToolboxBtn">Open on phone (QR)</button>
          </div>

          <div class="field-group">
            <label for="toolSelect">Tool</label>
            <select id="toolSelect">
              <option value="Bloodwork helper">Bloodwork helper</option>
              <option value="Email helper">Email helper</option>
              <option value="Note helper">Note helper</option>
            </select>
          </div>

          <div class="field-group">
            <label for="toolContext">Context / subtype</label>
            <select id="toolContext">
              <option value="General bloodwork">General bloodwork</option>
              <option value="Urinalysis">Urinalysis</option>
              <option value="Endocrine panel">Endocrine panel</option>
              <option value="Radiology report">Radiology report (beta)</option>
              <option value="Client email – results">Client email – results</option>
              <option value="Client email – recheck">Client email – recheck</option>
              <option value="Client email – follow up">Client email – follow up</option>
              <option value="Short note / memo">Short note / memo</option>
            </select>
            <small>This just tells the brain what kind of snippet you want.</small>
          </div>

          <!-- Templates stored in browser -->
          <div class="field-group">
            <label for="templateSelect">My templates</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <select id="templateSelect" style="flex:1;">
                <option value="">(none)</option>
              </select>
              <button class="btn-small" id="loadTemplateBtn">Load</button>
            </div>
            <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap;">
              <button class="btn-ghost btn-small" id="saveTemplateBtn">Save current as template</button>
              <button class="btn-small btn-danger" id="deleteTemplateBtn">Delete selected</button>
            </div>
            <small>Templates are stored in this browser only. Great for reusable blurbs.</small>
          </div>

          <div class="field-group">
            <label for="toolboxInput">Toolbox input</label>
            <small>
              Paste lab text, write notes, or describe what you want (e.g.,
              "Short owner email explaining mildly elevated ALT").
            </small>
            <textarea id="toolboxInput"></textarea>
          </div>

          <button class="btn-primary" id="generateToolboxBtn">
            Generate (Toolbox)
          </button>

          <!-- Text from phone receiver (UI only; backend relay needed later) -->
          <div class="accordion">
            <div class="accordion-header" id="phoneReceiverHeader">
              <span>Text from phone (beta)</span>
              <span id="phoneReceiverChevron">▾</span>
            </div>
            <div class="accordion-body" id="phoneReceiverBody">
              <p class="note-small">
                Desktop-only helper to pull text from your phone (SOAP or snippets).  
                In this version, this is UI-only; a tiny backend relay will be added later.
              </p>
              <button class="btn-soft btn-small" id="startPhoneReceiveBtn">
                Receive text from phone (QR)
              </button>
              <div class="field-group" style="margin-top:8px;">
                <label for="phoneTextArea">Text from phone</label>
                <textarea id="phoneTextArea" readonly></textarea>
              </div>
              <p class="note-small">
                Once wired to backend, this will auto-fill with text sent from your phone and mirror into the Output box.
              </p>
            </div>
          </div>
        </section>

        <!-- Consult tab -->
        <section class="card" id="consultSection" style="display:none;">
          <div class="card-header-row">
            <div>
              <h2>Consult</h2>
              <div class="card-subtitle">
                Speak freely — brain responds and may produce SOAP-style text or client communication.
              </div>
            </div>
            <button class="btn-ghost btn-small" id="qrConsultBtn">Open on phone (QR)</button>
          </div>

          <div class="field-group">
            <label for="consultMessage">Message</label>
            <small>Any question, case summary, or request. e.g., "Help me explain these lab results to the owner."</small>
            <textarea id="consultMessage"></textarea>
          </div>

          <button class="btn-primary" id="generateConsultBtn">
            Ask (Consult)
          </button>
        </section>
      </div>

      <!-- RIGHT COLUMN: Status + Output -->
      <div class="right-column">
        <section class="card">
          <h2 style="font-size:15px;margin-bottom:6px;">Status</h2>
          <div id="statusMessage" class="status-text">Ready.</div>
        </section>

        <section class="card" style="margin-top:10px;">
          <div class="output-header-row">
            <h2 style="font-size:15px;">Output</h2>
            <div class="output-controls">
              <label>
                <input type="checkbox" id="splitSoapCheckbox" />
                <span>Split S / O / A / P</span>
              </label>
              <button class="btn-small" id="copyOutputBtn">Copy</button>
              <button class="btn-small" id="sendToDesktopBtn" title="Future: QR bridge to desktop">
                Send to desktop (QR)
              </button>
            </div>
          </div>

          <!-- Single combined output -->
          <textarea
            id="soapOutput"
            placeholder="Generated SOAP or toolbox text will appear here. Paste directly into Avimark."
            style="min-height:220px;"
          ></textarea>

          <!-- Split S/O/A/P view -->
          <div class="soap-split-container" id="soapSplitContainer">
            <div>
              <div class="soap-split-label">Subjective</div>
              <textarea id="subjectiveBox"></textarea>
            </div>
            <div>
              <div class="soap-split-label">Objective</div>
              <textarea id="objectiveBox"></textarea>
            </div>
            <div>
              <div class="soap-split-label">Assessment</div>
              <textarea id="assessmentBox"></textarea>
            </div>
            <div>
              <div class="soap-split-label">Plan</div>
              <textarea id="planBox"></textarea>
            </div>
          </div>

          <div class="feedback-block">
            <label for="feedbackInput" style="display:block;margin-bottom:4px;">Feedback / refine instructions</label>
            <textarea id="feedbackInput" placeholder="e.g., Shorten Assessment, keep Plan identical but add recheck in 10 days."></textarea>
            <button class="btn-soft btn-small" id="refineBtn" style="margin-top:6px;">
              Refine output
            </button>
          </div>
        </section>

        <div class="footer-note">
          Lohit SOAP App v1.7.0 · Frontend only; SOAP powered by your Render backend.
        </div>
      </div>
    </main>
  </div>

  <!-- QR modal (for open-on-phone + future flows) -->
  <div class="qr-modal hidden" id="qrModal">
    <div class="qr-modal-content">
      <div class="qr-modal-header">
        <h3 id="qrModalTitle">Open on phone</h3>
        <button class="qr-close-btn" id="qrCloseBtn">&times;</button>
      </div>
      <div id="qrCodeContainer"></div>
      <p class="qr-help-text" id="qrHelpText">
        Scan this code with your phone camera. The app will open directly to this section.
      </p>
    </div>
  </div>

  <!-- QRCode library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    // ---- CONFIG ----
    const BACKEND_URL = "https://lohit-soap-app.onrender.com/api/soap";

    // ---- GLOBAL STATE ----
    let lastPayload = null;
    let lastResultType = null; // "soap" | "snippet"
    let soapState = {
      subjective: "",
      objective: "",
      assessment: "",
      plan: ""
    };
    let lastSnippetText = "";
    let attachments = [];

    // ---- ELEMENTS ----
    const modeSelect = document.getElementById("modeSelect");
    const statusMessage = document.getElementById("statusMessage");

    const tabButtons = document.querySelectorAll(".tab-button");
    const appointmentSection = document.getElementById("appointmentSection");
    const surgerySection = document.getElementById("surgerySection");
    const toolboxSection = document.getElementById("toolboxSection");
    const consultSection = document.getElementById("consultSection");

    const clearCaseBtn = document.getElementById("clearCaseBtn");
    const clearAttachmentsBtn = document.getElementById("clearAttachmentsBtn");

    // Attachments
    const attachmentsQrBtn = document.getElementById("attachmentsQrBtn");
    const captureScreenBtn = document.getElementById("captureScreenBtn");
    const uploadFileBtn = document.getElementById("uploadFileBtn");
    const fileInput = document.getElementById("fileInput");
    const attachmentsList = document.getElementById("attachmentsList");

    // Appointment inputs
    const apptReason = document.getElementById("apptReason");
    const apptHistory = document.getElementById("apptHistory");
    const apptPE = document.getElementById("apptPE");
    const apptDiagnostics = document.getElementById("apptDiagnostics");
    const apptAssessment = document.getElementById("apptAssessment");
    const apptPlan = document.getElementById("apptPlan");
    const apptMeds = document.getElementById("apptMeds");
    const generateApptBtn = document.getElementById("generateApptBtn");

    // Surgery inputs
    const sxModeSimpleBtn = document.getElementById("sxModeSimpleBtn");
    const sxModeAdvancedBtn = document.getElementById("sxModeAdvancedBtn");
    const sxSimpleSection = document.getElementById("sxSimpleSection");
    const sxAdvancedSection = document.getElementById("sxAdvancedSection");
    const sxTemplate = document.getElementById("sxTemplate");
    const sxCaseLabel = document.getElementById("sxCaseLabel");
    const sxProcedureNotes = document.getElementById("sxProcedureNotes");
    const sxRecovery = document.getElementById("sxRecovery");
    const sxMeds = document.getElementById("sxMeds");
    const sxSimpleCaseInfo = document.getElementById("sxSimpleCaseInfo");
    const sxSimpleProcedure = document.getElementById("sxSimpleProcedure");
    const sxSimpleStyle = document.getElementById("sxSimpleStyle");
    const generateSxBtn = document.getElementById("generateSxBtn");

    // Toolbox inputs
    const toolSelect = document.getElementById("toolSelect");
    const toolContext = document.getElementById("toolContext");
    const templateSelect = document.getElementById("templateSelect");
    const saveTemplateBtn = document.getElementById("saveTemplateBtn");
    const deleteTemplateBtn = document.getElementById("deleteTemplateBtn");
    const loadTemplateBtn = document.getElementById("loadTemplateBtn");
    const toolboxInput = document.getElementById("toolboxInput");
    const generateToolboxBtn = document.getElementById("generateToolboxBtn");

    // Text from phone UI
    const phoneReceiverHeader = document.getElementById("phoneReceiverHeader");
    const phoneReceiverChevron = document.getElementById("phoneReceiverChevron");
    const phoneReceiverBody = document.getElementById("phoneReceiverBody");
    const startPhoneReceiveBtn = document.getElementById("startPhoneReceiveBtn");
    const phoneTextArea = document.getElementById("phoneTextArea");

    // Consult
    const consultMessage = document.getElementById("consultMessage");
    const generateConsultBtn = document.getElementById("generateConsultBtn");

    // Output + SOAP split
    const soapOutput = document.getElementById("soapOutput");
    const splitSoapCheckbox = document.getElementById("splitSoapCheckbox");
    const soapSplitContainer = document.getElementById("soapSplitContainer");
    const subjectiveBox = document.getElementById("subjectiveBox");
    const objectiveBox = document.getElementById("objectiveBox");
    const assessmentBox = document.getElementById("assessmentBox");
    const planBox = document.getElementById("planBox");
    const copyOutputBtn = document.getElementById("copyOutputBtn");
    const sendToDesktopBtn = document.getElementById("sendToDesktopBtn");

    // Feedback
    const feedbackInput = document.getElementById("feedbackInput");
    const refineBtn = document.getElementById("refineBtn");

    // QR buttons
    const qrModal = document.getElementById("qrModal");
    const qrModalTitle = document.getElementById("qrModalTitle");
    const qrHelpText = document.getElementById("qrHelpText");
    const qrCloseBtn = document.getElementById("qrCloseBtn");
    const qrCodeContainer = document.getElementById("qrCodeContainer");
    const qrAppointmentBtn = document.getElementById("qrAppointmentBtn");
    const qrSurgeryBtn = document.getElementById("qrSurgeryBtn");
    const qrToolboxBtn = document.getElementById("qrToolboxBtn");
    const qrConsultBtn = document.getElementById("qrConsultBtn");

    let qrInstance = null;

    // ---- TAB HANDLING ----
    function setActiveTab(tabName) {
      tabButtons.forEach((btn) => {
        const active = btn.dataset.tab === tabName;
        btn.classList.toggle("active", active);
      });

      appointmentSection.style.display = tabName === "appointment" ? "" : "none";
      surgerySection.style.display = tabName === "surgery" ? "" : "none";
      toolboxSection.style.display = tabName === "toolbox" ? "" : "none";
      consultSection.style.display = tabName === "consult" ? "" : "none";
    }

    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.tab;
        setActiveTab(tab);
        updateUrlForTab(tab);
      });
    });

    function updateUrlForTab(tab) {
      const params = new URLSearchParams(window.location.search);
      params.set("tab", tab);
      const newUrl =
        window.location.origin +
        window.location.pathname +
        "?" +
        params.toString();
      window.history.replaceState({}, "", newUrl);
    }

    // ---- ATTACHMENTS ----
    function refreshAttachmentsList() {
      if (!attachments.length) {
        attachmentsList.textContent = "No attachments yet.";
        return;
      }
      const ul = document.createElement("ul");
      attachments.forEach((att, idx) => {
        const li = document.createElement("li");
        li.textContent = `${idx + 1}. ${att.name}`;
        ul.appendChild(li);
      });
      attachmentsList.innerHTML = "";
      attachmentsList.appendChild(ul);
    }

    function addAttachment(name) {
      attachments.push({ name });
      refreshAttachmentsList();
    }

    attachmentsQrBtn.addEventListener("click", () => {
      openQrModalFor("attachments");
    });

    uploadFileBtn.addEventListener("click", () => {
      fileInput.click();
    });

    fileInput.addEventListener("change", (e) => {
      const files = Array.from(e.target.files || []);
      files.forEach((f) => addAttachment(f.name));
      if (files.length) {
        statusMessage.textContent = `Attached ${files.length} file(s). (Local only)`;
        statusMessage.classList.remove("error");
      }
      fileInput.value = "";
    });

    captureScreenBtn.addEventListener("click", async () => {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
        alert("Screen capture is not supported in this browser.");
        return;
      }
      try {
        const stream = await navigator.mediaDevices.getDisplayMedia({
          video: true
        });
        const track = stream.getVideoTracks()[0];
        const imageCapture = new ImageCapture(track);
        const bitmap = await imageCapture.grabFrame();
        track.stop();

        // Just pretend we saved it; for now we treat it as a local attachment name.
        const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
        addAttachment(`Screenshot-${timestamp}.png`);
        statusMessage.textContent = "Captured screenshot (local only).";
        statusMessage.classList.remove("error");
      } catch (e) {
        console.error(e);
        statusMessage.textContent = "Screen capture cancelled or failed.";
        statusMessage.classList.add("error");
      }
    });

    clearAttachmentsBtn.addEventListener("click", () => {
      if (!attachments.length) return;
      if (!confirm("Clear all attachments on this device?")) return;
      attachments = [];
      refreshAttachmentsList();
      statusMessage.textContent = "Attachments cleared.";
      statusMessage.classList.remove("error");
    });

    // ---- TOOLBOX TEMPLATES (localStorage) ----
    const TEMPLATE_STORAGE_KEY = "lohit_toolbox_templates_v170";

    function loadTemplatesFromStorage() {
      try {
        const raw = localStorage.getItem(TEMPLATE_STORAGE_KEY);
        if (!raw) return {};
        return JSON.parse(raw);
      } catch (e) {
        console.warn("Failed to parse templates", e);
        return {};
      }
    }

    function saveTemplatesToStorage(templates) {
      try {
        localStorage.setItem(TEMPLATE_STORAGE_KEY, JSON.stringify(templates));
      } catch (e) {
        console.warn("Failed to save templates", e);
      }
    }

    function refreshTemplateSelect() {
      const templates = loadTemplatesFromStorage();
      const selected = templateSelect.value;
      templateSelect.innerHTML = '<option value="">(none)</option>';
      Object.keys(templates).forEach((name) => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        templateSelect.appendChild(opt);
      });
      if (selected && templates[selected]) {
        templateSelect.value = selected;
      }
    }

    saveTemplateBtn.addEventListener("click", () => {
      const text = toolboxInput.value.trim();
      if (!text) {
        alert("Write something in the Toolbox input before saving as a template.");
        return;
      }
      const name = prompt("Name for this template:");
      if (!name) return;

      const templates = loadTemplatesFromStorage();
      templates[name] = {
        tool: toolSelect.value,
        context: toolContext.value,
        text,
      };
      saveTemplatesToStorage(templates);
      refreshTemplateSelect();
      templateSelect.value = name;
      statusMessage.textContent = `Saved template "${name}".`;
      statusMessage.classList.remove("error");
    });

    deleteTemplateBtn.addEventListener("click", () => {
      const name = templateSelect.value;
      if (!name) return;
      if (!confirm(`Delete template "${name}"?`)) return;

      const templates = loadTemplatesFromStorage();
      delete templates[name];
      saveTemplatesToStorage(templates);
      refreshTemplateSelect();
      toolboxInput.value = "";
      statusMessage.textContent = `Deleted template "${name}".`;
      statusMessage.classList.remove("error");
    });

    loadTemplateBtn.addEventListener("click", () => {
      const name = templateSelect.value;
      if (!name) return;
      const templates = loadTemplatesFromStorage();
      const t = templates[name];
      if (!t) return;

      toolSelect.value = t.tool || toolSelect.value;
      toolContext.value = t.context || toolContext.value;
      toolboxInput.value = t.text || "";
      statusMessage.textContent = `Loaded template "${name}".`;
      statusMessage.classList.remove("error");
    });

    // ---- SOAP OUTPUT HANDLING ----
    function parseSoapTextToState(text) {
      // naive splitter: look for headings
      const lines = text.split(/\r?\n/);
      let current = "subjective";
      const sections = {
        subjective: [],
        objective: [],
        assessment: [],
        plan: [],
      };

      lines.forEach((line) => {
        const trimmed = line.trim();
        if (/^subjective[:]/i.test(trimmed)) {
          current = "subjective";
        } else if (/^objective[:]/i.test(trimmed)) {
          current = "objective";
        } else if (/^assessment[:]/i.test(trimmed)) {
          current = "assessment";
        } else if (/^plan[:]/i.test(trimmed)) {
          current = "plan";
        }
        sections[current].push(line);
      });

      // If everything ended up in subjective and others are empty, just treat entire text as one block
      const nonEmptySections = Object.values(sections).filter(arr => arr.join("").trim().length > 0);
      if (nonEmptySections.length <= 1) {
        soapState.subjective = text.trim();
        soapState.objective = "";
        soapState.assessment = "";
        soapState.plan = "";
      } else {
        soapState.subjective = sections.subjective.join("\n").trim();
        soapState.objective = sections.objective.join("\n").trim();
        soapState.assessment = sections.assessment.join("\n").trim();
        soapState.plan = sections.plan.join("\n").trim();
      }
    }

    function buildSoapTextFromState() {
      const parts = [];
      if (soapState.subjective.trim()) {
        parts.push("Subjective:\n" + soapState.subjective.trim());
      }
      if (soapState.objective.trim()) {
        parts.push("Objective:\n" + soapState.objective.trim());
      }
      if (soapState.assessment.trim()) {
        parts.push("Assessment:\n" + soapState.assessment.trim());
      }
      if (soapState.plan.trim()) {
        parts.push("Plan:\n" + soapState.plan.trim());
      }
      return parts.join("\n\n").trim();
    }

    function renderOutput() {
      if (lastResultType === "snippet") {
        // Snippet: always single box; disable split
        splitSoapCheckbox.checked = false;
        splitSoapCheckbox.disabled = true;
        soapSplitContainer.classList.remove("active");
        soapOutput.style.display = "";
        soapOutput.value = lastSnippetText || "";
        return;
      }

      // SOAP
      splitSoapCheckbox.disabled = false;
      if (splitSoapCheckbox.checked) {
        // 4-box view
        soapSplitContainer.classList.add("active");
        soapOutput.style.display = "none";

        subjectiveBox.value = soapState.subjective || "";
        objectiveBox.value = soapState.objective || "";
        assessmentBox.value = soapState.assessment || "";
        planBox.value = soapState.plan || "";
      } else {
        // Single box combined
        soapSplitContainer.classList.remove("active");
        soapOutput.style.display = "";
        soapOutput.value = buildSoapTextFromState();
      }
    }

    splitSoapCheckbox.addEventListener("change", () => {
      // If toggling from 4-box to single, update state from boxes first
      if (!splitSoapCheckbox.checked && lastResultType === "soap") {
        soapState.subjective = subjectiveBox.value;
        soapState.objective = objectiveBox.value;
        soapState.assessment = assessmentBox.value;
        soapState.plan = planBox.value;
      }
      renderOutput();
    });

    copyOutputBtn.addEventListener("click", () => {
      let textToCopy = "";
      if (lastResultType === "snippet") {
        textToCopy = soapOutput.value;
      } else if (splitSoapCheckbox.checked) {
        // Build from 4-box view
        soapState.subjective = subjectiveBox.value;
        soapState.objective = objectiveBox.value;
        soapState.assessment = assessmentBox.value;
        soapState.plan = planBox.value;
        textToCopy = buildSoapTextFromState();
      } else {
        textToCopy = soapOutput.value;
      }
      if (!textToCopy.trim()) return;

      navigator.clipboard
        .writeText(textToCopy)
        .then(() => {
          statusMessage.textContent = "Output copied to clipboard.";
          statusMessage.classList.remove("error");
        })
        .catch(() => {
          statusMessage.textContent = "Could not copy to clipboard.";
          statusMessage.classList.add("error");
        });
    });

    // For now, Send to desktop is just a stub until backend relay is added
    sendToDesktopBtn.addEventListener("click", () => {
      statusMessage.textContent =
        "Send to desktop (QR) will be wired once the small /api/xfer relay is added to the backend.";
      statusMessage.classList.remove("error");
      alert(
        "Send to desktop (QR) is designed, but needs a tiny backend relay (/api/xfer). For now, copy from this Output box directly."
      );
    });

    // ---- BACKEND CALL HELPERS ----
    async function callBackend(payload, isRefine = false) {
      statusMessage.classList.remove("error");
      statusMessage.textContent = isRefine ? "Refining…" : "Working…";

      try {
        const resp = await fetch(BACKEND_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) {
          throw new Error("HTTP " + resp.status);
        }
        const data = await resp.json();
        const text = (data && data.text) || data.output || "";
        const feedback = data && data.feedbackSummary;

        if (!text) {
          statusMessage.textContent = "Error: no text returned from backend.";
          statusMessage.classList.add("error");
          return;
        }

        lastPayload = payload;

        // Decide if this is SOAP or snippet
        if (payload.tab === "appointment" || payload.tab === "surgery") {
          lastResultType = "soap";
          parseSoapTextToState(text);
        } else {
          lastResultType = "snippet";
          lastSnippetText = text;
        }

        renderOutput();

        if (feedback) {
          statusMessage.textContent = feedback;
        } else {
          statusMessage.textContent = isRefine ? "Refine complete." : "Done.";
        }
        statusMessage.classList.remove("error");
      } catch (e) {
        console.error(e);
        statusMessage.textContent =
          "Error contacting backend. Check Render service / API key.";
        statusMessage.classList.add("error");
      }
    }

    refineBtn.addEventListener("click", () => {
      if (!lastPayload) {
        alert("Generate something first, then refine.");
        return;
      }
      const fb = feedbackInput.value.trim();
      if (!fb) {
        alert("Add some feedback or instructions first.");
        return;
      }
      const refinePayload = {
        ...lastPayload,
        refine: true,
        feedback: fb,
      };
      callBackend(refinePayload, true);
    });

    // ---- BUTTON HANDLERS (MAIN ACTIONS) ----
    generateApptBtn.addEventListener("click", () => {
      const payload = {
        tab: "appointment",
        mode: modeSelect.value,
        source: "appointment",
        appointment: {
          reason: apptReason.value,
          history: apptHistory.value,
          peFindings: apptPE.value,
          diagnostics: apptDiagnostics.value,
          assessmentSteer: apptAssessment.value,
          planNotes: apptPlan.value,
          medsDispensed: apptMeds.value,
        },
      };
      callBackend(payload, false);
    });

    generateSxBtn.addEventListener("click", () => {
      const isSimple = sxModeSimpleBtn.classList.contains("active");
      const payload = {
        tab: "surgery",
        mode: modeSelect.value,
        source: "surgery",
        surgeryMode: isSimple ? "simple" : "advanced",
        surgery: {},
      };

      if (isSimple) {
        payload.surgery.simple = {
          caseInfo: sxSimpleCaseInfo.value,
          procedureNotes: sxSimpleProcedure.value,
          styleInstructions: sxSimpleStyle.value,
        };
      } else {
        payload.surgery.advanced = {
          template: sxTemplate.value,
          caseLabel: sxCaseLabel.value,
          procedureNotes: sxProcedureNotes.value,
          recovery: sxRecovery.value,
          medsDispensed: sxMeds.value,
        };
      }
      callBackend(payload, false);
    });

    generateToolboxBtn.addEventListener("click", () => {
      const payload = {
        tab: "toolbox",
        mode: modeSelect.value,
        source: "toolbox",
        toolbox: {
          tool: toolSelect.value,
          context: toolContext.value,
          input: toolboxInput.value,
        },
      };
      callBackend(payload, false);
    });

    generateConsultBtn.addEventListener("click", () => {
      const payload = {
        tab: "consult",
        mode: modeSelect.value,
        source: "consult",
        consult: {
          message: consultMessage.value,
        },
      };
      callBackend(payload, false);
    });

    // ---- SURGERY SIMPLE / ADVANCED TOGGLE ----
    sxModeSimpleBtn.addEventListener("click", () => {
      sxModeSimpleBtn.classList.add("active");
      sxModeAdvancedBtn.classList.remove("active");
      sxSimpleSection.style.display = "";
      sxAdvancedSection.style.display = "none";
    });

    sxModeAdvancedBtn.addEventListener("click", () => {
      sxModeAdvancedBtn.classList.add("active");
      sxModeSimpleBtn.classList.remove("active");
      sxSimpleSection.style.display = "none";
      sxAdvancedSection.style.display = "";
    });

    // ---- CLEAR CASE ----
    function clearCurrentTabInputs() {
      const activeTab = [...tabButtons].find((b) =>
        b.classList.contains("active")
      )?.dataset.tab;

      function clearTextFields(selector) {
        document.querySelectorAll(selector).forEach((el) => {
          if (el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
            el.value = "";
          }
        });
      }

      if (activeTab === "appointment") {
        clearTextFields(
          "#appointmentSection input[type='text'],#appointmentSection textarea"
        );
      } else if (activeTab === "surgery") {
        clearTextFields(
          "#surgerySection input[type='text'],#surgerySection textarea"
        );
      } else if (activeTab === "toolbox") {
        clearTextFields("#toolboxSection textarea");
      } else if (activeTab === "consult") {
        clearTextFields("#consultSection textarea");
      }

      // Clear output + feedback for all
      soapState = { subjective: "", objective: "", assessment: "", plan: "" };
      lastSnippetText = "";
      lastResultType = null;
      lastPayload = null;
      soapOutput.value = "";
      subjectiveBox.value = "";
      objectiveBox.value = "";
      assessmentBox.value = "";
      planBox.value = "";
      feedbackInput.value = "";
      statusMessage.textContent = "Case cleared.";
      statusMessage.classList.remove("error");
    }

    clearCaseBtn.addEventListener("click", clearCurrentTabInputs);

    // ---- QR HELPERS (open on phone) ----
    function buildQrUrlFor(target) {
      const base = window.location.origin + window.location.pathname;
      const params = new URLSearchParams();

      params.set("tab", target);

      if (target === "toolbox") {
        params.set("tool", toolSelect.value);
        params.set("context", toolContext.value);
      } else if (target === "surgery") {
        params.set("sxTemplate", sxTemplate.value);
      }

      return `${base}?${params.toString()}`;
    }

    function openQrModalFor(target) {
      const url = buildQrUrlFor(target);
      qrModalTitle.textContent =
        target === "attachments"
          ? "Open on phone – attachments"
          : "Open on phone – " +
            target.charAt(0).toUpperCase() +
            target.slice(1);

      qrHelpText.textContent =
        "Scan this code with your phone camera. The app will open directly to this section.";

      qrCodeContainer.innerHTML = "";
      qrInstance = new QRCode(qrCodeContainer, {
        text: url,
        width: 220,
        height: 220,
      });

      qrModal.classList.remove("hidden");
    }

    qrAppointmentBtn.addEventListener("click", () =>
      openQrModalFor("appointment")
    );
    qrSurgeryBtn.addEventListener("click", () => openQrModalFor("surgery"));
    qrToolboxBtn.addEventListener("click", () => openQrModalFor("toolbox"));
    qrConsultBtn.addEventListener("click", () => openQrModalFor("consult"));

    qrCloseBtn.addEventListener("click", () => {
      qrModal.classList.add("hidden");
      qrCodeContainer.innerHTML = "";
    });

    qrModal.addEventListener("click", (e) => {
      if (e.target === qrModal) {
        qrModal.classList.add("hidden");
        qrCodeContainer.innerHTML = "";
      }
    });

    // ---- TEXT FROM PHONE ACCORDION (UI ONLY FOR NOW) ----
    phoneReceiverHeader.addEventListener("click", () => {
      const open = phoneReceiverBody.classList.toggle("open");
      phoneReceiverChevron.textContent = open ? "▴" : "▾";
    });

    startPhoneReceiveBtn.addEventListener("click", () => {
      alert(
        "Text-from-phone QR relay is ready on the frontend. To make it live, we'll add a tiny /api/xfer relay in your backend so phone and desktop can exchange text via QR."
      );
    });

    // ---- URL PARAMS: deep links from QR ----
    function initFromUrlParams() {
      const params = new URLSearchParams(window.location.search);
      const tab = params.get("tab") || "appointment";
      setActiveTab(tab);

      const toolParam = params.get("tool");
      if (toolParam) {
        [...toolSelect.options].forEach((opt) => {
          if (opt.value === toolParam) toolSelect.value = toolParam;
        });
      }

      const contextParam = params.get("context");
      if (contextParam) {
        [...toolContext.options].forEach((opt) => {
          if (opt.value === contextParam) toolContext.value = contextParam;
        });
      }

      const sxTemplateParam = params.get("sxTemplate");
      if (sxTemplateParam) {
        [...sxTemplate.options].forEach((opt) => {
          if (opt.value === sxTemplateParam) sxTemplate.value = sxTemplateParam;
        });
      }
    }

    // ---- INIT ----
    refreshTemplateSelect();
    refreshAttachmentsList();
    initFromUrlParams();
    renderOutput();
  </script>
</body>
</html>