<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lohit SOAP App v1.6.x</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --bg-soft: #111827;
      --card: #020617;
      --accent: #14b8a6;
      --accent-soft: rgba(20, 184, 166, 0.15);
      --border: #1f2937;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --danger: #f97373;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app-shell {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px 12px 60px;
    }

    header {
      padding: 12px 16px;
      border-radius: 14px;
      background: linear-gradient(120deg, rgba(20,184,166,0.18), rgba(56,189,248,0.05));
      border: 1px solid rgba(148,163,184,0.35);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    header h1 {
      font-size: 16px;
      margin: 0;
      font-weight: 600;
    }

    header span {
      font-size: 11px;
      color: var(--text-soft);
    }

    .chip-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip {
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.8);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .chip strong {
      color: var(--accent);
      font-weight: 600;
    }

    main {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 10px;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
      .app-shell {
        padding-bottom: 72px;
      }
    }

    .pane {
      background: linear-gradient(145deg, rgba(15,23,42,0.95), rgba(3,7,18,0.98));
      border-radius: 16px;
      border: 1px solid rgba(31,41,55,0.9);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow:
        0 18px 50px rgba(0,0,0,0.7),
        inset 0 0 0 0.5px rgba(148,163,184,0.08);
    }

    .pane-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .pane-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pill {
      display: inline-flex;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 10px;
      border: 1px solid rgba(45,212,191,0.3);
    }

    .toggle-group,
    .mode-row,
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .toggle,
    .button-ghost,
    .button-main,
    .chip-toggle {
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: var(--text-soft);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s ease-out;
      white-space: nowrap;
    }

    .toggle.active,
    .chip-toggle.active {
      background: radial-gradient(circle at top left, rgba(45,212,191,0.35), rgba(15,23,42,0.98));
      color: var(--text);
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(45,212,191,0.4);
    }

    .button-main {
      background: linear-gradient(135deg, #14b8a6, #22c55e);
      border-color: rgba(34,197,94,0.9);
      color: #0b1120;
      font-weight: 600;
      padding-inline: 16px;
    }

    .button-main:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .button-ghost {
      border-style: dashed;
      opacity: 0.8;
    }

    .button-ghost.danger {
      color: var(--danger);
      border-color: rgba(239,68,68,0.7);
    }

    .field-group {
      border-radius: 12px;
      border: 1px solid rgba(31,41,55,0.9);
      background: radial-gradient(circle at top left, rgba(15,23,42,0.4), rgba(15,23,42,0.96));
      padding: 8px 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field-title-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
    }

    .field-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .field-subtitle {
      font-size: 10px;
      color: var(--text-soft);
      opacity: 0.9;
    }

    label {
      font-size: 11px;
      color: var(--text-soft);
      display: block;
      margin-bottom: 2px;
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(31,41,55,0.9);
      padding: 6px 8px;
      font-size: 11px;
      background: rgba(15,23,42,0.95);
      color: var(--text);
      outline: none;
      resize: vertical;
      min-height: 0;
    }

    textarea.small {
      min-height: 48px;
      max-height: 120px;
    }

    textarea.large {
      min-height: 120px;
      max-height: 220px;
    }

    input::placeholder,
    textarea::placeholder {
      color: var(--text-soft);
      opacity: 0.5;
    }

    input[type="file"] {
      font-size: 11px;
      color: var(--text-soft);
    }

    .hint {
      font-size: 10px;
      color: var(--text-soft);
      opacity: 0.8;
    }

    .output-card {
      border-radius: 12px;
      border: 1px solid rgba(31,41,55,0.9);
      background: radial-gradient(circle at top left, rgba(15,23,42,0.55), rgba(3,7,18,0.98));
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .output-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .output-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
    }

    .output-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .output-area {
      width: 100%;
      border-radius: 8px;
      border: 1px solid rgba(31,41,55,0.9);
      background: rgba(15,23,42,0.97);
      color: var(--text);
      font-size: 11px;
      padding: 6px 8px;
      min-height: 200px;
      resize: vertical;
      white-space: pre-wrap;
    }

    .feedback-text {
      font-size: 11px;
      color: var(--text-soft);
      white-space: pre-wrap;
    }

    .status-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      color: var(--text-soft);
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34,197,94,0.2);
    }

    .status-dot.busy {
      background: #fbbf24;
      box-shadow: 0 0 0 4px rgba(251,191,36,0.2);
    }

    .status-dot.error {
      background: #f87171;
      box-shadow: 0 0 0 4px rgba(248,113,113,0.2);
    }

    .error-text {
      font-size: 10px;
      color: var(--danger);
    }

    /* bottom tabs */
    .bottom-nav {
      position: fixed;
      bottom: 8px;
      left: 0;
      right: 0;
      max-width: 1200px;
      margin: 0 auto;
      padding: 6px 10px;
      z-index: 10;
    }

    .bottom-nav-inner {
      border-radius: 999px;
      border: 1px solid rgba(31,41,55,0.9);
      background: rgba(3,7,18,0.96);
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 4px;
      gap: 4px;
    }

    .tab-button {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 6px 8px;
      background: transparent;
      color: var(--text-soft);
      font-size: 11px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      cursor: pointer;
    }

    .tab-button span.icon {
      font-size: 14px;
    }

    .tab-button.active {
      background: radial-gradient(circle at top, rgba(45,212,191,0.35), rgba(15,23,42,0.98));
      color: var(--text);
      box-shadow: 0 0 0 1px rgba(45,212,191,0.5);
    }

    .tab-label {
      font-size: 10px;
    }

    .badge {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.5);
      color: var(--text-soft);
    }

    .badge.green {
      background: rgba(34,197,94,0.15);
      border-color: rgba(34,197,94,0.6);
      color: #bbf7d0;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div>
        <h1>Lohit SOAP App <span style="opacity:0.7;">v1.6.x</span></h1>
        <span>Appointment â€¢ Surgery â€¢ Toolbox Lite â€¢ Vision â€¢ Feedback</span>
      </div>
      <div class="chip-row">
        <div class="chip">
          <strong>Privacy:</strong> Clinic-Safe text only
        </div>
        <div class="chip">
          <strong>Vision:</strong> Screenshots / photos only
        </div>
      </div>
    </header>

    <main>
      <!-- LEFT PANE: INPUT -->
      <section class="pane" id="inputPane">
        <div class="pane-header">
          <div class="pane-title">
            Input
            <span class="pill">Doctor side</span>
          </div>
          <div class="toggle-group">
            <button class="toggle active" data-app-mode="soap" id="modeSoapBtn">SOAP</button>
            <button class="toggle" data-app-mode="toolbox" id="modeToolboxBtn">Toolbox</button>
            <button class="toggle" data-app-mode="consult" id="modeConsultBtn">Consult</button>
          </div>
        </div>

        <!-- SOAP vs Toolbox/Consult hint -->
        <div class="row">
          <span class="hint" id="modeHint">
            SOAP mode: generates full Appointment/Surgery SOAPs in Avimark format.
          </span>
        </div>

        <!-- Appointment vs Surgery (SOAP only) -->
        <div class="field-group" id="soapTypeGroup">
          <div class="field-title-row">
            <div class="field-title">Case type</div>
            <span class="field-subtitle">Appointment vs Surgery</span>
          </div>
          <div class="toggle-group">
            <button class="chip-toggle active" data-case-type="appointment" id="caseAppointmentBtn">Appointment</button>
            <button class="chip-toggle" data-case-type="surgery" id="caseSurgeryBtn">Surgery</button>
          </div>
          <div class="mode-row" id="surgeryModeRow">
            <span class="hint">Surgery layout:</span>
            <button class="chip-toggle active" id="simpleSurgeryBtn" data-surgery-mode="simple">Simple</button>
            <button class="chip-toggle" id="advancedSurgeryBtn" data-surgery-mode="advanced">Advanced</button>
          </div>
        </div>

        <!-- Strict / Help Me mode -->
        <div class="field-group">
          <div class="field-title-row">
            <div class="field-title">Brain mode</div>
            <span class="field-subtitle">How strict the AI can be</span>
          </div>
          <div class="toggle-group">
            <button class="chip-toggle" id="strictOffBtn">Help Me (default)</button>
            <button class="chip-toggle" id="strictOnBtn">Strict (no guessing)</button>
          </div>
          <span class="hint">
            Help Me = safe templated normals allowed + Feedback summary. Strict = no invention, blanks only.
          </span>
        </div>

        <!-- Basic signalment and tags -->
        <div class="field-group">
          <div class="field-title-row">
            <div class="field-title">Basics</div>
            <span class="field-subtitle">Optional but helpful</span>
          </div>
          <div class="row">
            <div style="flex:1;">
              <label for="caseLabel">Case label / Patient name (local only)</label>
              <input id="caseLabel" type="text" placeholder="eg. Milo dental, Daisy spay" />
            </div>
            <div style="width:105px;">
              <label for="species">Species</label>
              <select id="species">
                <option value="">â€”</option>
                <option>Dog</option>
                <option>Cat</option>
              </select>
            </div>
            <div style="width:90px;">
              <label for="weightKg">Weight (kg)</label>
              <input id="weightKg" type="number" step="0.1" placeholder="kg" />
            </div>
          </div>
          <div class="row">
            <div style="width:110px;">
              <label for="asa">ASA</label>
              <select id="asa">
                <option value="">â€”</option>
                <option>I</option>
                <option>II</option>
                <option>III</option>
                <option>IV</option>
                <option>V</option>
              </select>
            </div>
            <div style="flex:1;">
              <label for="tpr">TPR (optional note)</label>
              <input id="tpr" type="text" placeholder="eg. 38.6Â°C, 100 bpm, 28 rpm" />
            </div>
          </div>
        </div>

        <!-- Surgery details (simple / advanced) -->
        <div class="field-group" id="surgeryFields">
          <div class="field-title-row">
            <div class="field-title">Surgery details</div>
            <span class="field-subtitle">Only used when Case type = Surgery</span>
          </div>
          <div class="row">
            <div style="flex:1;">
              <label for="surgeryTemplate">Surgery preset</label>
              <select id="surgeryTemplate">
                <option value="">â€”</option>
                <option>Canine Spay</option>
                <option>Canine Neuter</option>
                <option>Feline Spay</option>
                <option>Feline Neuter</option>
                <option>Dental â€“ COHAT (with rads)</option>
                <option>Dental â€“ COHAT (no radiographs)</option>
                <option>Mass removal</option>
                <option>Pyometra spay</option>
                <option>Exploratory laparotomy</option>
                <option>Enterotomy</option>
                <option>Gastrotomy</option>
                <option>Gastropexy</option>
                <option>Feline urethral unblock</option>
                <option>Cystotomy</option>
              </select>
            </div>
          </div>

          <div id="surgerySimpleBlock">
            <div class="row">
              <div style="flex:1;">
                <label for="anesthesiaSummary">Anesthesia quick summary</label>
                <input id="anesthesiaSummary" type="text" placeholder="eg. Dex + But + Midaz, Propofol, Iso, fluids 5 ml/kg/hr" />
              </div>
            </div>
          </div>

          <div id="surgeryAdvancedBlock" style="display:none;">
            <div class="row">
              <div style="width:100px;">
                <label for="cathGauge">IV catheter gauge</label>
                <input id="cathGauge" type="text" placeholder="eg. 20G" />
              </div>
              <div style="flex:1;">
                <label for="cathSite">IV catheter site / side</label>
                <input id="cathSite" type="text" placeholder="eg. cephalic, left" />
              </div>
            </div>
            <div class="row">
              <div style="width:90px;">
                <label for="ettSize">ET tube</label>
                <input id="ettSize" type="text" placeholder="eg. 9.0" />
              </div>
              <div style="flex:1;">
                <label for="fluids">Fluids</label>
                <input id="fluids" type="text" placeholder="eg. LRS 5 ml/kg/hr, or declined" />
              </div>
            </div>
            <div class="row">
              <div style="flex:1;">
                <label for="premeds">Premeds (drugs + doses)</label>
                <textarea id="premeds" class="small" placeholder="eg. Dexmedetomidine [0.5 mg/ml] X mcg/kg IM, Hydromorphone [2 mg/ml] Y mg/kg IM"></textarea>
              </div>
            </div>
            <div class="row">
              <div style="flex:1;">
                <label for="induction">Induction / maintenance</label>
                <textarea id="induction" class="small" placeholder="eg. Propofol [10 mg/ml] to effect IV, Isoflurane in oxygen"></textarea>
              </div>
            </div>
            <div class="row">
              <div style="flex:1;">
                <label for="intraOpMeds">Intra-op meds</label>
                <textarea id="intraOpMeds" class="small" placeholder="eg. Meloxicam [5 mg/ml] Z mg/kg SC, additional opioids, local blocks"></textarea>
              </div>
            </div>
            <div class="row">
              <div style="flex:1;">
                <label for="postOpMeds">Post-op meds / to go home</label>
                <textarea id="postOpMeds" class="small" placeholder="eg. Gabapentin [100 mg/ml] ...; send home NSAID, etc."></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Free text + extra instructions -->
        <div class="field-group">
          <div class="field-title-row">
            <div class="field-title">Core notes</div>
            <span class="field-subtitle">What you would normally jot in the chart</span>
          </div>
          <textarea id="freeText" class="large"
            placeholder="Type or paste anything: brief history, PE snippets, treatment notes, lab results, etc.
You can also just write: 'Please make a SOAP for X' and let Vision + brain help."></textarea>
          <label for="extraText">Extra instructions to AI (optional)</label>
          <textarea id="extraText" class="small"
            placeholder="eg. Emphasize dental charting; include recheck in 7-10 days; keep language simple for a new grad."></textarea>
        </div>

        <!-- Vision upload -->
        <div class="field-group">
          <div class="field-title-row">
            <div class="field-title">Vision intake</div>
            <span class="field-subtitle">Screenshots / photos</span>
          </div>
          <label for="imageInput">Upload screenshots / photos</label>
          <input id="imageInput" type="file" accept="image/*" multiple />
          <span class="hint">Use screenshots of Avimark treatments/notes, anesthesia sheets, lab PDFs, or whiteboard photos. PDFs should be screenshotted for now.</span>
        </div>

        <!-- Run button + status -->
        <div class="row" style="justify-content: space-between; align-items: center; margin-top:4px;">
          <button class="button-main" id="generateBtn">Generate</button>
          <div class="status-row">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Ready</span>
          </div>
        </div>
        <div class="row">
          <span class="error-text" id="errorText"></span>
        </div>
      </section>

      <!-- RIGHT PANE: OUTPUT -->
      <section class="pane" id="outputPane">
        <div class="pane-header">
          <div class="pane-title">
            Output
            <span class="pill">Avimark-ready</span>
          </div>
          <span class="badge green">Copy Full SOAP â†’ paste into Avimark</span>
        </div>

        <!-- SOAP output -->
        <div class="output-card">
          <div class="output-header">
            <div class="output-title">Main output</div>
            <div class="output-actions">
              <button class="button-ghost" id="copySoapBtn">Copy full SOAP</button>
              <button class="button-ghost" id="clearOutputBtn">Clear</button>
            </div>
          </div>
          <textarea id="soapOutput" class="output-area" placeholder="Your SOAP / toolbox / consult output will appear here." readonly></textarea>
        </div>

        <!-- Feedback -->
        <div class="output-card">
          <div class="output-header">
            <div class="output-title">Feedback & next inputs</div>
          </div>
          <div class="feedback-text" id="feedbackOutput">
            After each run, the brain will summarize what was missing, what it assumed, and what you might want to add next.
          </div>
        </div>
      </section>
    </main>

    <!-- Bottom navigation -->
    <nav class="bottom-nav">
      <div class="bottom-nav-inner">
        <button class="tab-button active" id="tabSoap">
          <span class="icon">ðŸ©º</span>
          <span class="tab-label">SOAP</span>
        </button>
        <button class="tab-button" id="tabToolbox">
          <span class="icon">ðŸ§°</span>
          <span class="tab-label">Toolbox Lite</span>
        </button>
        <button class="tab-button" id="tabConsult">
          <span class="icon">ðŸ’¬</span>
          <span class="tab-label">Consult</span>
        </button>
      </div>
    </nav>
  </div>

  <script>
    // ---- State ----
    let appMode = "soap";       // "soap" | "toolbox" | "consult"
    let caseType = "appointment"; // "appointment" | "surgery"
    let surgeryMode = "simple"; // "simple" | "advanced"
    let strictMode = false;     // Help Me (false) vs Strict (true)

    // DOM helpers
    const $ = (id) => document.getElementById(id);

    const modeHintEl = $("modeHint");
    const soapTypeGroup = $("soapTypeGroup");
    const surgeryFields = $("surgeryFields");
    const surgerySimpleBlock = $("surgerySimpleBlock");
    const surgeryAdvancedBlock = $("surgeryAdvancedBlock");

    const statusDot = $("statusDot");
    const statusText = $("statusText");
    const errorText = $("errorText");
    const soapOutput = $("soapOutput");
    const feedbackOutput = $("feedbackOutput");

    const generateBtn = $("generateBtn");

    // Tabs
    const tabSoap = $("tabSoap");
    const tabToolbox = $("tabToolbox");
    const tabConsult = $("tabConsult");

    // Mode toggles
    const modeSoapBtn = $("modeSoapBtn");
    const modeToolboxBtn = $("modeToolboxBtn");
    const modeConsultBtn = $("modeConsultBtn");

    // Case toggles
    const caseAppointmentBtn = $("caseAppointmentBtn");
    const caseSurgeryBtn = $("caseSurgeryBtn");
    const simpleSurgeryBtn = $("simpleSurgeryBtn");
    const advancedSurgeryBtn = $("advancedSurgeryBtn");

    // Strict toggles
    const strictOffBtn = $("strictOffBtn");
    const strictOnBtn = $("strictOnBtn");

    // Copy buttons
    const copySoapBtn = $("copySoapBtn");
    const clearOutputBtn = $("clearOutputBtn");

    // Inputs
    const caseLabel = $("caseLabel");
    const species = $("species");
    const weightKg = $("weightKg");
    const asa = $("asa");
    const tpr = $("tpr");
    const surgeryTemplate = $("surgeryTemplate");
    const anesthesiaSummary = $("anesthesiaSummary");
    const cathGauge = $("cathGauge");
    const cathSite = $("cathSite");
    const ettSize = $("ettSize");
    const fluids = $("fluids");
    const premeds = $("premeds");
    const induction = $("induction");
    const intraOpMeds = $("intraOpMeds");
    const postOpMeds = $("postOpMeds");
    const freeText = $("freeText");
    const extraText = $("extraText");
    const imageInput = $("imageInput");

    // ---- UI state updaters ----
    function setAppMode(mode) {
      appMode = mode;
      modeSoapBtn.classList.toggle("active", mode === "soap");
      modeToolboxBtn.classList.toggle("active", mode === "toolbox");
      modeConsultBtn.classList.toggle("active", mode === "consult");

      tabSoap.classList.toggle("active", mode === "soap");
      tabToolbox.classList.toggle("active", mode === "toolbox");
      tabConsult.classList.toggle("active", mode === "consult");

      if (mode === "soap") {
        soapTypeGroup.style.display = "";
        modeHintEl.textContent = "SOAP mode: generates full Appointment/Surgery SOAPs in Avimark format.";
      } else if (mode === "toolbox") {
        soapTypeGroup.style.display = "none";
        modeHintEl.textContent = "Toolbox mode: bloodwork summaries, quick client emails/notes, mini write-ups.";
      } else {
        soapTypeGroup.style.display = "none";
        modeHintEl.textContent = "Consult mode: vet-to-vet reasoning, differentials, plan ideas.";
      }
    }

    function setCaseType(type) {
      caseType = type;
      caseAppointmentBtn.classList.toggle("active", type === "appointment");
      caseSurgeryBtn.classList.toggle("active", type === "surgery");
      surgeryFields.style.display = type === "surgery" ? "" : "none";
    }

    function setSurgeryMode(mode) {
      surgeryMode = mode;
      simpleSurgeryBtn.classList.toggle("active", mode === "simple");
      advancedSurgeryBtn.classList.toggle("active", mode === "advanced");
      surgerySimpleBlock.style.display = mode === "simple" ? "" : "none";
      surgeryAdvancedBlock.style.display = mode === "advanced" ? "" : "none";
    }

    function setStrict(flag) {
      strictMode = flag;
      strictOffBtn.classList.toggle("active", !flag);
      strictOnBtn.classList.toggle("active", flag);
    }

    function setStatus(state, message) {
      statusText.textContent = message || "";
      errorText.textContent = "";
      statusDot.classList.remove("busy", "error");
      if (state === "ready") {
        statusDot.classList.remove("busy", "error");
      } else if (state === "busy") {
        statusDot.classList.add("busy");
      } else if (state === "error") {
        statusDot.classList.add("error");
      }
    }

    function showError(msg) {
      errorText.textContent = msg || "Error.";
      setStatus("error", "Error");
    }

    // ---- Event listeners: tabs & mode toggles ----
    tabSoap.addEventListener("click", () => setAppMode("soap"));
    tabToolbox.addEventListener("click", () => setAppMode("toolbox"));
    tabConsult.addEventListener("click", () => setAppMode("consult"));

    modeSoapBtn.addEventListener("click", () => setAppMode("soap"));
    modeToolboxBtn.addEventListener("click", () => setAppMode("toolbox"));
    modeConsultBtn.addEventListener("click", () => setAppMode("consult"));

    caseAppointmentBtn.addEventListener("click", () => setCaseType("appointment"));
    caseSurgeryBtn.addEventListener("click", () => setCaseType("surgery"));

    simpleSurgeryBtn.addEventListener("click", () => setSurgeryMode("simple"));
    advancedSurgeryBtn.addEventListener("click", () => setSurgeryMode("advanced"));

    strictOffBtn.addEventListener("click", () => setStrict(false));
    strictOnBtn.addEventListener("click", () => setStrict(true));

    // ---- Copy & clear ----
    copySoapBtn.addEventListener("click", async () => {
      if (!soapOutput.value.trim()) return;
      try {
        await navigator.clipboard.writeText(soapOutput.value);
        setStatus("ready", "Copied SOAP to clipboard");
      } catch (e) {
        showError("Could not copy SOAP.");
      }
    });

    clearOutputBtn.addEventListener("click", () => {
      soapOutput.value = "";
      feedbackOutput.textContent = "Cleared. Run a new case to see fresh feedback.";
      setStatus("ready", "Ready");
      errorText.textContent = "";
    });

    // ---- Image handling (convert to data URLs) ----
    function readFilesAsDataUrls(files) {
      return Promise.all(
        Array.from(files || []).map(
          (file) =>
            new Promise((resolve) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result);
              reader.onerror = () => resolve(null);
              reader.readAsDataURL(file);
            })
        )
      ).then((results) => results.filter(Boolean));
    }

    // ---- Build formData object for the backend ----
    function collectFormData() {
      const base = {
        "Case label": caseLabel.value.trim(),
        "Species": species.value || "",
        "Weight_kg": weightKg.value || "",
        "ASA": asa.value || "",
        "TPR": tpr.value || "",
      };

      if (appMode === "soap" && caseType === "surgery") {
        base["Surgery template"] = surgeryTemplate.value || "";
        base["Surgery mode"] = surgeryMode;
        base["Anesthesia summary"] = anesthesiaSummary.value || "";
        if (surgeryMode === "advanced") {
          base["IV catheter gauge"] = cathGauge.value || "";
          base["IV catheter site"] = cathSite.value || "";
          base["ET tube"] = ettSize.value || "";
          base["Fluids"] = fluids.value || "";
          base["Premeds"] = premeds.value || "";
          base["Induction / maintenance"] = induction.value || "";
          base["Intra-op meds"] = intraOpMeds.value || "";
          base["Post-op meds / to go home"] = postOpMeds.value || "";
        }
      }

      return base;
    }

    // ---- Generate button handler ----
    generateBtn.addEventListener("click", async () => {
      try {
        setStatus("busy", "Generating...");
        generateBtn.disabled = true;

        const images = await readFilesAsDataUrls(imageInput.files);

        const payload = {
          appMode,
          caseType,
          surgeryMode,
          strictMode,
          formData: collectFormData(),
          freeText: freeText.value || "",
          extraText: extraText.value || "",
          images,
        };

        const res = await fetch("/api/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || "Response not OK");
        }

        const data = await res.json();
        if (!data.success) {
          throw new Error(data.error || "Unknown server error");
        }

        soapOutput.value = data.soap || "";
        feedbackOutput.textContent =
          data.feedback ||
          "No feedback text returned. Run again or switch to Help Me mode for more guidance.";
        setStatus("ready", "Done");
      } catch (err) {
        console.error(err);
        showError("Something went wrong generating the output.");
      } finally {
        generateBtn.disabled = false;
      }
    });

    // ---- Initial state ----
    setAppMode("soap");
    setCaseType("appointment");
    setSurgeryMode("simple");
    setStrict(false);
    setStatus("ready", "Ready");
  </script>
</body>
</html>