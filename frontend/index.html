<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lohit SOAP App v1.6.8</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Basic reset + font -->
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text",
        system-ui, -webkit-system-font, "Segoe UI", sans-serif;
      background: #f3f5f7;
      color: #111827;
    }

    h1, h2, h3, h4 {
      margin: 0;
      font-weight: 700;
      color: #0b7350;
    }

    textarea {
      width: 100%;
      min-height: 5rem;
      padding: 0.6rem 0.75rem;
      border-radius: 0.75rem;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      resize: vertical;
      background: #ffffff;
    }

    textarea:focus {
      outline: none;
      border-color: #0b7350;
      box-shadow: 0 0 0 1px #0b7350;
    }

    input[type="text"],
    select {
      width: 100%;
      padding: 0.45rem 0.6rem;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      background: #ffffff;
    }

    input[type="text"]:focus,
    select:focus {
      outline: none;
      border-color: #0b7350;
      box-shadow: 0 0 0 1px #0b7350;
    }

    button {
      font-family: inherit;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem 0.8rem 2rem;
    }

    .header-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .app-title {
      font-size: 1.3rem;
      line-height: 1.2;
    }

    .app-version {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .mode-select-row {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.85rem;
    }

    .mode-select-row label {
      font-weight: 500;
    }

    .pill-select {
      border-radius: 999px;
      padding: 0.25rem 0.75rem;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 0.85rem;
    }

    /* Tabs */
    .tabs-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 0.75rem;
    }

    .tab-button {
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .tab-button.active {
      background: #0b7350;
      color: #ffffff;
      border-color: #0b7350;
    }

    /* Layout: main + output */
    .main-layout {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    @media (min-width: 960px) {
      .main-layout {
        flex-direction: row;
        align-items: flex-start;
      }
      .left-column {
        flex: 3;
        min-width: 0;
      }
      .right-column {
        flex: 2;
        min-width: 0;
      }
    }

    .card {
      background: #ffffff;
      border-radius: 1rem;
      padding: 0.9rem 0.95rem;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
      border: 1px solid #e5e7eb;
    }

    .card + .card {
      margin-top: 0.75rem;
    }

    .card-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
    }

    .card-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: #0f172a;
    }

    .card-subtitle {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .field-label {
      font-size: 0.8rem;
      font-weight: 500;
      margin-bottom: 0.2rem;
      color: #374151;
    }

    .field-block {
      margin-bottom: 0.6rem;
    }

    /* Generate buttons */
    .primary-btn {
      width: 100%;
      padding: 0.6rem 0.75rem;
      border-radius: 999px;
      border: none;
      background: #0b7350;
      color: #ffffff;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 0.4rem;
    }

    .primary-btn:hover {
      background: #095b3e;
    }

    .primary-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .small-btn {
      padding: 0.3rem 0.65rem;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .small-btn:hover {
      background: #eef2f7;
    }

    .small-btn.danger {
      border-color: #fca5a5;
      color: #b91c1c;
    }

    /* Status + output */
    .status-text {
      font-size: 0.85rem;
      color: #374151;
    }

    .status-text.error {
      color: #b91c1c;
    }

    .output-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
    }

    .output-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
    }

    .checkbox-row {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .copy-btn {
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      border: 1px solid #0b7350;
      background: #ffffff;
      color: #0b7350;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .copy-btn:hover {
      background: #e6f5f0;
    }

    /* Attachments / placeholder uploads */
    .attachments-hint {
      font-size: 0.8rem;
      color: #4b5563;
      margin-top: 0.15rem;
    }

    .attachments-btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.45rem;
    }

    .pill-disabled {
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      border: 1px dashed #d1d5db;
      background: #f9fafb;
      color: #9ca3af;
      font-size: 0.8rem;
    }

    /* QR UI */
    .qr-row {
      margin: 0.35rem 0 0.6rem 0;
    }

    .qr-btn {
      padding: 0.3rem 0.7rem;
      border-radius: 999px;
      border: 1px solid #0b7350;
      background: #ffffff;
      color: #0b7350;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .qr-btn:hover {
      background: #e6f5f0;
    }

    .qr-modal.qr-hidden {
      display: none;
    }

    .qr-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .qr-modal-content {
      background: #ffffff;
      border-radius: 12px;
      padding: 1rem 1.25rem 1.25rem;
      max-width: 320px;
      width: 90%;
      text-align: center;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25);
      position: relative;
    }

    .qr-close {
      border: none;
      background: transparent;
      font-size: 1.3rem;
      line-height: 1;
      cursor: pointer;
      position: absolute;
      top: 6px;
      right: 10px;
    }

    .qr-hint {
      font-size: 0.8rem;
      color: #555;
      margin-top: 0.75rem;
    }

    /* Hide/show sections */
    .tool-section {
      display: none;
    }

    .tool-section.active {
      display: block;
    }

    /* Small text under fields */
    .helper-text {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.1rem;
    }
  </style>

  <!-- QR code library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
  <div class="page">
    <!-- Header -->
    <div class="header-row">
      <div>
        <div class="app-title">Lohit SOAP App</div>
        <div class="app-version">v1.6.8 • Appointment · Surgery · Toolbox · Consult</div>
      </div>

      <div class="mode-select-row">
        <label for="modeSelect">Mode:</label>
        <select id="modeSelect" class="pill-select">
          <option value="Help Me" selected>Help Me</option>
          <option value="Strict">Strict</option>
        </select>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs-row">
      <button id="tab-appointment" class="tab-button active">Appointment</button>
      <button id="tab-surgery" class="tab-button">Surgery</button>
      <button id="tab-toolbox" class="tab-button">Toolbox</button>
      <button id="tab-consult" class="tab-button">Consult</button>
    </div>

    <!-- Attachments / local only -->
    <div class="card" id="attachmentsCard">
      <div class="card-title-row">
        <div>
          <div class="card-title">Attachments (Local only)</div>
          <div class="card-subtitle">
            Use your phone or desktop to add redacted photos / screenshots.
          </div>
        </div>
      </div>
      <div class="attachments-hint">
        Always redact microchip / Lab ID / owner names before upload. For now, uploads stay
        on your device; upcoming versions will add Vision parsing and privacy gate.
      </div>
      <div class="attachments-btn-row">
        <div class="pill-disabled">Take photo (soon)</div>
        <div class="pill-disabled">Upload file (soon)</div>
      </div>
    </div>

    <div class="main-layout">
      <!-- LEFT COLUMN: tools -->
      <div class="left-column">
        <!-- Appointment -->
        <div id="appointmentSection" class="card tool-section active">
          <div class="card-title-row">
            <div>
              <div class="card-title">Appointment SOAP</div>
              <div class="card-subtitle">
                Minimal inputs; brain fills standard PE and structure.
              </div>
            </div>
          </div>

          <div class="qr-row">
            <button id="appointmentQrBtn" class="qr-btn">Open on phone (QR)</button>
          </div>

          <div class="field-block">
            <div class="field-label">Reason</div>
            <input id="apptReason" type="text"
              placeholder="e.g., Ear infection recheck, pruritus, vomiting, wellness exam" />
          </div>

          <div class="field-block">
            <div class="field-label">History</div>
            <textarea id="apptHistory"
              placeholder="Brief history, onset, medications, relevant background."></textarea>
          </div>

          <div class="field-block">
            <div class="field-label">PE (findings only)</div>
            <textarea id="apptPE"
              placeholder="Only abnormalities or notable findings. Leave blank for templated normal PE."></textarea>
          </div>

          <div class="field-block">
            <div class="field-label">Diagnostics (data-only)</div>
            <textarea id="apptDiagnostics"
              placeholder="CBC/chem/UA summaries, imaging impressions, cytology shorthand, etc. No interpretation here."></textarea>
          </div>

          <div class="field-block">
            <div class="field-label">Assessment (optional steering)</div>
            <textarea id="apptAssessment"
              placeholder="Optional: working diagnoses, problems, or differentials to steer the Plan."></textarea>
          </div>

          <div class="field-block">
            <div class="field-label">Plan (your notes)</div>
            <textarea id="apptPlan"
              placeholder="Optional: specific items you want included in the Plan section (e.g., meds, recheck timing)."></textarea>
          </div>

          <div class="field-block">
            <div class="field-label">Meds dispensed</div>
            <textarea id="apptMeds"
              placeholder="Optional: list meds dispensed if you want to lock these in."></textarea>
          </div>

          <button id="generateApptBtn" class="primary-btn">
            Generate SOAP (Appointment)
          </button>
        </div>

        <!-- Surgery -->
        <div id="surgerySection" class="card tool-section">
          <div class="card-title-row">
            <div>
              <div class="card-title">Surgery SOAP</div>
              <div class="card-subtitle">
                Choose template, then add minimal notes; brain builds full surgical SOAP.
              </div>
            </div>
          </div>

          <div class="qr-row">
            <button id="surgeryQrBtn" class="qr-btn">Open on phone (QR)</button>
          </div>

          <div class="field-block">
            <div class="field-label">Surgery template</div>
            <select id="surgeryTemplate">
              <option value="canine_spay_standard">Canine spay – standard</option>
              <option value="canine_neuter_standard">Canine neuter – standard</option>
              <option value="feline_spay_standard">Feline spay – standard</option>
              <option value="feline_neuter_standard">Feline neuter – standard</option>
              <option value="dental_cohat_no_rads">Dental – COHAT (no radiographs)</option>
              <option value="dental_cohat_with_rads">Dental – COHAT (with radiographs)</option>
              <option value="mass_removal">Mass removal</option>
              <option value="cystotomy">Cystotomy</option>
              <option value="pyometra_spay">Pyometra spay</option>
              <option value="exploratory_laparotomy">Exploratory laparotomy</option>
              <option value="enterotomy">Enterotomy</option>
              <option value="gastrotomy">Gastrotomy</option>
              <option value="gastropexy">Gastropexy</option>
              <option value="feline_urethral_unblock">Feline urethral unblock</option>
              <option value="other">Other / custom</option>
            </select>
            <div class="helper-text">
              This just steers the template. You can override anything with notes below.
            </div>
          </div>

          <div class="field-block">
            <div class="field-label">Case label / notes</div>
            <input id="surgeryLabel" type="text"
              placeholder="e.g., Daisy – left TPLO, Max – dental with 308 extractions" />
          </div>

          <div class="field-block">
            <div class="field-label">Procedure notes</div>
            <textarea id="surgeryNotes"
              placeholder="Key intra-op details, complications, extra procedures, anything not in the standard template."></textarea>
          </div>

          <div class="field-block">
            <div class="field-label">Recovery</div>
            <textarea id="surgeryRecovery"
              placeholder="Recovery quality, dysphoria, extra sedation given, concerns, post-op instructions to emphasize."></textarea>
          </div>

          <div class="field-block">
            <div class="field-label">Meds dispensed</div>
            <textarea id="surgeryMeds"
              placeholder="Optional: list post-op meds dispensed if you want to lock them in."></textarea>
          </div>

          <button id="generateSurgeryBtn" class="primary-btn">
            Generate SOAP (Surgery)
          </button>
        </div>

        <!-- Toolbox -->
        <div id="toolboxSection" class="card tool-section">
          <div class="card-title-row">
            <div>
              <div class="card-title">Toolbox Lite</div>
              <div class="card-subtitle">
                Quick helper for bloodwork blurbs, client emails, and other small text.
              </div>
            </div>
          </div>

          <div class="qr-row">
            <button id="toolboxQrBtn" class="qr-btn">Open on phone (QR)</button>
          </div>

          <div class="field-block">
            <div class="field-label">Tool</div>
            <select id="toolboxTool">
              <option value="bloodwork_helper">Bloodwork helper</option>
              <option value="email_helper">Email / client communication</option>
              <option value="handout_helper">Client handout helper</option>
              <option value="freeform_helper">Free-form text helper</option>
            </select>
          </div>

          <div class="field-block">
            <div class="field-label">Context / subtype</div>
            <select id="toolboxSubtype">
              <option value="general_bloodwork">General bloodwork</option>
              <option value="urinalysis">Urinalysis</option>
              <option value="radiology_report">Radiology report</option>
              <option value="endocrine_panel">Endocrine panel</option>
              <option value="owner_email">Owner email</option>
              <option value="brief_update">Brief update / text-style</option>
              <option value="handout_general">General handout</option>
              <option value="behavior">Behavior / anxiety</option>
              <option value="freeform">Free-form</option>
            </select>
            <div class="helper-text">
              This just tells the brain what kind of snippet you want.
            </div>
          </div>

          <!-- Templates row -->
          <div class="field-block">
            <div class="field-label">My templates</div>
            <div style="display:flex; gap:0.4rem; align-items:center; flex-wrap:wrap;">
              <select id="toolboxTemplateSelect" style="flex:1; min-width:140px;">
                <option value="">(none)</option>
              </select>
              <button id="toolboxLoadTemplateBtn" class="small-btn">Load</button>
            </div>
            <div style="display:flex; gap:0.4rem; margin-top:0.35rem; flex-wrap:wrap;">
              <button id="toolboxSaveTemplateBtn" class="small-btn">
                Save current as template
              </button>
              <button id="toolboxDeleteTemplateBtn" class="small-btn danger">
                Delete selected
              </button>
            </div>
            <div class="helper-text">
              Templates are stored in this browser only. Great for reusable blurbs.
            </div>
          </div>

          <div class="field-block">
            <div class="field-label">Toolbox input</div>
            <textarea id="toolboxInput"
              placeholder="Paste lab text, write notes, or describe what you want (e.g., &quot;Short owner email explaining mildly elevated ALT&quot;)."></textarea>
          </div>

          <button id="generateToolboxBtn" class="primary-btn">
            Generate (Toolbox)
          </button>
        </div>

        <!-- Consult -->
        <div id="consultSection" class="card tool-section">
          <div class="card-title-row">
            <div>
              <div class="card-title">Consult</div>
              <div class="card-subtitle">
                Speak freely &mdash; brain responds and may produce SOAP-style text.
              </div>
            </div>
          </div>

          <div class="qr-row">
            <button id="consultQrBtn" class="qr-btn">Open on phone (QR)</button>
          </div>

          <div class="field-block">
            <div class="field-label">Message</div>
            <textarea id="consultInput"
              placeholder="Any question, case summary, or request. e.g., &quot;Help me explain these lab results to the owner.&quot;"></textarea>
          </div>

          <button id="generateConsultBtn" class="primary-btn">
            Ask (Consult)
          </button>
        </div>
      </div>

      <!-- RIGHT COLUMN: Status + Output -->
      <div class="right-column">
        <div class="card">
          <div class="card-title-row">
            <div class="card-title">Status</div>
          </div>
          <div id="statusText" class="status-text">
            Ready.
          </div>
        </div>

        <div class="card" style="margin-top:0.75rem;">
          <div class="output-header-row">
            <div class="card-title">Output</div>
            <div class="output-controls">
              <label class="checkbox-row">
                <input type="checkbox" id="splitSoapCheckbox" />
                <span>Split into S / O / A / P</span>
              </label>
              <button id="copyOutputBtn" class="copy-btn">Copy</button>
            </div>
          </div>
          <textarea id="outputTextarea"
            placeholder="Generated SOAP or toolbox text will appear here. Paste directly into Avimark."></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- Shared QR modal -->
  <div id="qrModal" class="qr-modal qr-hidden">
    <div class="qr-modal-content">
      <button id="qrCloseBtn" class="qr-close" aria-label="Close QR dialog">×</button>
      <h3 id="qrTitle">Open on your phone</h3>
      <canvas id="qrCanvas"></canvas>
      <p class="qr-hint">
        Open the camera on your phone and point it at this code. It will open this app directly on that tool.
      </p>
    </div>
  </div>

  <!-- App JS -->
  <script>
    // CHANGE ONLY IF YOUR BACKEND URL CHANGES
    const BACKEND_URL = "https://lohit-soap-app.onrender.com";

    // --------------- Helpers ---------------
    function setStatus(message, isError = false) {
      const el = document.getElementById("statusText");
      if (!el) return;
      el.textContent = message;
      el.classList.toggle("error", !!isError);
    }

    function setOutput(text) {
      const el = document.getElementById("outputTextarea");
      if (el) el.value = text || "";
    }

    function getMode() {
      const sel = document.getElementById("modeSelect");
      return sel ? sel.value || "Help Me" : "Help Me";
    }

    // --------------- Tabs ---------------
    (function setupTabs() {
      const tabs = [
        { id: "tab-appointment", sectionId: "appointmentSection", key: "appointment" },
        { id: "tab-surgery", sectionId: "surgerySection", key: "surgery" },
        { id: "tab-toolbox", sectionId: "toolboxSection", key: "toolbox" },
        { id: "tab-consult", sectionId: "consultSection", key: "consult" },
      ];

      function activateTab(key) {
        tabs.forEach((tab) => {
          const btn = document.getElementById(tab.id);
          const sec = document.getElementById(tab.sectionId);
          if (!btn || !sec) return;
          const isActive = tab.key === key;
          btn.classList.toggle("active", isActive);
          sec.classList.toggle("active", isActive);
        });

        // Update hash so QR can point to this
        const params = new URLSearchParams();
        params.set("tool", key);
        window.location.hash = params.toString();
      }

      tabs.forEach((tab) => {
        const btn = document.getElementById(tab.id);
        if (btn) {
          btn.addEventListener("click", () => activateTab(tab.key));
        }
      });

      // On load, check hash
      window.addEventListener("load", () => {
        const hash = window.location.hash.replace("#", "");
        if (!hash) return;
        const params = new URLSearchParams(hash);
        const tool = params.get("tool");
        if (tool && tabs.some((t) => t.key === tool)) {
          activateTab(tool);
        }
      });
    })();

    // --------------- Appointment SOAP ---------------
    (function setupAppointment() {
      const btn = document.getElementById("generateApptBtn");
      if (!btn) return;

      btn.addEventListener("click", async () => {
        const reason = document.getElementById("apptReason").value.trim();
        const history = document.getElementById("apptHistory").value.trim();
        const pe = document.getElementById("apptPE").value.trim();
        const diagnostics = document.getElementById("apptDiagnostics").value.trim();
        const assessment = document.getElementById("apptAssessment").value.trim();
        const planNotes = document.getElementById("apptPlan").value.trim();
        const meds = document.getElementById("apptMeds").value.trim();
        const mode = getMode();

        setStatus("Generating appointment SOAP...");
        setOutput("");

        try {
          const res = await fetch(BACKEND_URL + "/api/soap", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              type: "appointment",
              mode,
              reason,
              history,
              peFindings: pe,
              diagnostics,
              assessmentNotes: assessment,
              planNotes,
              medsDispensed: meds,
            }),
          });

          if (!res.ok) {
            throw new Error("HTTP " + res.status);
          }
          const data = await res.json();
          if (!data || !data.text) {
            setStatus("Error: no text returned from backend.", true);
            return;
          }
          setOutput(data.text);
          setStatus("Done.");
        } catch (err) {
          console.error(err);
          setStatus("Error contacting backend for appointment SOAP.", true);
        }
      });
    })();

    // --------------- Surgery SOAP ---------------
    (function setupSurgery() {
      const btn = document.getElementById("generateSurgeryBtn");
      if (!btn) return;

      btn.addEventListener("click", async () => {
        const template = document.getElementById("surgeryTemplate").value;
        const label = document.getElementById("surgeryLabel").value.trim();
        const notes = document.getElementById("surgeryNotes").value.trim();
        const recovery = document.getElementById("surgeryRecovery").value.trim();
        const meds = document.getElementById("surgeryMeds").value.trim();
        const mode = getMode();

        setStatus("Generating surgery SOAP...");
        setOutput("");

        try {
          const res = await fetch(BACKEND_URL + "/api/soap", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              type: "surgery",
              mode,
              template,
              caseLabel: label,
              procedureNotes: notes,
              recoveryNotes: recovery,
              medsDispensed: meds,
            }),
          });

          if (!res.ok) {
            throw new Error("HTTP " + res.status);
          }
          const data = await res.json();
          if (!data || !data.text) {
            setStatus("Error: no text returned from backend.", true);
            return;
          }
          setOutput(data.text);
          setStatus("Done.");
        } catch (err) {
          console.error(err);
          setStatus("Error contacting backend for surgery SOAP.", true);
        }
      });
    })();

    // --------------- Toolbox templates (localStorage) ---------------
    const TOOLBOX_TEMPLATES_KEY = "lohit_toolbox_templates_v1";

    function loadToolboxTemplates() {
      try {
        const raw = localStorage.getItem(TOOLBOX_TEMPLATES_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed;
      } catch (e) {
        console.warn("Error reading toolbox templates:", e);
        return [];
      }
    }

    function saveToolboxTemplates(list) {
      try {
        localStorage.setItem(TOOLBOX_TEMPLATES_KEY, JSON.stringify(list || []));
      } catch (e) {
        console.warn("Error saving toolbox templates:", e);
      }
    }

    function refreshToolboxTemplateSelect() {
      const select = document.getElementById("toolboxTemplateSelect");
      if (!select) return;
      const templates = loadToolboxTemplates();
      const current = select.value;
      select.innerHTML = "";
      const noneOpt = document.createElement("option");
      noneOpt.value = "";
      noneOpt.textContent = "(none)";
      select.appendChild(noneOpt);

      templates.forEach((tpl, index) => {
        const opt = document.createElement("option");
        opt.value = String(index);
        opt.textContent = tpl.name || "Template " + (index + 1);
        select.appendChild(opt);
      });

      if (current && select.querySelector(`option[value="${current}"]`)) {
        select.value = current;
      } else {
        select.value = "";
      }
    }

    // --------------- Toolbox ---------------
    (function setupToolbox() {
      const generateBtn = document.getElementById("generateToolboxBtn");
      if (!generateBtn) return;

      const toolSel = document.getElementById("toolboxTool");
      const subtypeSel = document.getElementById("toolboxSubtype");
      const inputEl = document.getElementById("toolboxInput");
      const tmplSelect = document.getElementById("toolboxTemplateSelect");
      const saveBtn = document.getElementById("toolboxSaveTemplateBtn");
      const deleteBtn = document.getElementById("toolboxDeleteTemplateBtn");
      const loadBtn = document.getElementById("toolboxLoadTemplateBtn");

      refreshToolboxTemplateSelect();

      saveBtn.addEventListener("click", () => {
        const text = (inputEl.value || "").trim();
        if (!text) {
          alert("Enter some Toolbox input first to save as a template.");
          return;
        }
        const name = prompt("Template name (e.g., 'ALT mildly high email'):");
        if (!name) return;

        const templates = loadToolboxTemplates();
        templates.push({
          name,
          tool: toolSel.value,
          subtype: subtypeSel.value,
          text,
        });
        saveToolboxTemplates(templates);
        refreshToolboxTemplateSelect();
      });

      deleteBtn.addEventListener("click", () => {
        const idx = tmplSelect.value;
        if (!idx) {
          alert("Select a template to delete.");
          return;
        }
        const templates = loadToolboxTemplates();
        const index = parseInt(idx, 10);
        if (isNaN(index) || index < 0 || index >= templates.length) return;
        if (!confirm("Delete selected template?")) return;
        templates.splice(index, 1);
        saveToolboxTemplates(templates);
        refreshToolboxTemplateSelect();
      });

      loadBtn.addEventListener("click", () => {
        const idx = tmplSelect.value;
        if (!idx) {
          alert("Select a template to load.");
          return;
        }
        const templates = loadToolboxTemplates();
        const index = parseInt(idx, 10);
        if (isNaN(index) || index < 0 || index >= templates.length) return;
        const tpl = templates[index];
        if (tpl.tool) toolSel.value = tpl.tool;
        if (tpl.subtype) subtypeSel.value = tpl.subtype;
        if (tpl.text) inputEl.value = tpl.text;
      });

      generateBtn.addEventListener("click", async () => {
        const tool = toolSel.value;
        const subtype = subtypeSel.value;
        const input = (inputEl.value || "").trim();
        const mode = getMode();

        if (!input) {
          if (!confirm("Input is empty. Generate anyway?")) return;
        }

        setStatus("Generating toolbox output...");
        setOutput("");

        try {
          const res = await fetch(BACKEND_URL + "/api/toolbox", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              mode,
              tool,
              subtype,
              input,
            }),
          });

          if (!res.ok) throw new Error("HTTP " + res.status);
          const data = await res.json();
          if (!data || !data.text) {
            setStatus("Error: no text returned from backend.", true);
            return;
          }
          setOutput(data.text);
          setStatus("Done.");
        } catch (err) {
          console.error(err);
          setStatus("Error contacting backend for toolbox.", true);
        }
      });
    })();

    // --------------- Consult ---------------
    (function setupConsult() {
      const btn = document.getElementById("generateConsultBtn");
      if (!btn) return;
      const inputEl = document.getElementById("consultInput");

      btn.addEventListener("click", async () => {
        const question = (inputEl.value || "").trim();
        const mode = getMode();
        if (!question) {
          alert("Type a message for your consult first.");
          return;
        }

        setStatus("Thinking about consult...");
        setOutput("");

        try {
          const res = await fetch(BACKEND_URL + "/api/consult", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              mode,
              question,
            }),
          });

          if (!res.ok) throw new Error("HTTP " + res.status);
          const data = await res.json();
          if (!data || !data.text) {
            setStatus("Error: no text returned from backend.", true);
            return;
          }
          setOutput(data.text);
          setStatus("Done.");
        } catch (err) {
          console.error(err);
          setStatus("Error contacting backend for consult.", true);
        }
      });
    })();

    // --------------- Copy output ---------------
    (function setupCopy() {
      const btn = document.getElementById("copyOutputBtn");
      const textarea = document.getElementById("outputTextarea");
      if (!btn || !textarea) return;

      btn.addEventListener("click", async () => {
        const text = textarea.value;
        if (!text) {
          alert("Nothing to copy yet.");
          return;
        }
        try {
          await navigator.clipboard.writeText(text);
          btn.textContent = "Copied";
          setTimeout(() => (btn.textContent = "Copy"), 1500);
        } catch (e) {
          console.warn("Clipboard error:", e);
          alert("Could not copy to clipboard; please select text manually.");
        }
      });
    })();

    // --------------- QR per tool ---------------
    (function setupQR() {
      const qrModal = document.getElementById("qrModal");
      const qrCanvas = document.getElementById("qrCanvas");
      const qrTitle = document.getElementById("qrTitle");
      const qrCloseBtn = document.getElementById("qrCloseBtn");

      if (!qrModal || !qrCanvas || !window.QRCode) {
        console.warn("QR modal or QRCode library not found; skipping QR setup.");
        return;
      }

      function toolLabel(tool) {
        switch (tool) {
          case "appointment":
            return "Appointment";
          case "surgery":
            return "Surgery";
          case "toolbox":
            return "Toolbox";
          case "consult":
            return "Consult";
          default:
            return "SOAP";
        }
      }

      function openQr(tool) {
        const hash = "#tool=" + encodeURIComponent(tool);
        const url = window.location.origin + window.location.pathname + hash;

        qrTitle.textContent = "Open " + toolLabel(tool) + " on your phone";
        qrModal.classList.remove("qr-hidden");

        QRCode.toCanvas(qrCanvas, url, { width: 220 }, function (err) {
          if (err) {
            console.error("QR error:", err);
          }
        });
      }

      const mapping = {
        appointmentQrBtn: "appointment",
        surgeryQrBtn: "surgery",
        toolboxQrBtn: "toolbox",
        consultQrBtn: "consult",
      };

      Object.keys(mapping).forEach((btnId) => {
        const btn = document.getElementById(btnId);
        if (btn) {
          btn.addEventListener("click", () => openQr(mapping[btnId]));
        }
      });

      if (qrCloseBtn) {
        qrCloseBtn.addEventListener("click", () => {
          qrModal.classList.add("qr-hidden");
        });
      }

      qrModal.addEventListener("click", (e) => {
        if (e.target === qrModal) {
          qrModal.classList.add("qr-hidden");
        }
      });
    })();
  </script>
</body>
</html>
