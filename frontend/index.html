<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lohit SOAP App v1.6.8</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f5f7fa;
      --card-bg: #ffffff;
      --border: #d0d7e2;
      --accent: #007b5f;
      --accent-soft: #e5f5f0;
      --accent-dark: #005642;
      --text-main: #1f2933;
      --text-muted: #6b778c;
      --danger: #c92c2c;
      --radius-lg: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    h1, h2, h3, h4 {
      margin: 0;
      font-weight: 600;
    }

    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title-block small {
      color: var(--text-muted);
      font-size: 13px;
    }

    .mode-select-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    select {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 12px;
      font-size: 14px;
      background: #fff;
      appearance: none;
    }

    .tab-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .tab-button {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 14px;
      font-size: 14px;
      background: #fff;
      cursor: pointer;
      transition: background 0.15s, color 0.15s, border-color 0.15s;
    }

    .tab-button.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .layout-main {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.3fr);
      gap: 12px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .layout-main {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 16px 18px;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.04);
    }

    .card-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .card-header-row h2 {
      font-size: 16px;
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .field-group label {
      font-weight: 500;
    }

    .field-group small {
      color: var(--text-muted);
      font-size: 12px;
    }

    input[type="text"],
    textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
    }

    textarea {
      min-height: 70px;
    }

    .btn-primary {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 10px 16px;
      background: var(--accent);
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 4px;
      transition: background 0.15s, transform 0.05s;
    }

    .btn-primary:hover {
      background: var(--accent-dark);
    }

    .btn-primary:active {
      transform: translateY(1px);
    }

    .btn-ghost {
      border-radius: 999px;
      border: 1px solid var(--accent);
      padding: 6px 12px;
      background: transparent;
      color: var(--accent-dark);
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
    }

    .btn-ghost:hover {
      background: var(--accent-soft);
    }

    .attachments-banner {
      grid-column: 1 / -1;
      margin-top: 4px;
    }

    .attachments-banner p {
      margin: 0;
      font-size: 13px;
    }

    .attachments-actions {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .btn-disabled-soft {
      border-radius: 999px;
      border: 1px dashed var(--border);
      padding: 6px 12px;
      font-size: 13px;
      color: var(--text-muted);
      background: #f9fafb;
      cursor: default;
    }

    .status-text {
      font-size: 13px;
      color: var(--text-muted);
    }

    .status-text.error {
      color: var(--danger);
    }

    .output-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .output-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
    }

    .output-controls label {
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .btn-small {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 4px 10px;
      font-size: 12px;
      background: #fff;
      cursor: pointer;
    }

    .footer-note {
      margin-top: 10px;
      font-size: 11px;
      text-align: right;
      color: var(--text-muted);
    }

    /* QR modal */

    .qr-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .qr-modal.hidden {
      display: none;
    }

    .qr-modal-content {
      background: #ffffff;
      border-radius: 16px;
      padding: 16px 18px 14px;
      width: 280px;
      max-width: 90vw;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.3);
    }

    .qr-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .qr-modal-header h3 {
      font-size: 15px;
      margin: 0;
    }

    .qr-close-btn {
      border: none;
      background: transparent;
      font-size: 20px;
      line-height: 1;
      cursor: pointer;
      color: var(--text-muted);
    }

    #qrCodeContainer {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 0;
    }

    .qr-help-text {
      font-size: 12px;
      color: var(--text-muted);
      margin: 0;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="header-row">
      <div class="title-block">
        <h1>Lohit SOAP App</h1>
        <small>v1.6.8 · Appointment · Surgery · Toolbox · Consult</small>
        <div class="tab-row">
          <button class="tab-button active" data-tab="appointment" id="tabAppointment">
            Appointment
          </button>
          <button class="tab-button" data-tab="surgery" id="tabSurgery">
            Surgery
          </button>
          <button class="tab-button" data-tab="toolbox" id="tabToolbox">
            Toolbox
          </button>
          <button class="tab-button" data-tab="consult" id="tabConsult">
            Consult
          </button>
        </div>
      </div>
      <div class="mode-select-row">
        <span>Mode:</span>
        <select id="modeSelect">
          <option value="Help Me">Help Me</option>
          <option value="Strict">Strict</option>
        </select>
      </div>
    </header>

    <!-- Attachments banner (local only) -->
    <section class="card attachments-banner">
      <h2 style="font-size:15px;margin-bottom:4px;">Attachments (Local only)</h2>
      <p>
        Use your phone or desktop to add redacted photos / screenshots.
        Always redact microchip / Lab ID / owner names before upload.
        For now, uploads stay on your device; upcoming versions will add Vision parsing and a privacy gate.
      </p>
      <div class="attachments-actions">
        <button class="btn-ghost" id="attachmentsQrBtn">Open on phone (QR)</button>
        <button class="btn-disabled-soft">Take photo (soon)</button>
        <button class="btn-disabled-soft">Upload file (soon)</button>
      </div>
    </section>

    <main class="layout-main">
      <!-- LEFT COLUMN: active tab content -->
      <div id="leftColumn">
        <!-- Appointment tab -->
        <section class="card" id="appointmentSection">
          <div class="card-header-row">
            <div>
              <h2>Appointment SOAP</h2>
              <div class="card-subtitle">
                Minimal inputs; brain fills standard PE and structure.
              </div>
            </div>
            <button class="btn-ghost" id="qrAppointmentBtn">Open on phone (QR)</button>
          </div>

          <div class="field-group">
            <label for="apptReason">Reason</label>
            <small>e.g., Ear infection recheck, pruritus, vomiting, wellness exam.</small>
            <input id="apptReason" type="text" />
          </div>

          <div class="field-group">
            <label for="apptHistory">History</label>
            <small>Brief history, onset, medications, relevant background.</small>
            <textarea id="apptHistory"></textarea>
          </div>

          <div class="field-group">
            <label for="apptPE">PE (findings only)</label>
            <small>Only abnormalities or notable findings. Leave blank for templated normal PE.</small>
            <textarea id="apptPE"></textarea>
          </div>

          <div class="field-group">
            <label for="apptDiagnostics">Diagnostics (data-only)</label>
            <small>CBC/chem/UA summaries, imaging impressions, cytology shorthand, etc. No interpretation here.</small>
            <textarea id="apptDiagnostics"></textarea>
          </div>

          <div class="field-group">
            <label for="apptAssessment">Assessment (optional steering)</label>
            <small>Optional: working diagnoses, problems, or differentials to steer the Plan.</small>
            <textarea id="apptAssessment"></textarea>
          </div>

          <div class="field-group">
            <label for="apptPlan">Plan (your notes)</label>
            <small>Optional: any specific items you want included in the Plan (e.g., meds, recheck timing).</small>
            <textarea id="apptPlan"></textarea>
          </div>

          <div class="field-group">
            <label for="apptMeds">Meds dispensed</label>
            <small>Optional: list meds dispensed if you want to lock these in.</small>
            <textarea id="apptMeds"></textarea>
          </div>

          <button class="btn-primary" id="generateApptBtn">
            Generate SOAP (Appointment)
          </button>
        </section>

        <!-- Surgery tab -->
        <section class="card" id="surgerySection" style="display:none;">
          <div class="card-header-row">
            <div>
              <h2>Surgery SOAP</h2>
              <div class="card-subtitle">
                Choose template, then add minimal notes; brain builds full surgical SOAP.
              </div>
            </div>
            <button class="btn-ghost" id="qrSurgeryBtn">Open on phone (QR)</button>
          </div>

          <div class="field-group">
            <label for="sxTemplate">Surgery template</label>
            <small>This steers the template. You can override anything with notes below.</small>
            <select id="sxTemplate">
              <option value="Canine spay – standard">Canine spay – standard</option>
              <option value="Canine neuter – standard">Canine neuter – standard</option>
              <option value="Feline spay – standard">Feline spay – standard</option>
              <option value="Feline neuter – standard">Feline neuter – standard</option>
              <option value="Dental – COHAT (with radiographs)">Dental – COHAT (with radiographs)</option>
              <option value="Dental – COHAT (no radiographs)">Dental – COHAT (no radiographs)</option>
              <option value="Mass removal – standard">Mass removal – standard</option>
              <option value="Cystotomy – standard">Cystotomy – standard</option>
              <option value="Pyometra spay">Pyometra spay</option>
              <option value="Exploratory laparotomy">Exploratory laparotomy</option>
              <option value="Enterotomy">Enterotomy</option>
              <option value="Gastrotomy">Gastrotomy</option>
              <option value="Gastropexy">Gastropexy</option>
              <option value="Feline urethral unblock">Feline urethral unblock</option>
            </select>
          </div>

          <div class="field-group">
            <label for="sxCaseLabel">Case label / notes</label>
            <small>e.g., Daisy – left TPLO, Max – dental with 308 extractions.</small>
            <input id="sxCaseLabel" type="text" />
          </div>

          <div class="field-group">
            <label for="sxProcedureNotes">Procedure notes</label>
            <small>Key intra-op details, complications, extra procedures, anything not in the standard template.</small>
            <textarea id="sxProcedureNotes"></textarea>
          </div>

          <div class="field-group">
            <label for="sxRecovery">Recovery</label>
            <small>Recovery quality, dysphoria, extra sedation given, concerns, post-op instructions to emphasize.</small>
            <textarea id="sxRecovery"></textarea>
          </div>

          <div class="field-group">
            <label for="sxMeds">Meds dispensed</label>
            <small>Optional: list post-op meds dispensed if you want to lock them in.</small>
            <textarea id="sxMeds"></textarea>
          </div>

          <button class="btn-primary" id="generateSxBtn">
            Generate SOAP (Surgery)
          </button>
        </section>

        <!-- Toolbox tab -->
        <section class="card" id="toolboxSection" style="display:none;">
          <div class="card-header-row">
            <div>
              <h2>Toolbox Lite</h2>
              <div class="card-subtitle">
                Quick helper for bloodwork blurbs, client emails, and other small text.
              </div>
            </div>
            <button class="btn-ghost" id="qrToolboxBtn">Open on phone (QR)</button>
          </div>

          <div class="field-group">
            <label for="toolSelect">Tool</label>
            <select id="toolSelect">
              <option value="Bloodwork helper">Bloodwork helper</option>
              <option value="Email helper">Email helper</option>
              <option value="Note helper">Note helper</option>
            </select>
          </div>

          <div class="field-group">
            <label for="toolContext">Context / subtype</label>
            <select id="toolContext">
              <option value="General bloodwork">General bloodwork</option>
              <option value="Urinalysis">Urinalysis</option>
              <option value="Endocrine panel">Endocrine panel</option>
              <option value="Radiology report">Radiology report (beta)</option>
              <option value="Client email – results">Client email – results</option>
              <option value="Client email – recheck">Client email – recheck</option>
              <option value="Client email – follow up">Client email – follow up</option>
              <option value="Short note / memo">Short note / memo</option>
            </select>
            <small>This just tells the brain what kind of snippet you want.</small>
          </div>

          <!-- Templates stored in browser -->
          <div class="field-group">
            <label for="templateSelect">My templates</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <select id="templateSelect" style="flex:1;">
                <option value="">(none)</option>
              </select>
              <button class="btn-small" id="loadTemplateBtn">Load</button>
            </div>
            <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap;">
              <button class="btn-ghost" id="saveTemplateBtn">Save current as template</button>
              <button class="btn-small" id="deleteTemplateBtn">Delete selected</button>
            </div>
            <small>Templates are stored in this browser only. Great for reusable blurbs.</small>
          </div>

          <div class="field-group">
            <label for="toolboxInput">Toolbox input</label>
            <small>
              Paste lab text, write notes, or describe what you want (e.g.,
              "Short owner email explaining mildly elevated ALT").
            </small>
            <textarea id="toolboxInput"></textarea>
          </div>

          <button class="btn-primary" id="generateToolboxBtn">
            Generate (Toolbox)
          </button>
        </section>

        <!-- Consult tab -->
        <section class="card" id="consultSection" style="display:none;">
          <div class="card-header-row">
            <div>
              <h2>Consult</h2>
              <div class="card-subtitle">
                Speak freely — brain responds and may produce SOAP-style text.
              </div>
            </div>
            <button class="btn-ghost" id="qrConsultBtn">Open on phone (QR)</button>
          </div>

          <div class="field-group">
            <label for="consultMessage">Message</label>
            <small>Any question, case summary, or request. e.g., "Help me explain these lab results to the owner."</small>
            <textarea id="consultMessage"></textarea>
          </div>

          <button class="btn-primary" id="generateConsultBtn">
            Ask (Consult)
          </button>
        </section>
      </div>

      <!-- RIGHT COLUMN: Status + Output -->
      <div class="right-column">
        <section class="card">
          <h2 style="font-size:15px;margin-bottom:6px;">Status</h2>
          <div id="statusMessage" class="status-text">Ready.</div>
        </section>

        <section class="card" style="margin-top:10px;">
          <div class="output-header-row">
            <h2 style="font-size:15px;">Output</h2>
            <div class="output-controls">
              <label>
                <input type="checkbox" id="splitSoapCheckbox" />
                <span>Split into S / O / A / P</span>
              </label>
              <button class="btn-small" id="copyOutputBtn">Copy</button>
            </div>
          </div>
          <textarea
            id="soapOutput"
            placeholder="Generated SOAP or toolbox text will appear here. Paste directly into Avimark."
            style="min-height:260px;"
          ></textarea>
        </section>

        <div class="footer-note">
          Lohit SOAP App v1.6.8 · Frontend only; no data stored on server.
        </div>
      </div>
    </main>
  </div>

  <!-- QR modal -->
  <div class="qr-modal hidden" id="qrModal">
    <div class="qr-modal-content">
      <div class="qr-modal-header">
        <h3 id="qrModalTitle">Open on phone</h3>
        <button class="qr-close-btn" id="qrCloseBtn">&times;</button>
      </div>
      <div id="qrCodeContainer"></div>
      <p class="qr-help-text">
        Scan this code with your phone camera. The app will open directly to this section.
      </p>
    </div>
  </div>

  <!-- QRCode library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    // ---- CONFIG ----
    const BACKEND_URL = "https://lohit-soap-app.onrender.com/api/soap";

    // ---- ELEMENTS ----
    const modeSelect = document.getElementById("modeSelect");
    const statusMessage = document.getElementById("statusMessage");
    const soapOutput = document.getElementById("soapOutput");
    const splitSoapCheckbox = document.getElementById("splitSoapCheckbox");
    const copyOutputBtn = document.getElementById("copyOutputBtn");

    const tabButtons = document.querySelectorAll(".tab-button");
    const appointmentSection = document.getElementById("appointmentSection");
    const surgerySection = document.getElementById("surgerySection");
    const toolboxSection = document.getElementById("toolboxSection");
    const consultSection = document.getElementById("consultSection");

    // Appointment inputs
    const apptReason = document.getElementById("apptReason");
    const apptHistory = document.getElementById("apptHistory");
    const apptPE = document.getElementById("apptPE");
    const apptDiagnostics = document.getElementById("apptDiagnostics");
    const apptAssessment = document.getElementById("apptAssessment");
    const apptPlan = document.getElementById("apptPlan");
    const apptMeds = document.getElementById("apptMeds");
    const generateApptBtn = document.getElementById("generateApptBtn");

    // Surgery inputs
    const sxTemplate = document.getElementById("sxTemplate");
    const sxCaseLabel = document.getElementById("sxCaseLabel");
    const sxProcedureNotes = document.getElementById("sxProcedureNotes");
    const sxRecovery = document.getElementById("sxRecovery");
    const sxMeds = document.getElementById("sxMeds");
    const generateSxBtn = document.getElementById("generateSxBtn");

    // Toolbox inputs
    const toolSelect = document.getElementById("toolSelect");
    const toolContext = document.getElementById("toolContext");
    const templateSelect = document.getElementById("templateSelect");
    const saveTemplateBtn = document.getElementById("saveTemplateBtn");
    const deleteTemplateBtn = document.getElementById("deleteTemplateBtn");
    const loadTemplateBtn = document.getElementById("loadTemplateBtn");
    const toolboxInput = document.getElementById("toolboxInput");
    const generateToolboxBtn = document.getElementById("generateToolboxBtn");

    // Consult
    const consultMessage = document.getElementById("consultMessage");
    const generateConsultBtn = document.getElementById("generateConsultBtn");

    // QR buttons
    const qrModal = document.getElementById("qrModal");
    const qrModalTitle = document.getElementById("qrModalTitle");
    const qrCloseBtn = document.getElementById("qrCloseBtn");
    const qrCodeContainer = document.getElementById("qrCodeContainer");
    const qrAppointmentBtn = document.getElementById("qrAppointmentBtn");
    const qrSurgeryBtn = document.getElementById("qrSurgeryBtn");
    const qrToolboxBtn = document.getElementById("qrToolboxBtn");
    const qrConsultBtn = document.getElementById("qrConsultBtn");
    const attachmentsQrBtn = document.getElementById("attachmentsQrBtn");

    let qrInstance = null;
    let lastRawOutput = "";

    // ---- TAB HANDLING ----
    function setActiveTab(tabName) {
      tabButtons.forEach((btn) => {
        const active = btn.dataset.tab === tabName;
        btn.classList.toggle("active", active);
      });

      appointmentSection.style.display = tabName === "appointment" ? "" : "none";
      surgerySection.style.display = tabName === "surgery" ? "" : "none";
      toolboxSection.style.display = tabName === "toolbox" ? "" : "none";
      consultSection.style.display = tabName === "consult" ? "" : "none";
    }

    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.tab;
        setActiveTab(tab);
        updateUrlForTab(tab);
      });
    });

    function updateUrlForTab(tab) {
      const params = new URLSearchParams(window.location.search);
      params.set("tab", tab);
      const newUrl =
        window.location.origin +
        window.location.pathname +
        "?" +
        params.toString();
      window.history.replaceState({}, "", newUrl);
    }

    // ---- TOOLBOX TEMPLATES (localStorage) ----
    const TEMPLATE_STORAGE_KEY = "lohit_toolbox_templates";

    function loadTemplatesFromStorage() {
      try {
        const raw = localStorage.getItem(TEMPLATE_STORAGE_KEY);
        if (!raw) return {};
        return JSON.parse(raw);
      } catch (e) {
        console.warn("Failed to parse templates", e);
        return {};
      }
    }

    function saveTemplatesToStorage(templates) {
      try {
        localStorage.setItem(TEMPLATE_STORAGE_KEY, JSON.stringify(templates));
      } catch (e) {
        console.warn("Failed to save templates", e);
      }
    }

    function refreshTemplateSelect() {
      const templates = loadTemplatesFromStorage();
      const selected = templateSelect.value;
      templateSelect.innerHTML = '<option value="">(none)</option>';
      Object.keys(templates).forEach((name) => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        templateSelect.appendChild(opt);
      });
      if (selected && templates[selected]) {
        templateSelect.value = selected;
      }
    }

    saveTemplateBtn.addEventListener("click", () => {
      const text = toolboxInput.value.trim();
      if (!text) {
        alert("Write something in the Toolbox input before saving as a template.");
        return;
      }
      const name = prompt("Name for this template:");
      if (!name) return;

      const templates = loadTemplatesFromStorage();
      templates[name] = {
        tool: toolSelect.value,
        context: toolContext.value,
        text,
      };
      saveTemplatesToStorage(templates);
      refreshTemplateSelect();
      templateSelect.value = name;
      statusMessage.textContent = `Saved template "${name}".`;
      statusMessage.classList.remove("error");
    });

    deleteTemplateBtn.addEventListener("click", () => {
      const name = templateSelect.value;
      if (!name) return;
      if (!confirm(`Delete template "${name}"?`)) return;

      const templates = loadTemplatesFromStorage();
      delete templates[name];
      saveTemplatesToStorage(templates);
      refreshTemplateSelect();
      toolboxInput.value = "";
      statusMessage.textContent = `Deleted template "${name}".`;
      statusMessage.classList.remove("error");
    });

    loadTemplateBtn.addEventListener("click", () => {
      const name = templateSelect.value;
      if (!name) return;
      const templates = loadTemplatesFromStorage();
      const t = templates[name];
      if (!t) return;

      toolSelect.value = t.tool || toolSelect.value;
      toolContext.value = t.context || toolContext.value;
      toolboxInput.value = t.text || "";
      statusMessage.textContent = `Loaded template "${name}".`;
      statusMessage.classList.remove("error");
    });

    // ---- BACKEND CALL HELPERS ----
    async function callBackend(payload) {
      statusMessage.classList.remove("error");
      statusMessage.textContent = "Working…";
      try {
        const resp = await fetch(BACKEND_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) {
          throw new Error("HTTP " + resp.status);
        }
        const data = await resp.json();
        const text = (data && data.text) || data.output || "";
        if (!text) {
          statusMessage.textContent = "Error: no text returned from backend.";
          statusMessage.classList.add("error");
          return;
        }
        lastRawOutput = text;
        updateOutput();
        statusMessage.textContent = "Done.";
        statusMessage.classList.remove("error");
      } catch (e) {
        console.error(e);
        statusMessage.textContent =
          "Error contacting backend. Check Render service.";
        statusMessage.classList.add("error");
      }
    }

    function updateOutput() {
      if (!splitSoapCheckbox.checked) {
        soapOutput.value = lastRawOutput;
        return;
      }
      // Very simple splitter based on headings; non-destructive.
      const parts = { S: "", O: "", A: "", P: "" };
      let current = "S";
      const lines = lastRawOutput.split(/\r?\n/);
      lines.forEach((line) => {
        const trimmed = line.trim();
        if (/^subjective[:]/i.test(trimmed)) {
          current = "S";
        } else if (/^objective[:]/i.test(trimmed)) {
          current = "O";
        } else if (/^assessment[:]/i.test(trimmed)) {
          current = "A";
        } else if (/^plan[:]/i.test(trimmed)) {
          current = "P";
        }
        parts[current] += line + "\n";
      });
      soapOutput.value =
        (parts.S ? parts.S.trim() + "\n\n" : "") +
        (parts.O ? parts.O.trim() + "\n\n" : "") +
        (parts.A ? parts.A.trim() + "\n\n" : "") +
        (parts.P ? parts.P.trim() : "");
    }

    splitSoapCheckbox.addEventListener("change", updateOutput);

    copyOutputBtn.addEventListener("click", () => {
      const text = soapOutput.value;
      if (!text) return;
      navigator.clipboard
        .writeText(text)
        .then(() => {
          statusMessage.textContent = "Output copied to clipboard.";
          statusMessage.classList.remove("error");
        })
        .catch(() => {
          statusMessage.textContent = "Could not copy to clipboard.";
          statusMessage.classList.add("error");
        });
    });

    // ---- BUTTON HANDLERS ----
    generateApptBtn.addEventListener("click", () => {
      const payload = {
        tab: "appointment",
        mode: modeSelect.value,
        source: "appointment",
        appointment: {
          reason: apptReason.value,
          history: apptHistory.value,
          peFindings: apptPE.value,
          diagnostics: apptDiagnostics.value,
          assessmentSteer: apptAssessment.value,
          planNotes: apptPlan.value,
          medsDispensed: apptMeds.value,
        },
      };
      callBackend(payload);
    });

    generateSxBtn.addEventListener("click", () => {
      const payload = {
        tab: "surgery",
        mode: modeSelect.value,
        source: "surgery",
        surgery: {
          template: sxTemplate.value,
          caseLabel: sxCaseLabel.value,
          procedureNotes: sxProcedureNotes.value,
          recovery: sxRecovery.value,
          medsDispensed: sxMeds.value,
        },
      };
      callBackend(payload);
    });

    generateToolboxBtn.addEventListener("click", () => {
      const payload = {
        tab: "toolbox",
        mode: modeSelect.value,
        source: "toolbox",
        toolbox: {
          tool: toolSelect.value,
          context: toolContext.value,
          input: toolboxInput.value,
        },
      };
      callBackend(payload);
    });

    generateConsultBtn.addEventListener("click", () => {
      const payload = {
        tab: "consult",
        mode: modeSelect.value,
        source: "consult",
        consult: {
          message: consultMessage.value,
        },
      };
      callBackend(payload);
    });

    // ---- QR HELPERS ----
    function buildQrUrlFor(target) {
      const base =
        window.location.origin + window.location.pathname;
      const params = new URLSearchParams();

      if (target === "attachments") {
        // Just open app; tab = appointment as default context
        params.set("tab", "appointment");
        return `${base}?${params.toString()}`;
      }

      params.set("tab", target);

      if (target === "toolbox") {
        params.set("tool", toolSelect.value);
        params.set("context", toolContext.value);
      } else if (target === "surgery") {
        params.set("sxTemplate", sxTemplate.value);
      }

      return `${base}?${params.toString()}`;
    }

    function openQrModalFor(target) {
      const url = buildQrUrlFor(target);
      qrModalTitle.textContent =
        target === "attachments"
          ? "Attachments on phone"
          : "Open on phone – " + target.charAt(0).toUpperCase() + target.slice(1);

      // Clear old QR
      qrCodeContainer.innerHTML = "";
      qrInstance = new QRCode(qrCodeContainer, {
        text: url,
        width: 220,
        height: 220,
      });

      qrModal.classList.remove("hidden");
    }

    qrAppointmentBtn.addEventListener("click", () =>
      openQrModalFor("appointment")
    );
    qrSurgeryBtn.addEventListener("click", () => openQrModalFor("surgery"));
    qrToolboxBtn.addEventListener("click", () => openQrModalFor("toolbox"));
    qrConsultBtn.addEventListener("click", () => openQrModalFor("consult"));
    attachmentsQrBtn.addEventListener("click", () =>
      openQrModalFor("attachments")
    );

    qrCloseBtn.addEventListener("click", () => {
      qrModal.classList.add("hidden");
      qrCodeContainer.innerHTML = "";
    });

    qrModal.addEventListener("click", (e) => {
      if (e.target === qrModal) {
        qrModal.classList.add("hidden");
        qrCodeContainer.innerHTML = "";
      }
    });

    // ---- URL PARAMS: deep links from QR ----
    function initFromUrlParams() {
      const params = new URLSearchParams(window.location.search);
      const tab = params.get("tab") || "appointment";
      setActiveTab(tab);

      const toolParam = params.get("tool");
      if (toolParam) {
        [...toolSelect.options].forEach((opt) => {
          if (opt.value === toolParam) toolSelect.value = toolParam;
        });
      }

      const contextParam = params.get("context");
      if (contextParam) {
        [...toolContext.options].forEach((opt) => {
          if (opt.value === contextParam) toolContext.value = contextParam;
        });
      }

      const sxTemplateParam = params.get("sxTemplate");
      if (sxTemplateParam) {
        [...sxTemplate.options].forEach((opt) => {
          if (opt.value === sxTemplateParam) sxTemplate.value = sxTemplateParam;
        });
      }
    }

    // ---- INIT ----
    refreshTemplateSelect();
    initFromUrlParams();
  </script>
</body>
</html>
