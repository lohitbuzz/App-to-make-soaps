<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lohit SOAP App v1.7.6</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #071018;
      --bg-elevated: #101b27;
      --bg-elevated-soft: #131f2c;
      --border-subtle: #1f2a38;
      --accent: #19b4a5;
      --accent-soft: rgba(25,180,165,0.15);
      --accent-bright: #24dcc8;
      --danger: #ff5f5f;
      --text-main: #f7fbff;
      --text-muted: #a7b4c6;
      --text-soft: #7f8ca0;
      --pill-bg: #151f2b;
      --shadow-soft: 0 16px 40px rgba(0,0,0,0.45);
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-pill: 999px;
      --input-bg: #121d29;
      --input-border: #273445;
      --input-focus: #30f1dd;
      --font-main: system-ui, -apple-system, BlinkMacSystemFont,
        "SF Pro Text", "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-main);
      background: radial-gradient(circle at top, #1c2937 0, #02060b 60%);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 16px;
      gap: 12px;
    }

    /* Header */
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 16px;
      border-radius: var(--radius-lg);
      background: linear-gradient(
        120deg,
        rgba(25,180,165,0.15),
        rgba(7,16,24,0.95)
      );
      border: 1px solid rgba(25,180,165,0.35);
      box-shadow: var(--shadow-soft);
    }

    .app-header-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .app-title {
      font-size: 18px;
      font-weight: 600;
    }
    .app-subtitle {
      font-size: 12px;
      color: var(--text-soft);
    }

    .pill {
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      background: var(--pill-bg);
      border: 1px solid rgba(255,255,255,0.05);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #3ee88a;
      box-shadow: 0 0 0 4px rgba(62,232,138,0.2);
    }

    /* Tabs */
    .top-tabs {
      display: inline-flex;
      border-radius: var(--radius-pill);
      background: rgba(6,12,20,0.9);
      padding: 4px;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: var(--shadow-soft);
      align-self: center;
    }

    .top-tab-btn {
      background: transparent;
      border: none;
      padding: 6px 16px;
      font-size: 13px;
      color: var(--text-soft);
      border-radius: var(--radius-pill);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all .15s ease;
    }
    .top-tab-btn.active {
      background: var(--accent-soft);
      color: var(--accent-bright);
    }

    /* Panels */
    .content-grid {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 12px;
    }
    @media(max-width:900px) {
      .content-grid {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: radial-gradient(circle at top left,
        rgba(25,180,165,0.14),
        #050a12 52%
      );
      border: 1px solid #151f2b;
      padding: 12px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .panel-title {
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-soft);
    }

    .panel-body { display: flex; flex-direction: column; gap: 8px; }

    /* Fields */
    .field-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .field {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .field-label {
      font-size: 11px;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
    }

    select, input, textarea {
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 9px;
      padding: 6px 8px;
      font-size: 12px;
      color: var(--text-main);
    }

    textarea { resize: vertical; min-height: 64px; }

    /* NEW Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    .modal {
      width: 90%;
      max-width: 440px;
      background: #0f1a23;
      border-radius: 16px;
      padding: 16px;
      border: 1px solid rgba(255,255,255,0.08);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .modal-title {
      font-size: 15px;
      margin-bottom: 4px;
    }

    .modal-close {
      align-self: flex-end;
      cursor: pointer;
      color: #aaa;
      font-size: 20px;
      margin-top: -8px;
      margin-right: -4px;
    }

    .multi-select-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
      padding: 8px;
      background: rgba(0,0,0,0.25);
    }

    .multi-opt {
      font-size: 13px;
      padding: 6px;
      margin-bottom: 3px;
      border-radius: 8px;
      cursor: pointer;
      background: rgba(255,255,255,0.03);
    }
    .multi-opt.active {
      background: rgba(36,220,200,0.25);
      border: 1px solid var(--accent-bright);
    }

    .btn { cursor: pointer; border-radius: var(--radius-pill); padding: 6px 14px; }    /* Output box */
    .output-main {
      min-height: 160px;
      max-height: 420px;
      overflow-y: auto;
      border-radius: 10px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.06);
      padding: 8px;
      white-space: pre-wrap;
      color: var(--text-muted);
      font-size: 12px;
    }

    .btn-primary {
      background: linear-gradient(120deg, var(--accent), var(--accent-bright));
      border: 1px solid rgba(255,255,255,0.1);
      font-weight: 600;
      color: #02100f;
    }

    .btn-soft {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      color: var(--text-main);
    }

    .btn-danger {
      border: 1px solid rgba(255,95,95,0.7);
      color: #ff5f5f;
    }

    .button-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    @media(max-width:900px) {
      .desktop-only { display:none; }
      .mobile-only { display:inline-flex; }
    }

    .desktop-only { display:inline-flex; }
    .mobile-only { display:none; }
  </style>
</head>

<body>
<div class="app-shell">

  <!-- HEADER -->
  <header class="app-header">
    <div class="app-header-left">
      <div class="app-title">Lohit SOAP App</div>
      <div class="app-subtitle">SOAP Â· Toolbox Â· Consult Â· Hybrid v1.7.6</div>
    </div>
    <div class="pill">
      <span class="pill-dot"></span> Backend ready
    </div>
    <div class="pill">v1.7.6</div>
  </header>

  <!-- TABS -->
  <div class="top-tabs">
    <button class="top-tab-btn active" data-tab="soap">ðŸ§¾ SOAP</button>
    <button class="top-tab-btn" data-tab="toolbox">ðŸ§° Toolbox</button>
    <button class="top-tab-btn" data-tab="consult">ðŸ’­ Consult</button>
  </div>

  <!-- GRID -->
  <div class="content-grid">

    <!-- LEFT COLUMN -->
    <div id="left-column">

      <!-- SOAP SECTION -->
      <div id="soap-section" class="panel">
        <div class="panel-header">
          <div class="panel-title">SOAP Input</div>
          <div class="panel-chip">Appointment Â· Surgery Â· Voice</div>
        </div>

        <div class="panel-body">

          <!-- Case + patient -->
          <div class="field-row">
            <div class="field">
              <label class="field-label">Case label</label>
              <input id="caseLabel" placeholder="Bella â€“ Spay recheck">
            </div>
            <div class="field">
              <label class="field-label">Patient</label>
              <input id="patientName" placeholder="Bella">
            </div>
          </div>

          <!-- Signalment -->
          <div class="field-row">
            <div class="field">
              <label class="field-label">Species</label>
              <select id="species">
                <option value="">Select</option>
                <option value="canine">Canine</option>
                <option value="feline">Feline</option>
              </select>
            </div>
            <div class="field">
              <label class="field-label">Sex</label>
              <select id="sex">
                <option value="">Sex</option>
                <option value="M">M</option>
                <option value="MN">MN</option>
                <option value="F">F</option>
                <option value="FS">FS</option>
              </select>
            </div>
            <div class="field">
              <label class="field-label">Weight (kg)</label>
              <input type="number" id="weightKg">
            </div>
          </div>

          <!-- Visit type -->
          <div class="field-row">
            <div class="field">
              <label class="field-label">Visit type</label>
              <div class="chip-toggle-group">
                <button id="visitTypeAppointment" class="chip-toggle active">Appointment</button>
                <button id="visitTypeSurgery" class="chip-toggle">Surgery</button>
              </div>
            </div>
            <div class="field" id="asaField" style="display:none;">
              <label class="field-label">ASA</label>
              <select id="asaStatus">
                <option value="">Select</option>
                <option value="I">ASA I</option>
                <option value="II">ASA II</option>
                <option value="III">ASA III</option>
              </select>
            </div>
          </div>

          <!-- Appointment preset -->
          <div class="field-row" id="appointmentPresetRow">
            <div class="field">
              <label class="field-label">Appointment preset</label>
              <select id="appointmentPreset">
                <option value="">Custom</option>
                <option value="wellness">Wellness</option>
                <option value="gi">GI upset</option>
                <option value="derm">Derm</option>
              </select>
            </div>
          </div>

          <!-- Surgery preset -->
          <div class="field-row" id="surgeryPresetRow" style="display:none;">
            <div class="field">
              <label class="field-label">Surgery preset</label>
              <select id="surgeryPreset">
                <option value="">Custom surgery</option>
                <option value="dog_spay">Dog Spay</option>
                <option value="dog_neuter">Dog Neuter</option>
                <option value="cat_spay">Cat Spay</option>
                <option value="cat_neuter">Cat Neuter</option>
                <option value="mass_removal">Mass Removal</option>
                <option value="dental_no_rads">Dental â€“ COHAT (no rads)</option>
              </select>
            </div>

            <div class="field">
              <label class="field-label">Surgery mode</label>
              <div class="chip-toggle-group">
                <button id="surgeryModeSimple" class="chip-toggle active">Simple</button>
                <button id="surgeryModeAdvanced" class="chip-toggle">Advanced</button>
              </div>
            </div>
          </div>

          <!-- NEW SINGLE DROPDOWN TRIGGER -->
          <div class="field-row" id="surgeryAnesthesiaRow" style="display:none;">
            <div class="field">
              <label class="field-label">Anesthesia protocol</label>
              <button class="btn btn-soft" id="openAnesthesiaModalBtn">
                Select anesthesia protocol
              </button>
              <div id="selectedAnesthesiaPreview"
                   style="font-size:11px;color:#90a4b0;margin-top:4px;">
                   None selected
              </div>
            </div>
          </div>

          <!-- Vaccines -->
          <label class="checkbox-inline">
            <input type="checkbox" id="vaccinesToday"> Vaccines today
          </label>
          <div class="field-row" id="vaccineSelectorRow" style="display:none;">
            <div class="field">
              <label class="field-label">Vaccines</label>
              <select id="vaccineSelector" multiple size="4"></select>
            </div>
          </div>

          <!-- SOAP text -->
          <div class="field">
            <label class="field-label">Core notes / history</label>
            <textarea id="soapCoreNotes"></textarea>
          </div>

          <div class="field">
            <label class="field-label">PE (objective data only)</label>
            <textarea id="soapPE"></textarea>
          </div>

          <div class="field">
            <label class="field-label">Assessment hints</label>
            <textarea id="soapAssessmentHints"></textarea>
          </div>

          <div class="field">
            <label class="field-label">Plan & discharge hints</label>
            <textarea id="soapPlanHints"></textarea>
          </div>

          <!-- External transcript -->
          <div class="collapse-toggle" id="extTranscriptToggle">
            <span class="chevron">â–¶</span> External transcript
          </div>
          <div class="collapse-body" id="extTranscriptBody" style="display:none;">
            <textarea id="externalTranscript"></textarea>
            <label class="checkbox-inline">
              <input id="externalTranscriptInclude" type="checkbox"> Include communication summary
            </label>
          </div>

          <!-- Voice recorder -->
          <div class="collapse-toggle" id="voiceToggle">
            <span class="chevron">â–¶</span> Voice notes
          </div>
          <div id="voiceBody" class="recorder-strip" style="display:none;">
            <button class="btn btn-soft" id="recBtn">ðŸŽ™ Record</button>
            <div id="recStatusText" class="tiny">Not recording</div>
            <div class="rec-actions">
              <button class="btn btn-soft" id="recSaveRecordingBtn">Save recording</button>
              <button class="btn btn-primary" id="recSaveTranscribeBtn">Save + transcribe</button>
              <button class="btn btn-danger" id="recClearBtn">Clear</button>
            </div>

            <div class="collapse-toggle" id="transcriptToggle">
              <span class="chevron">â–¶</span> Transcript
            </div>
            <div id="transcriptBody" class="collapse-body" style="display:none;">
              <textarea id="voiceTranscriptEdit" class="scroll-area"></textarea>
              <label class="checkbox-inline">
                <input type="checkbox" id="useTranscriptForSoap"> Use transcript in SOAP
              </label>
            </div>
          </div>

          <!-- Generate -->
          <div class="button-row">
            <button class="btn btn-primary" id="generateSoapBtn">Generate SOAP</button>
          </div>

        </div>
      </div>

      <!-- TOOLBOX + CONSULT omitted here (in Part 3) -->

    </div>

    <!-- RIGHT COLUMN -->
    <div id="right-column">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title" id="outputPanelTitle">OUTPUT Â· SOAP</div>
          <div class="panel-chip" id="outputPanelChip">Ready</div>
        </div>

        <div class="panel-body">
          <div class="output-main" id="mainOutput">Output will appear here.</div>

          <div class="button-row" id="outputButtonsSoap">
            <button class="btn btn-primary" id="copyFullSoapBtn">Copy full SOAP</button>
            <button class="btn btn-soft" id="copyPlanMedsAfterBtn">Copy Plan+Meds+Aftercare</button>
          </div>
        </div>
      </div>
    </div>

  </div> <!-- content-grid -->

</div> <!-- app-shell -->

<!-- NEW ANESTHESIA MODAL -->
<div id="anesthesiaModalOverlay" class="modal-overlay">
  <div class="modal">
    <div class="modal-close" id="closeAnesthesiaModalBtn">Ã—</div>
    <div class="modal-title">Select anesthesia protocol</div>

    <div class="multi-select-list" id="anesthesiaList">

      <!-- PREMED -->
      <div class="multi-opt" data-value="premed_dexmedetomidine">Dexmedetomidine</div>
      <div class="multi-opt" data-value="premed_butorphanol">Butorphanol</div>
      <div class="multi-opt" data-value="premed_buprenorphine">Buprenorphine</div>
      <div class="multi-opt" data-value="premed_hydromorphone">Hydromorphone</div>
      <div class="multi-opt" data-value="premed_methadone">Methadone</div>
      <div class="multi-opt" data-value="premed_midazolam">Midazolam</div>

      <!-- INDUCTION -->
      <div class="multi-opt" data-value="induction_propofol">Propofol</div>
      <div class="multi-opt" data-value="induction_alfaxalone">Alfaxalone</div>
      <div class="multi-opt" data-value="induction_ket_diaz">
        Ketamine + Diazepam
      </div>

      <!-- INTRA-OP -->
      <div class="multi-opt" data-value="intra_meloxicam_inj">Meloxicam inj</div>
      <div class="multi-opt" data-value="intra_onsior_inj">Onsior inj</div>
      <div class="multi-opt" data-value="intra_cefazolin">Cefazolin</div>
      <div class="multi-opt" data-value="intra_duplicillin_im">Duplicillin IM</div>
      <div class="multi-opt" data-value="intra_local_blocks">Local blocks</div>

      <!-- POST-OP ANALGESIA -->
      <div class="multi-opt" data-value="post_meloxicam_oral">Meloxicam oral</div>
      <div class="multi-opt" data-value="post_onsior_oral">Onsior oral</div>
      <div class="multi-opt" data-value="post_gabapentin">Gabapentin</div>
      <div class="multi-opt" data-value="post_buprenorphine_sr">
        Buprenorphine SR (post-op only)
      </div>

      <!-- POST-OP ANTIBIOTICS -->
      <div class="multi-opt" data-value="post_convenia">Convenia</div>
      <div class="multi-opt" data-value="post_amoxi_clav">Amoxi-Clav</div>

    </div>

    <div class="button-row">
      <button class="btn btn-primary" id="saveAnesthesiaBtn">Save</button>
    </div>
  </div>
</div><script>
  // ---------- Tab switching ----------
  const tabButtons = document.querySelectorAll('.top-tab-btn');
  const soapSection = document.getElementById('soap-section');
  const toolboxSection = document.getElementById('toolbox-section');  // may be null in this version
  const consultSection = document.getElementById('consult-section');  // may be null in this version
  const outputPanelTitle = document.getElementById('outputPanelTitle');
  const outputPanelChip = document.getElementById('outputPanelChip');
  const mainOutput = document.getElementById('mainOutput');

  let currentTab = 'soap';

  function showTab(tab) {
    currentTab = tab;
    tabButtons.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.tab === tab);
    });

    if (soapSection) soapSection.style.display = tab === 'soap' ? 'block' : 'none';
    if (toolboxSection) toolboxSection.style.display = tab === 'toolbox' ? 'block' : 'none';
    if (consultSection) consultSection.style.display = tab === 'consult' ? 'block' : 'none';

    if (tab === 'soap') {
      outputPanelTitle.textContent = 'OUTPUT Â· SOAP';
      outputPanelChip.textContent = 'Ready';
    } else if (tab === 'toolbox') {
      outputPanelTitle.textContent = 'OUTPUT Â· TOOLBOX';
      outputPanelChip.textContent = 'Toolbox';
    } else {
      outputPanelTitle.textContent = 'OUTPUT Â· CONSULT';
      outputPanelChip.textContent = 'Consult';
    }
  }

  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => showTab(btn.dataset.tab));
  });

  // ---------- Visit type, ASA, presets, vaccines ----------
  const visitTypeAppointmentBtn = document.getElementById('visitTypeAppointment');
  const visitTypeSurgeryBtn = document.getElementById('visitTypeSurgery');
  const asaField = document.getElementById('asaField');
  const appointmentPresetRow = document.getElementById('appointmentPresetRow');
  const surgeryPresetRow = document.getElementById('surgeryPresetRow');
  const vaccinesTodayCheckbox = document.getElementById('vaccinesToday');
  const vaccineSelectorRow = document.getElementById('vaccineSelectorRow');
  const vaccineSelector = document.getElementById('vaccineSelector');
  const speciesSelect = document.getElementById('species');
  const appointmentPreset = document.getElementById('appointmentPreset');
  const surgeryAnesthesiaRow = document.getElementById('surgeryAnesthesiaRow');

  function updateVisitType(type) {
    if (type === 'appointment') {
      visitTypeAppointmentBtn.classList.add('active');
      visitTypeSurgeryBtn.classList.remove('active');
      asaField.style.display = 'none';
      appointmentPresetRow.style.display = 'flex';
      surgeryPresetRow.style.display = 'none';
      surgeryAnesthesiaRow.style.display = 'none';
    } else {
      visitTypeAppointmentBtn.classList.remove('active');
      visitTypeSurgeryBtn.classList.add('active');
      asaField.style.display = 'flex';
      appointmentPresetRow.style.display = 'none';
      surgeryPresetRow.style.display = 'flex';
      surgeryAnesthesiaRow.style.display = 'flex';
    }
  }

  visitTypeAppointmentBtn.addEventListener('click', () => updateVisitType('appointment'));
  visitTypeSurgeryBtn.addEventListener('click', () => updateVisitType('surgery'));

  function populateVaccineOptions() {
    const species = speciesSelect.value;
    vaccineSelector.innerHTML = '';
    if (!species) return;

    const add = (value, label) => {
      const opt = document.createElement('option');
      opt.value = value;
      opt.textContent = label;
      vaccineSelector.appendChild(opt);
    };

    if (species === 'canine') {
      add('da2pp_1', 'DA2PP â€“ 1-year');
      add('da2pp_3', 'DA2PP â€“ 3-year');
      add('rabies_1_dog', 'Rabies â€“ 1-year');
      add('rabies_3_dog', 'Rabies â€“ 3-year');
      add('lyme', 'Lyme');
      add('lepto', 'Leptospirosis');
      add('bord_inj', 'Bordetella â€“ injectable');
      add('bord_oral', 'Bordetella â€“ oral');
      add('bord_nasal', 'Bordetella â€“ intranasal');
    } else if (species === 'feline') {
      add('fvrcp_1', 'FVRCP â€“ 1-year');
      add('fvrcp_3', 'FVRCP â€“ 3-year');
      add('rabies_1_cat', 'Rabies â€“ 1-year');
      add('rabies_3_cat', 'Rabies â€“ 3-year');
      add('felv', 'FeLV');
    }
  }

  speciesSelect.addEventListener('change', populateVaccineOptions);

  vaccinesTodayCheckbox.addEventListener('change', () => {
    vaccineSelectorRow.style.display = vaccinesTodayCheckbox.checked ? 'flex' : 'none';
  });

  appointmentPreset.addEventListener('change', () => {
    if (appointmentPreset.value === 'wellness') {
      vaccinesTodayCheckbox.checked = true;
      vaccineSelectorRow.style.display = 'flex';
    }
  });

  function gatherSelectedVaccines() {
    return Array.from(vaccineSelector.selectedOptions || []).map(o => o.value);
  }

  // ---------- Simple collapses ----------
  function wireCollapse(toggleId, bodyId) {
    const toggle = document.getElementById(toggleId);
    const body = document.getElementById(bodyId);
    if (!toggle || !body) return;
    body.style.display = 'none';
    toggle.addEventListener('click', () => {
      const isOpen = body.style.display !== 'none';
      body.style.display = isOpen ? 'none' : 'block';
      toggle.classList.toggle('open', !isOpen);
    });
  }

  wireCollapse('extTranscriptToggle', 'extTranscriptBody');
  wireCollapse('voiceToggle', 'voiceBody');
  wireCollapse('transcriptToggle', 'transcriptBody');

  // ---------- Voice recorder (SOAP) ----------
  let soapVoiceTranscript = '';
  const recBtn = document.getElementById('recBtn');
  const recStatusText = document.getElementById('recStatusText');
  const recSaveRecordingBtn = document.getElementById('recSaveRecordingBtn');
  const recSaveTranscribeBtn = document.getElementById('recSaveTranscribeBtn');
  const recClearBtn = document.getElementById('recClearBtn');
  const voiceTranscriptEdit = document.getElementById('voiceTranscriptEdit');
  const useTranscriptForSoapCheckbox = document.getElementById('useTranscriptForSoap');

  let mediaRecorder = null;
  let chunks = [];

  function setRecordingState(isRecording) {
    if (!recBtn || !recStatusText) return;
    if (isRecording) {
      recBtn.textContent = 'â¹ Stop';
      recStatusText.textContent = 'Recordingâ€¦';
    } else {
      recBtn.textContent = 'ðŸŽ™ Record';
      recStatusText.textContent = soapVoiceTranscript ? 'Recording finished.' : 'Not recording';
    }
  }

  async function startRecording() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      chunks = [];
      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) chunks.push(e.data);
      };
      mediaRecorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        // Stub transcript - you can wire real STT on backend.
        soapVoiceTranscript = '[Voice note recorded â€“ transcript to be generated by backend].';
        if (voiceTranscriptEdit) {
          voiceTranscriptEdit.value = soapVoiceTranscript;
        }
        setRecordingState(false);
      };
      mediaRecorder.start();
      setRecordingState(true);
    } catch (err) {
      console.error(err);
      alert('Unable to access microphone â€“ check permissions.');
    }
  }

  function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      mediaRecorder.stop();
    }
  }

  if (recBtn) {
    recBtn.addEventListener('click', () => {
      if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        startRecording();
      } else {
        stopRecording();
      }
    });
  }

  if (recClearBtn) {
    recClearBtn.addEventListener('click', () => {
      soapVoiceTranscript = '';
      if (voiceTranscriptEdit) voiceTranscriptEdit.value = '';
      setRecordingState(false);
    });
  }

  if (recSaveRecordingBtn) {
    recSaveRecordingBtn.addEventListener('click', () => {
      if (!soapVoiceTranscript) {
        alert('Record at least once first.');
        return;
      }
      alert('Recording saved as context (transcript optional).');
    });
  }

  if (recSaveTranscribeBtn) {
    recSaveTranscribeBtn.addEventListener('click', () => {
      if (!soapVoiceTranscript) {
        alert('Record at least once first.');
        return;
      }
      useTranscriptForSoapCheckbox.checked = true;
      alert('Transcript will be used for SOAP (you can edit it first).');
    });
  }

  // ---------- Anesthesia modal (single dropdown, multi-select) ----------
  const anesthesiaModalOverlay = document.getElementById('anesthesiaModalOverlay');
  const openAnesthesiaModalBtn = document.getElementById('openAnesthesiaModalBtn');
  const closeAnesthesiaModalBtn = document.getElementById('closeAnesthesiaModalBtn');
  const saveAnesthesiaBtn = document.getElementById('saveAnesthesiaBtn');
  const anesthesiaList = document.getElementById('anesthesiaList');
  const selectedAnesthesiaPreview = document.getElementById('selectedAnesthesiaPreview');

  let selectedAnesthesiaValues = [];

  const anesthesiaLabelMap = {
    // premed
    premed_dexmedetomidine: 'Dexmedetomidine',
    premed_butorphanol: 'Butorphanol',
    premed_buprenorphine: 'Buprenorphine',
    premed_hydromorphone: 'Hydromorphone',
    premed_methadone: 'Methadone',
    premed_midazolam: 'Midazolam',
    // induction
    induction_propofol: 'Propofol',
    induction_alfaxalone: 'Alfaxalone',
    induction_ket_diaz: 'Ketamine + Diazepam',
    // intra-op
    intra_meloxicam_inj: 'Meloxicam inj',
    intra_onsior_inj: 'Onsior inj',
    intra_cefazolin: 'Cefazolin',
    intra_duplicillin_im: 'Duplicillin IM',
    intra_local_blocks: 'Local blocks',
    // post-op analgesia
    post_meloxicam_oral: 'Meloxicam oral',
    post_onsior_oral: 'Onsior oral',
    post_gabapentin: 'Gabapentin',
    post_buprenorphine_sr: 'Buprenorphine SR',
    // post-op antibiotics
    post_convenia: 'Convenia',
    post_amoxi_clav: 'Amoxi-Clav'
  };

  function refreshAnesthesiaPreview() {
    if (!selectedAnesthesiaPreview) return;
    if (!selectedAnesthesiaValues.length) {
      selectedAnesthesiaPreview.textContent = 'None selected';
      return;
    }
    const labels = selectedAnesthesiaValues.map(v => anesthesiaLabelMap[v] || v);
    selectedAnesthesiaPreview.textContent = 'Selected: ' + labels.join(', ');
  }

  function openAnesthesiaModal() {
    if (!anesthesiaModalOverlay) return;
    anesthesiaModalOverlay.classList.add('active');
  }

  function closeAnesthesiaModal() {
    if (!anesthesiaModalOverlay) return;
    anesthesiaModalOverlay.classList.remove('active');
  }

  if (openAnesthesiaModalBtn) {
    openAnesthesiaModalBtn.addEventListener('click', openAnesthesiaModal);
  }
  if (closeAnesthesiaModalBtn) {
    closeAnesthesiaModalBtn.addEventListener('click', closeAnesthesiaModal);
  }

  if (anesthesiaModalOverlay) {
    anesthesiaModalOverlay.addEventListener('click', (e) => {
      if (e.target === anesthesiaModalOverlay) {
        closeAnesthesiaModal();
      }
    });
  }

  if (anesthesiaList) {
    anesthesiaList.addEventListener('click', (e) => {
      const opt = e.target.closest('.multi-opt');
      if (!opt) return;
      const value = opt.dataset.value;
      if (!value) return;

      opt.classList.toggle('selected');
      if (opt.classList.contains('selected')) {
        if (!selectedAnesthesiaValues.includes(value)) {
          selectedAnesthesiaValues.push(value);
        }
      } else {
        selectedAnesthesiaValues = selectedAnesthesiaValues.filter(v => v !== value);
      }
    });
  }

  if (saveAnesthesiaBtn) {
    saveAnesthesiaBtn.addEventListener('click', () => {
      refreshAnesthesiaPreview();
      closeAnesthesiaModal();
    });
  }

  // ---------- SOAP generation ----------
  const generateSoapBtn = document.getElementById('generateSoapBtn');

  function setWorkingState(isWorking, label) {
    if (!outputPanelChip) return;
    outputPanelChip.textContent = isWorking ? (label || 'Workingâ€¦') : 'Ready';
  }

  function gatherSOAPPayload() {
    const visitType =
      visitTypeAppointmentBtn.classList.contains('active') ? 'appointment' : 'surgery';

    const useTranscript = useTranscriptForSoapCheckbox && useTranscriptForSoapCheckbox.checked;
    const editTranscriptVal = (voiceTranscriptEdit && voiceTranscriptEdit.value.trim()) || '';
    const finalTranscript = editTranscriptVal || soapVoiceTranscript;

    return {
      mode: 'soap',
      caseLabel: document.getElementById('caseLabel').value,
      patientName: document.getElementById('patientName').value,
      species: speciesSelect.value,
      sex: document.getElementById('sex').value,
      weightKg: document.getElementById('weightKg').value,
      visitType,
      asa: document.getElementById('asaStatus').value,
      appointmentPreset: document.getElementById('appointmentPreset').value,
      surgeryPreset: document.getElementById('surgeryPreset').value,
      surgeryMode: document
        .getElementById('surgeryModeAdvanced')
        ?.classList.contains('active') ? 'advanced' : 'simple',
      vaccinesToday: vaccinesTodayCheckbox.checked,
      vaccineSelections: gatherSelectedVaccines(),
      surgeryAnesthesiaSelections: selectedAnesthesiaValues,
      coreNotes: document.getElementById('soapCoreNotes').value,
      pe: document.getElementById('soapPE').value,
      assessmentHints: document.getElementById('soapAssessmentHints').value,
      planHints: document.getElementById('soapPlanHints').value,
      extra: '', // you can add extra textarea later if you want
      externalTranscript: document.getElementById('externalTranscript').value,
      externalTranscriptInclude: document.getElementById('externalTranscriptInclude').checked,
      voiceTranscript: useTranscript ? finalTranscript : '',
      voiceUseTranscriptInSoap: useTranscript
    };
  }

  function generateSOAP() {
    setWorkingState(true, 'Generating SOAPâ€¦');
    mainOutput.textContent = 'Working on SOAPâ€¦';

    const payload = gatherSOAPPayload();

    fetch('/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
      .then(res => {
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return res.json();
      })
      .then(data => {
        mainOutput.textContent = data.output || 'No output returned.';
      })
      .catch(err => {
        console.error(err);
        mainOutput.textContent = 'Error generating SOAP. Check server.';
      })
      .finally(() => {
        setWorkingState(false);
      });
  }

  if (generateSoapBtn) {
    generateSoapBtn.addEventListener('click', generateSOAP);
  }

  // ---------- Copy buttons ----------
  function copyTextToClipboard(text) {
    if (!text || !text.trim()) {
      alert('Nothing to copy.');
      return;
    }
    navigator.clipboard.writeText(text).then(() => {
      alert('Copied to clipboard.');
    }).catch(() => {
      alert('Clipboard error.');
    });
  }

  const copyFullSoapBtn = document.getElementById('copyFullSoapBtn');
  const copyPlanMedsAfterBtn = document.getElementById('copyPlanMedsAfterBtn');

  if (copyFullSoapBtn) {
    copyFullSoapBtn.addEventListener('click', () => {
      copyTextToClipboard(mainOutput.textContent || '');
    });
  }

  if (copyPlanMedsAfterBtn) {
    // For now just copies full SOAP; backend can later expose Plan+Meds+Aftercare section if you want.
    copyPlanMedsAfterBtn.addEventListener('click', () => {
      copyTextToClipboard(mainOutput.textContent || '');
    });
  }

  // ---------- Initial state ----------
  updateVisitType('appointment');
  refreshAnesthesiaPreview();
  showTab('soap');
</script>
</body>
</html>