<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lohit SOAP App v1.7.4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    :root {
      --bg: #020617;
      --bg-elevated: #020819;
      --border-subtle: #1f2937;
      --accent: #06b6d4;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --success: #22c55e;
      --radius-lg: 20px;
      --radius-pill: 999px;
    }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "SF Pro Text", "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 16px;
    }

    .app-shell {
      width: 100%;
      max-width: 1160px;
      background: radial-gradient(circle at top left, #020617 0, #020617 40%, #000 100%);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 22px 60px rgba(15, 23, 42, 0.85);
      padding: 16px 18px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .header-row {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .app-title {
      font-weight: 700;
      letter-spacing: 0.08em;
      font-size: 13px;
      text-transform: uppercase;
      padding: 8px 14px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.24), rgba(15, 23, 42, 0.9));
      box-shadow: 0 0 18px rgba(6, 182, 212, 0.3);
    }

    .pill-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip {
      font-size: 11px;
      border-radius: var(--radius-pill);
      padding: 6px 12px;
      border: 1px solid var(--border-subtle);
      color: var(--text-muted);
      background: rgba(15, 23, 42, 0.85);
    }

    .chip-strong {
      border-color: rgba(56, 189, 248, 0.55);
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.27), rgba(15, 23, 42, 0.95));
      color: var(--text-main);
      box-shadow: 0 0 18px rgba(8, 145, 178, 0.65);
    }

    .chip span.label {
      font-weight: 600;
      margin-right: 4px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 10px;
    }

    .body-row {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 12px;
    }

    @media (max-width: 860px) {
      .body-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: linear-gradient(to bottom right, rgba(15, 23, 42, 0.98), rgba(2, 6, 23, 0.98));
      border-radius: var(--radius-lg);
      border: 1px solid rgba(30, 64, 175, 0.4);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.8);
      padding: 14px 14px 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(56, 189, 248, 0.08), transparent 58%);
      pointer-events: none;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      position: relative;
      z-index: 1;
    }

    .card-title {
      font-size: 12px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--text-muted);
      font-weight: 600;
    }

    .tab-row,
    .mode-row {
      display: inline-flex;
      border-radius: var(--radius-pill);
      padding: 2px;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.99));
      border: 1px solid rgba(51, 65, 85, 0.9);
    }

    .tab-btn,
    .mode-btn {
      border-radius: var(--radius-pill);
      border: none;
      padding: 4px 11px;
      font-size: 11px;
      color: var(--text-muted);
      background: transparent;
      cursor: pointer;
      transition: 0.16s;
    }

    .tab-btn.active,
    .mode-btn.active {
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.25), rgba(15, 23, 42, 1));
      color: var(--text-main);
      box-shadow: 0 0 12px rgba(8, 145, 178, 0.6);
    }

    .card-body {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 12px;
    }

    .field-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .field {
      flex: 1;
      min-width: 120px;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    label {
      font-size: 11px;
      color: var(--text-muted);
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      border-radius: 10px;
      border: 1px solid rgba(30, 64, 175, 0.7);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), rgba(2, 6, 23, 0.98));
      color: var(--text-main);
      font-size: 12px;
      padding: 7px 9px;
      outline: none;
    }

    textarea {
      min-height: 64px;
      resize: vertical;
    }

    input::placeholder,
    textarea::placeholder {
      color: #4b5563;
    }

    .helper-text {
      font-size: 10px;
      color: var(--text-muted);
    }

    .button-row {
      display: flex;
      justify-content: flex-start;
      gap: 8px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .btn-main {
      border-radius: var(--radius-pill);
      border: none;
      padding: 8px 18px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.8), rgba(8, 47, 73, 1));
      color: #0b1120;
      box-shadow: 0 12px 22px rgba(8, 145, 178, 0.6);
    }

    .btn-secondary {
      border-radius: var(--radius-pill);
      border: 1px solid rgba(51, 65, 85, 0.9);
      padding: 6px 14px;
      font-size: 11px;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-muted);
    }

    .btn-secondary.positive {
      border-color: rgba(34, 197, 94, 0.7);
      color: #bbf7d0;
    }

    .output-box {
      border-radius: 14px;
      border: 1px solid rgba(30, 64, 175, 0.9);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 1), rgba(2, 6, 23, 1));
      padding: 10px;
      min-height: 170px;
      max-height: 360px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-size: 12px;
      font-family: "SF Mono", ui-monospace, Menlo, Consolas, "Courier New", monospace;
    }

    .output-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .status-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: var(--radius-pill);
      padding: 3px 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.96);
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #f97373;
    }

    .dot.ok {
      background: var(--success);
    }

    .qr-panel {
      border-radius: 14px;
      border: 1px dashed rgba(148, 163, 184, 0.5);
      padding: 8px;
      margin-top: 8px;
      display: none;
      align-items: center;
      gap: 10px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .qr-container {
      width: 120px;
      height: 120px;
      border-radius: 10px;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(30, 64, 175, 0.8);
    }

    .attachments-panel {
      border-radius: 10px;
      border: 1px solid rgba(30, 64, 175, 0.8);
      padding: 8px;
      margin-top: 6px;
      max-height: 150px;
      overflow-y: auto;
      font-size: 11px;
    }

    .thumb {
      max-width: 120px;
      max-height: 120px;
      border-radius: 8px;
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    .file-chip {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 4px 8px;
      font-size: 10px;
      color: var(--text-main);
      background: rgba(15, 23, 42, 0.95);
    }

    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      color: var(--text-muted);
      padding-top: 2px;
      border-top: 1px dashed rgba(31, 41, 55, 0.9);
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="header-row">
      <div class="app-title">LOHIT<br />SOAP APP v1.7.4</div>
      <div class="pill-row">
        <div class="chip chip-strong"><span class="label">Privacy</span>Clinic-safe text only</div>
        <div class="chip"><span class="label">Backend</span><span id="backendLabel">lohit-soap-app.onrender.com</span></div>
      </div>
    </div>

    <div class="body-row">
      <!-- INPUT -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Input · Doctor side</div>
            <div id="tabSubtitle" style="font-size:10px;color:#9ca3af;margin-top:2px;">
              SOAP mode – full SOAP generator
            </div>
          </div>
          <div class="tab-row" id="modeTabs">
            <button class="tab-btn active" data-tab="soap">SOAP</button>
            <button class="tab-btn" data-tab="toolbox">Toolbox</button>
            <button class="tab-btn" data-tab="consult">Consult</button>
          </div>
        </div>
        <div class="card-body">
          <div class="field-row">
            <div class="field">
              <label>Case label / Patient (local only)</label>
              <input id="caseLabel" type="text" placeholder="eg. Milo dental normal" />
            </div>
            <div class="field" style="max-width:90px;">
              <label>Species</label>
              <select id="species">
                <option value="">–</option>
                <option>Canine</option>
                <option>Feline</option>
                <option>Other</option>
              </select>
            </div>
            <div class="field" style="max-width:90px;">
              <label>Weight (kg)</label>
              <input id="weight" type="number" step="0.1" />
            </div>
          </div>

          <div class="field-row">
            <div class="field" style="max-width:110px;">
              <label>ASA</label>
              <input id="asa" type="text" placeholder="eg. 2" />
            </div>
            <div class="field">
              <label>TPR / notes (optional)</label>
              <input id="tpr" type="text" placeholder="eg. 38.5°C, 100 bpm, 28 rpm" />
            </div>
          </div>

          <div class="field">
            <label>Core notes / history / PE / diagnostics</label>
            <textarea id="coreNotes" placeholder="History, PE, CBC/chem, urinalysis, rads, treatments, etc."></textarea>
          </div>
          <div class="field">
            <label>Assessment hints (optional)</label>
            <textarea id="assessmentHints" placeholder="Problem list or your thoughts. Brain will refine."></textarea>
          </div>
          <div class="field">
            <label>Plan hints / discharge requests (optional)</label>
            <textarea id="planHints" placeholder="Treatments, meds, discharge instructions you want included."></textarea>
          </div>
          <div class="field">
            <label>Extra instructions to AI (optional)</label>
            <textarea id="extraInstructions" placeholder="eg. Keep language simple; emphasize dental charting; include recheck."></textarea>
          </div>

          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:6px;">
            <div class="mode-row" id="brainMode">
              <button class="mode-btn active" data-mode="help">Help me (default)</button>
              <button class="mode-btn" data-mode="strict">Strict (no guessing)</button>
            </div>
            <div class="button-row">
              <button id="generateBtn" class="btn-main">Generate</button>
            </div>
          </div>
          <div class="helper-text">
            Help me = safe templated normals. Strict = no invention; blanks where info is missing.
          </div>
        </div>
      </div>

      <!-- OUTPUT + RELAY -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Output · AI brain</div>
          <div class="button-row">
            <button id="copyFullBtn" class="btn-secondary">Copy full text</button>
          </div>
        </div>
        <div class="card-body">
          <div class="output-header-row">
            <span>Main output</span>
            <span id="generationStatus" class="helper-text">Idle</span>
          </div>
          <div id="mainOutput" class="output-box"></div>

          <div class="status-row" style="margin-top:4px;">
            <div class="status-pill">
              <span id="backendDot" class="dot"></span>
              <span id="backendStatus">Not connected to backend</span>
            </div>
            <div style="font-size:10px;color:var(--text-muted);">
              QR relay + local uploads bring text & redacted docs into this console.
            </div>
          </div>

          <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px;">
            <button id="receiveTextBtn" class="btn-secondary positive">Receive text from phone</button>
            <button id="receiveFileBtn" class="btn-secondary">Receive document from phone</button>
            <button id="localUploadBtn" class="btn-secondary">Upload from this device</button>
            <input id="localUploadInput" type="file" accept="image/*,application/pdf" multiple style="display:none;" />
          </div>

          <div id="qrTextPanel" class="qr-panel">
            <div class="qr-container"><div id="qrText"></div></div>
            <div>
              <div style="font-weight:500;color:#e5e7eb;">Text relay</div>
              <div>1. On desktop, open this panel.</div>
              <div>2. On phone, scan QR with camera.</div>
              <div>3. Phone opens "Send text" page → paste text → Send.</div>
            </div>
          </div>

          <div id="qrFilePanel" class="qr-panel">
            <div class="qr-container"><div id="qrFile"></div></div>
            <div>
              <div style="font-weight:500;color:#e5e7eb;">Document relay</div>
              <div>1. On desktop, open this panel.</div>
              <div>2. On phone, scan QR.</div>
              <div>3. Choose photo, draw black boxes over PII → Send.</div>
            </div>
          </div>

          <div class="attachments-panel">
            <div style="margin-bottom:4px;font-weight:500;color:#e5e7eb;">Attachments from phone & this device</div>
            <div id="attachmentsEmpty" class="helper-text">No documents received yet.</div>
            <div id="attachmentsList" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
          </div>

          <div class="field" style="margin-top:8px;">
            <label>Feedback & next inputs (local only)</label>
            <textarea id="feedbackBox" placeholder="After each run, jot what was missing, what you corrected, or what you want next time."></textarea>
            <button id="applyFeedbackBtn" class="btn-secondary positive" style="margin-top:6px;align-self:flex-start;">
              Use feedback to remake output
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <span>v1.7.4 · QR relay + local uploads + feedback refine</span>
      <span>Keep this tab open on Avimark desktop as your brain console.</span>
    </div>
  </div>

  <script>
    const API_BASE = 'https://lohit-soap-app.onrender.com';

    const modeTabs = document.getElementById('modeTabs');
    const tabButtons = modeTabs.querySelectorAll('.tab-btn');
    const tabSubtitle = document.getElementById('tabSubtitle');

    const brainModeEl = document.getElementById('brainMode');
    const brainModeButtons = brainModeEl.querySelectorAll('.mode-btn');

    const generateBtn = document.getElementById('generateBtn');
    const copyFullBtn = document.getElementById('copyFullBtn');
    const mainOutputEl = document.getElementById('mainOutput');
    const generationStatusEl = document.getElementById('generationStatus');

    const backendDot = document.getElementById('backendDot');
    const backendStatus = document.getElementById('backendStatus');

    const receiveTextBtn = document.getElementById('receiveTextBtn');
    const receiveFileBtn = document.getElementById('receiveFileBtn');
    const localUploadBtn = document.getElementById('localUploadBtn');
    const localUploadInput = document.getElementById('localUploadInput');

    const qrTextPanel = document.getElementById('qrTextPanel');
    const qrFilePanel = document.getElementById('qrFilePanel');
    const qrTextContainer = document.getElementById('qrText');
    const qrFileContainer = document.getElementById('qrFile');

    const attachmentsEmpty = document.getElementById('attachmentsEmpty');
    const attachmentsList = document.getElementById('attachmentsList');

    const caseLabel = document.getElementById('caseLabel');
    const species = document.getElementById('species');
    const weight = document.getElementById('weight');
    const asa = document.getElementById('asa');
    const tpr = document.getElementById('tpr');
    const coreNotes = document.getElementById('coreNotes');
    const assessmentHints = document.getElementById('assessmentHints');
    const planHints = document.getElementById('planHints');
    const extraInstructions = document.getElementById('extraInstructions');

    const feedbackBox = document.getElementById('feedbackBox');
    const applyFeedbackBtn = document.getElementById('applyFeedbackBtn');

    let currentTab = 'soap';
    let currentMode = 'help';
    let textCaseId = null;
    let textPollInterval = null;
    let fileCaseId = null;
    let filePollInterval = null;

    // ----- TAB SWITCHING -----
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        tabButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentTab = btn.dataset.tab || 'soap';
        updateTabUI();
      });
    });

    function updateTabUI() {
      if (currentTab === 'soap') {
        tabSubtitle.textContent = 'SOAP mode – full SOAP generator';
        coreNotes.placeholder = 'History, PE, CBC/chem, urinalysis, rads, treatments, etc.';
        assessmentHints.placeholder = 'Problem list or your thoughts. Brain will refine.';
        planHints.placeholder = 'Treatments, meds, discharge instructions you want included.';
      } else if (currentTab === 'toolbox') {
        tabSubtitle.textContent = 'Toolbox mode – bloodwork, emails, handouts, small snippets.';
        coreNotes.placeholder = 'Paste labs, notes, or text you want summarized or re-written.';
        assessmentHints.placeholder = 'Tell the brain what kind of output you want (short vs long, SOAP vs email, etc.).';
        planHints.placeholder = 'Any key phrases or instructions you want included in the output.';
      } else if (currentTab === 'consult') {
        tabSubtitle.textContent = 'Consult mode – clinical questions, differentials, protocols.';
        coreNotes.placeholder = 'Signalment, history, PE, key diagnostics. Ask your question here.';
        assessmentHints.placeholder = 'What you are worried about / what you want help deciding.';
        planHints.placeholder = 'Constraints (eg. budget, drugs on hand) or specific advice you want.';
      }
    }
    updateTabUI();

    // ----- BRAIN MODE -----
    brainModeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        brainModeButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentMode = btn.dataset.mode || 'help';
      });
    });

    // ----- BACKEND PING -----
    async function pingBackend() {
      try {
        const res = await fetch(API_BASE + '/', { method: 'GET' });
        if (res.ok) {
          backendDot.classList.add('ok');
          backendStatus.textContent = 'Backend reachable';
        } else {
          backendDot.classList.remove('ok');
          backendStatus.textContent = 'Backend error ' + res.status;
        }
      } catch (err) {
        backendDot.classList.remove('ok');
        backendStatus.textContent = 'Cannot reach backend';
      }
    }
    pingBackend();

    function buildIntakeString() {
      const lines = [];
      lines.push('Tab: ' + currentTab.toUpperCase());
      if (caseLabel.value.trim()) lines.push('Case label: ' + caseLabel.value.trim());
      if (species.value) lines.push('Species: ' + species.value);
      if (weight.value) lines.push('Weight: ' + weight.value + ' kg');
      if (asa.value.trim()) lines.push('ASA: ' + asa.value.trim());
      if (tpr.value.trim()) lines.push('TPR / notes: ' + tpr.value.trim());
      if (coreNotes.value.trim()) {
        lines.push('');
        lines.push('Core notes / history / PE / diagnostics:');
        lines.push(coreNotes.value.trim());
      }
      if (assessmentHints.value.trim()) {
        lines.push('');
        lines.push('Assessment hints:');
        lines.push(assessmentHints.value.trim());
      }
      if (planHints.value.trim()) {
        lines.push('');
        lines.push('Plan hints / discharge requests:');
        lines.push(planHints.value.trim());
      }
      return lines.join('\n');
    }

    async function callGenerate(intake, context, statusLabel) {
      generationStatusEl.textContent = statusLabel;
      generateBtn.disabled = true;
      applyFeedbackBtn.disabled = true;
      mainOutputEl.textContent = '';

      try {
        const res = await fetch(API_BASE + '/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mode: currentMode, intake, context }),
        });
        const json = await res.json();
        if (!res.ok || !json.ok) {
          const errMsg = (json && json.error) || ('Backend error ' + res.status);
          mainOutputEl.textContent = 'There was a backend error:\n' + errMsg;
          generationStatusEl.textContent = 'Error';
        } else {
          mainOutputEl.textContent = json.text;
          generationStatusEl.textContent = 'Done';
        }
      } catch (err) {
        mainOutputEl.textContent = 'Error talking to backend:\n' + (err.message || err);
        generationStatusEl.textContent = 'Error';
      } finally {
        generateBtn.disabled = false;
        applyFeedbackBtn.disabled = false;
      }
    }

    // ----- GENERATE (PRIMARY BUTTON) -----
    generateBtn.addEventListener('click', async () => {
      const intake = buildIntakeString();
      const context = extraInstructions.value.trim();
      await callGenerate(intake, context, 'Working…');
    });

    // ----- APPLY FEEDBACK BUTTON -----
    applyFeedbackBtn.addEventListener('click', async () => {
      if (!feedbackBox.value.trim()) {
        feedbackBox.placeholder = 'Type feedback here first (e.g., "make it past tense", "shorter SOAP").';
        feedbackBox.focus();
        return;
      }
      const intake = buildIntakeString();
      const contextParts = [];
      if (extraInstructions.value.trim()) {
        contextParts.push('Original extra instructions: ' + extraInstructions.value.trim());
      }
      contextParts.push('Doctor feedback for revision: ' + feedbackBox.value.trim());
      const context = contextParts.join('\n\n');
      await callGenerate(intake, context, 'Refining with feedback…');
    });

    // ----- COPY FULL TEXT -----
    copyFullBtn.addEventListener('click', async () => {
      const text = mainOutputEl.textContent || '';
      if (!text.trim()) return;
      try {
        await navigator.clipboard.writeText(text);
        copyFullBtn.textContent = 'Copied ✓';
        setTimeout(() => (copyFullBtn.textContent = 'Copy full text'), 1000);
      } catch {
        copyFullBtn.textContent = 'Copy failed';
        setTimeout(() => (copyFullBtn.textContent = 'Copy full text'), 1000);
      }
    });

    // ----- TEXT RELAY -----
    receiveTextBtn.addEventListener('click', async () => {
      try {
        const res = await fetch(API_BASE + '/relay/init-text', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({}),
        });
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || 'Error init text relay');
        textCaseId = json.caseId;
      } catch (err) {
        alert('Could not start text relay: ' + (err.message || err));
        return;
      }

      qrFilePanel.style.display = 'none';
      qrTextPanel.style.display = 'flex';
      qrTextContainer.innerHTML = '';
      const urlForPhone = API_BASE + '/relay/text-page?caseId=' + encodeURIComponent(textCaseId);
      new QRCode(qrTextContainer, { text: urlForPhone, width: 110, height: 110 });

      if (textPollInterval) clearInterval(textPollInterval);
      textPollInterval = setInterval(async () => {
        if (!textCaseId) return;
        try {
          const res = await fetch(API_BASE + '/relay/poll-text/' + encodeURIComponent(textCaseId));
          if (!res.ok) return;
          const json = await res.json();
          if (!json.ok) return;
          const data = json.data || {};
          if (data.text && data.text.trim()) {
            mainOutputEl.textContent = data.text;
            generationStatusEl.textContent = 'Text received from phone';
            clearInterval(textPollInterval);
            textPollInterval = null;
          }
        } catch (err) {
          console.error('Text relay poll error', err);
        }
      }, 1500);
    });

    // ----- FILE RELAY (QR FROM PHONE) -----
    receiveFileBtn.addEventListener('click', async () => {
      try {
        const res = await fetch(API_BASE + '/relay/init-file', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({}),
        });
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || 'Error init file relay');
        fileCaseId = json.caseId;
      } catch (err) {
        alert('Could not start document relay: ' + (err.message || err));
        return;
      }

      qrTextPanel.style.display = 'none';
      qrFilePanel.style.display = 'flex';
      qrFileContainer.innerHTML = '';
      const urlForPhone = API_BASE + '/relay/file-page?caseId=' + encodeURIComponent(fileCaseId);
      new QRCode(qrFileContainer, { text: urlForPhone, width: 110, height: 110 });

      if (filePollInterval) clearInterval(filePollInterval);
      filePollInterval = setInterval(async () => {
        if (!fileCaseId) return;
        try {
          const res = await fetch(API_BASE + '/relay/poll-file/' + encodeURIComponent(fileCaseId));
          if (!res.ok) return;
          const json = await res.json();
          if (!json.ok) return;
          const data = json.data || {};
          if (data.dataUrl && data.dataUrl.startsWith('data:image')) {
            attachmentsEmpty.style.display = 'none';
            const img = document.createElement('img');
            img.className = 'thumb';
            img.src = data.dataUrl;
            attachmentsList.appendChild(img);
            clearInterval(filePollInterval);
            filePollInterval = null;
          }
        } catch (err) {
          console.error('File relay poll error', err);
        }
      }, 2000);
    });

    // ----- LOCAL UPLOAD (PHONE OR DESKTOP) -----
    localUploadBtn.addEventListener('click', () => {
      localUploadInput.click();
    });

    localUploadInput.addEventListener('change', () => {
      if (!localUploadInput.files || !localUploadInput.files.length) return;
      attachmentsEmpty.style.display = 'none';

      Array.from(localUploadInput.files).forEach(file => {
        if (file.type && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = e => {
            const img = document.createElement('img');
            img.className = 'thumb';
            img.src = e.target.result;
            attachmentsList.appendChild(img);
          };
          reader.readAsDataURL(file);
        } else {
          const chip = document.createElement('div');
          chip.className = 'file-chip';
          chip.textContent = file.name || 'Attached file';
          attachmentsList.appendChild(chip);
        }
      });

      localUploadInput.value = '';
    });
  </script>
</body>
</html>
