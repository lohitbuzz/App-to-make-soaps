<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lohit SOAP App v1.7.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ====== Base reset-ish ====== */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #111827;
    }
    textarea, input, button, select {
      font-family: inherit;
    }

    /* ====== Layout shell ====== */
    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    /* Header */
    .app-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-end;
      gap: 12px;
      margin-bottom: 16px;
    }
    .app-title-block h1 {
      margin: 0;
      font-size: 1.6rem;
      font-weight: 700;
      color: #065f46;
    }
    .app-title-block .subtitle {
      margin: 4px 0 0;
      font-size: 0.9rem;
      color: #4b5563;
    }
    .mode-block {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }
    .mode-block select {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .tab {
      border: 1px solid #d1d5db;
      background: #ffffff;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 0.9rem;
      cursor: pointer;
      color: #374151;
    }
    .tab.active {
      background: #059669;
      border-color: #059669;
      color: #ffffff;
    }

    /* Main layout: inputs left, output right on desktop */
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 16px;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    /* Cards */
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
      border: 1px solid #e5e7eb;
      margin-bottom: 12px;
    }
    .card h2 {
      margin: 0 0 8px;
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
    }

    .hint {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 2px;
      margin-bottom: 6px;
    }

    /* Attachments bar */
    .attachments-bar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .attachments-bar-label {
      font-size: 0.85rem;
      font-weight: 500;
      color: #374151;
    }
    .attachments-input {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }
    .attachments-input input[type="file"] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    .attachments-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    .attachment-chip {
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 999px;
      background: #e5f4ee;
      color: #065f46;
      border: 1px solid #a7f3d0;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Tab sections */
    .tab-section {
      display: none;
    }
    .tab-section.active {
      display: block;
    }

    /* Form elements */
    label {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 8px;
    }
    label textarea,
    label input,
    label select {
      width: 100%;
      margin-top: 4px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 8px;
      font-size: 0.9rem;
      resize: vertical;
    }
    label textarea:focus,
    label input:focus,
    label select:focus,
    .mode-block select:focus {
      outline: none;
      border-color: #059669;
      box-shadow: 0 0 0 1px rgba(5, 150, 105, 0.1);
    }

    /* Buttons */
    .btn {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: transform 0.05s ease, box-shadow 0.05s ease,
        background-color 0.15s ease;
    }
    .btn-primary {
      background: #059669;
      color: #ffffff;
      box-shadow: 0 1px 2px rgba(16, 185, 129, 0.35);
    }
    .btn-primary:hover {
      background: #047857;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .btn-secondary:hover {
      background: #d1d5db;
    }
    .btn-ghost {
      background: transparent;
      color: #059669;
      border: 1px solid #a7f3d0;
    }
    .btn-ghost:hover {
      background: #ecfdf5;
    }
    .btn-disabled {
      background: #e5e7eb;
      color: #9ca3af;
      cursor: not-allowed;
    }
    .btn.small {
      padding: 4px 10px;
      font-size: 0.8rem;
    }
    .btn:active:not(.btn-disabled) {
      transform: translateY(1px);
      box-shadow: none;
    }
    .full-width {
      width: 100%;
      margin-top: 8px;
    }

    /* Output panel */
    .status-card p {
      margin: 4px 0 0;
      font-size: 0.88rem;
      color: #111827;
    }
    .output-card {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .output-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    #outputModeToggle {
      font-size: 0.8rem;
      color: #374151;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .output-main,
    .output-soap-split {
      width: 100%;
    }
    #soapOutput {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 8px;
      font-size: 0.9rem;
      resize: vertical;
      min-height: 280px;
    }
    .soap-split-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
    }
    @media (min-width: 800px) {
      .soap-split-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    .soap-split-grid label textarea {
      min-height: 80px;
    }

    /* Feedback area */
    .feedback-card label textarea {
      min-height: 80px;
    }
    .feedback-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    /* Toolbox templates */
    .template-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      font-size: 0.85rem;
    }
    .template-row select {
      min-width: 160px;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- Header -->
    <header class="app-header">
      <div class="app-title-block">
        <h1>Lohit SOAP App</h1>
        <p class="subtitle">v1.7.0 – Appointment · Surgery · Toolbox · Consult</p>
      </div>
      <div class="mode-block">
        <label for="modeSelect">Mode:</label>
        <select id="modeSelect">
          <option value="Help Me" selected>Help Me (templates OK)</option>
          <option value="Strict">Strict (no invention)</option>
        </select>
      </div>
    </header>

    <!-- Tabs -->
    <nav class="tabs">
      <button class="tab active" data-tab="appointment">Appointment</button>
      <button class="tab" data-tab="surgery">Surgery</button>
      <button class="tab" data-tab="toolbox">Toolbox</button>
      <button class="tab" data-tab="consult">Consult</button>
    </nav>

    <!-- Main layout -->
    <main class="layout">
      <!-- Left: inputs -->
      <section class="input-panel">
        <!-- Attachments (shared style; per-tab logic) -->
        <section class="card" id="attachmentsCard">
          <h2>Attachments (local only)</h2>
          <p class="hint">
            Upload photos/docs from this device. These previews stay local in your browser in this session.
            Vision + QR bridge will come later; for now, use them as visual reference while typing.
          </p>

          <div class="attachments-bar">
            <span class="attachments-bar-label">Files for current tab:</span>

            <div class="attachments-input btn btn-secondary small">
              <span>Upload from this device</span>
              <input type="file" multiple id="fileInputGlobal" />
            </div>

            <button class="btn btn-ghost small" id="btnShowQR" type="button">
              Show QR (open on phone)
            </button>
          </div>

          <div class="attachments-preview" id="attachmentsPreview"></div>

          <p class="hint">
            QR button: scan with your phone to open this app on your phone's browser and use its camera directly
            (for now, no auto-transfer; copy-paste or retype key info).
          </p>
        </section>

        <!-- Appointment tab -->
        <section class="card tab-section active" id="appointmentSection">
          <h2>Appointment</h2>

          <label>
            Reason
            <textarea id="apptReason" rows="2"
              placeholder="Eg. Ear infection recheck, annual wellness, vomiting, diarrhea, lameness, etc."></textarea>
          </label>

          <label>
            History
            <textarea id="apptHistory" rows="3"
              placeholder="Duration, progression, prior treatments, response, home meds, diet, travel, etc."></textarea>
          </label>

          <label>
            PE (abnormal findings only)
            <textarea id="apptPE" rows="3"
              placeholder="Only the abnormal findings; the brain can add normal systems in Help Me mode."></textarea>
          </label>

          <label>
            Diagnostics (data-only)
            <textarea id="apptDiagnostics" rows="3"
              placeholder="CBC/chem, ear cytology findings, urinalysis, radiology summary, SNAPs, etc. Data only."></textarea>
          </label>

          <label>
            Assessment (your notes)
            <textarea id="apptAssessment" rows="2"
              placeholder="Optional: problem list or working diagnosis if you want to steer the plan."></textarea>
          </label>

          <label>
            Plan (your notes)
            <textarea id="apptPlan" rows="2"
              placeholder="Optional: any specific items you want in the Plan section."></textarea>
          </label>

          <label>
            Meds dispensed
            <textarea id="apptMeds" rows="2"
              placeholder="Optional: meds dispensed if you want to lock them in."></textarea>
          </label>

          <button id="btnAppt" class="btn btn-primary full-width" type="button">
            Generate SOAP (Appointment)
          </button>
        </section>

        <!-- Surgery tab -->
        <section class="card tab-section" id="surgerySection">
          <h2>Surgery</h2>

          <label>
            Surgery type / template
            <select id="sxType">
              <option value="">Select or type custom…</option>
              <option value="Canine OVH">Canine OVH (spay)</option>
              <option value="Canine neuter">Canine neuter</option>
              <option value="Feline spay">Feline spay</option>
              <option value="Feline neuter">Feline neuter</option>
              <option value="COHAT dental">COHAT dental</option>
              <option value="Mass removal">Mass removal</option>
              <option value="Cystotomy">Cystotomy</option>
              <option value="Exploratory laparotomy">Exploratory laparotomy</option>
            </select>
          </label>

          <label>
            ASA status
            <input
              id="sxASA"
              type="text"
              placeholder="Eg. ASA II, ASA III unstable, etc."
            />
          </label>

          <label>
            Simple surgery notes
            <textarea id="sxNotes" rows="6"
              placeholder="Eg. 2y FS Lab, 22g L cephalic, 8.0 ETT, dog fluids default, routine OVH uneventful, closure standard 3-layer, recovery smooth."></textarea>
          </label>

          <label>
            Meds dispensed / recovery notes
            <textarea id="sxMeds" rows="3"
              placeholder="Optional: pain meds dispensed, NSAIDs, trazodone, e-collar instructions, recheck timing, etc."></textarea>
          </label>

          <button id="btnSx" class="btn btn-primary full-width" type="button">
            Generate SOAP (Surgery)
          </button>
        </section>

        <!-- Toolbox tab -->
        <section class="card tab-section" id="toolboxSection">
          <h2>Toolbox</h2>
          <p class="hint">
            One tool at a time. Choose a tool, set context, paste or type, then generate.
            Output goes to the main Output box on the right.
          </p>

          <!-- Tool selection -->
          <label>
            Tool
            <select id="toolboxTool">
              <option value="bw-helper">Bloodwork helper</option>
              <option value="email-helper">Client email helper</option>
              <option value="client-handout">Client handout generator</option>
              <option value="soap-snippet">SOAP snippet / note helper</option>
              <option value="generic-rewrite">Rewrite / simplify text</option>
            </select>
          </label>

          <!-- Context subtype (changes depending on tool) -->
          <label>
            Context / subtype
            <select id="toolboxContext">
              <!-- options filled dynamically -->
            </select>
          </label>

          <!-- Custom templates row -->
          <div class="template-row">
            <span>My templates:</span>
            <select id="templateSelect">
              <option value="">(none)</option>
            </select>
            <button id="btnLoadTemplate" class="btn btn-secondary small" type="button">
              Load
            </button>
            <button id="btnSaveTemplate" class="btn btn-ghost small" type="button">
              Save current as template
            </button>
            <button id="btnDeleteTemplate" class="btn btn-secondary small" type="button">
              Delete selected
            </button>
          </div>

          <!-- Toolbox input -->
          <label>
            Toolbox input
            <textarea id="toolboxInput" rows="7"
              placeholder="Paste labs, draft email, or text you want help with. Tool + context decide how the brain treats it."></textarea>
          </label>

          <button id="btnToolbox" class="btn btn-primary full-width" type="button">
            Generate (Toolbox)
          </button>
        </section>

        <!-- Consult tab -->
        <section class="card tab-section" id="consultSection">
          <h2>Consult</h2>
          <p class="hint">
            Free-form consult with the SOAP brain. Not necessarily a full SOAP; more like “What would you do?” or “Help me think.”
          </p>

          <label>
            Consult message
            <textarea id="consultInput" rows="8"
              placeholder="Eg. 12y DSH with CKD and weight loss; debating benazepril vs amlodipine, or need help with complex case reasoning."></textarea>
          </label>

          <button id="btnConsult" class="btn btn-primary full-width" type="button">
            Ask Consult
          </button>
        </section>
      </section>

      <!-- Right: output & feedback -->
      <section class="output-panel">
        <!-- Status -->
        <section class="card status-card">
          <h2>Status</h2>
          <p id="statusMessage">Ready.</p>
        </section>

        <!-- Output -->
        <section class="card output-card">
          <div class="output-header">
            <h2>Output</h2>
            <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
              <label id="outputModeToggle">
                <input type="checkbox" id="toggleSplitSoap" />
                Split into S / O / A / P
              </label>
              <button id="btnCopyOutput" class="btn btn-secondary small" type="button">
                Copy
              </button>
            </div>
          </div>

          <!-- Single big output -->
          <div class="output-main" id="outputMainWrapper">
            <textarea
              id="soapOutput"
              rows="20"
              placeholder="Generated SOAP or toolbox text will appear here. Paste directly into Avimark."
            ></textarea>
          </div>

          <!-- Split SOAP view -->
          <div class="output-soap-split" id="outputSplitWrapper" style="display:none;">
            <div class="soap-split-grid">
              <label>
                Subjective
                <textarea id="splitS"></textarea>
              </label>
              <label>
                Objective
                <textarea id="splitO"></textarea>
              </label>
              <label>
                Assessment
                <textarea id="splitA"></textarea>
              </label>
              <label>
                Plan
                <textarea id="splitP"></textarea>
              </label>
            </div>
          </div>
        </section>

        <!-- Feedback & refine -->
        <section class="card feedback-card">
          <h2>Feedback & refine</h2>
          <label>
            Feedback / refine notes
            <textarea id="feedbackInput"
              placeholder="Eg. 'Add more differentials', 'Tighten up Plan', 'Simplify wording for client', etc."></textarea>
          </label>
          <div class="feedback-buttons">
            <button id="btnSoapFeedback" class="btn btn-secondary small" type="button">
              Get SOAP feedback
            </button>
            <button id="btnRefineSoap" class="btn btn-primary small" type="button">
              Refine SOAP with feedback
            </button>
          </div>
          <p class="hint">
            Feedback uses the same brain but asks it to critique or improve the SOAP, instead of writing from scratch.
          </p>
        </section>
      </section>
    </main>
  </div>

  <script>
    // ========= CONFIG =========
    const BACKEND_URL = "https://lohit-soap-app.onrender.com/api/soap";

    // ========= ELEMENTS =========
    const modeSelect = document.getElementById("modeSelect");
    const statusMessage = document.getElementById("statusMessage");
    const soapOutput = document.getElementById("soapOutput");
    const btnCopyOutput = document.getElementById("btnCopyOutput");
    const toggleSplitSoap = document.getElementById("toggleSplitSoap");
    const outputMainWrapper = document.getElementById("outputMainWrapper");
    const outputSplitWrapper = document.getElementById("outputSplitWrapper");
    const splitS = document.getElementById("splitS");
    const splitO = document.getElementById("splitO");
    const splitA = document.getElementById("splitA");
    const splitP = document.getElementById("splitP");

    const tabs = Array.from(document.querySelectorAll(".tab"));
    const tabSections = {
      appointment: document.getElementById("appointmentSection"),
      surgery: document.getElementById("surgerySection"),
      toolbox: document.getElementById("toolboxSection"),
      consult: document.getElementById("consultSection"),
    };

    // Attachments
    const fileInputGlobal = document.getElementById("fileInputGlobal");
    const attachmentsPreview = document.getElementById("attachmentsPreview");
    const btnShowQR = document.getElementById("btnShowQR");

    // Appointment
    const apptReason = document.getElementById("apptReason");
    const apptHistory = document.getElementById("apptHistory");
    const apptPE = document.getElementById("apptPE");
    const apptDiagnostics = document.getElementById("apptDiagnostics");
    const apptAssessment = document.getElementById("apptAssessment");
    const apptPlan = document.getElementById("apptPlan");
    const apptMeds = document.getElementById("apptMeds");
    const btnAppt = document.getElementById("btnAppt");

    // Surgery
    const sxType = document.getElementById("sxType");
    const sxASA = document.getElementById("sxASA");
    const sxNotes = document.getElementById("sxNotes");
    const sxMeds = document.getElementById("sxMeds");
    const btnSx = document.getElementById("btnSx");

    // Toolbox
    const toolboxTool = document.getElementById("toolboxTool");
    const toolboxContext = document.getElementById("toolboxContext");
    const toolboxInput = document.getElementById("toolboxInput");
    const btnToolbox = document.getElementById("btnToolbox");
    const templateSelect = document.getElementById("templateSelect");
    const btnLoadTemplate = document.getElementById("btnLoadTemplate");
    const btnSaveTemplate = document.getElementById("btnSaveTemplate");
    const btnDeleteTemplate = document.getElementById("btnDeleteTemplate");

    // Consult
    const consultInput = document.getElementById("consultInput");
    const btnConsult = document.getElementById("btnConsult");

    // Feedback
    const feedbackInput = document.getElementById("feedbackInput");
    const btnSoapFeedback = document.getElementById("btnSoapFeedback");
    const btnRefineSoap = document.getElementById("btnRefineSoap");

    // ========= STATE =========
    let currentTab = "appointment";
    let attachmentsByTab = {
      appointment: [],
      surgery: [],
      toolbox: [],
      consult: [],
    };

    // ========= HELPERS =========
    function setStatus(text) {
      statusMessage.textContent = text;
    }

    function getMode() {
      return modeSelect.value || "Help Me";
    }

    function getCurrentAttachments() {
      return attachmentsByTab[currentTab] || [];
    }

    function renderAttachments() {
      const list = getCurrentAttachments();
      attachmentsPreview.innerHTML = "";
      list.forEach((file, idx) => {
        const chip = document.createElement("div");
        chip.className = "attachment-chip";
        chip.textContent = file.name || `File ${idx + 1}`;
        attachmentsPreview.appendChild(chip);
      });
    }

    function handleFilesSelected(files) {
      const arr = Array.from(files || []);
      if (!attachmentsByTab[currentTab]) {
        attachmentsByTab[currentTab] = [];
      }
      attachmentsByTab[currentTab] = attachmentsByTab[currentTab].concat(arr);
      renderAttachments();
    }

    async function callBackend(mode, tab, intakeText) {
      setStatus("Talking to SOAP brain…");
      soapOutput.value = "";

      try {
        const res = await fetch(BACKEND_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mode, tab, intakeText }),
        });

        if (!res.ok) {
          const errData = await res.json().catch(() => null);
          const message = errData?.error || `HTTP ${res.status}`;
          setStatus(`Error: ${message}`);
          return;
        }

        const data = await res.json();
        if (!data || !data.ok || !data.text) {
          setStatus("Error: no text returned from backend.");
          return;
        }

        soapOutput.value = data.text;
        if (toggleSplitSoap.checked) {
          syncSplitFromMain();
        }
        setStatus("Done.");
      } catch (err) {
        console.error("Frontend error calling backend:", err);
        setStatus("Error: could not reach backend.");
      }
    }

    function buildAppointmentText() {
      const attachmentsNames = getCurrentAttachments().map(f => f.name).join(", ") || "(none)";
      return [
        "APPOINTMENT CASE",
        `Mode: ${getMode()}`,
        `Attachments: ${attachmentsNames}`,
        "",
        `Reason: ${apptReason.value || "(not provided)"}`,
        `History: ${apptHistory.value || "(not provided)"}`,
        `PE (abnormal findings only): ${apptPE.value || "(not provided)"}`,
        `Diagnostics (data-only): ${apptDiagnostics.value || "(not provided)"}`,
        `Assessment (doctor notes): ${apptAssessment.value || "(not provided)"}`,
        `Plan (doctor notes): ${apptPlan.value || "(not provided)"}`,
        `Meds dispensed (doctor notes): ${apptMeds.value || "(not provided)"}`,
      ].join("\n");
    }

    function buildSurgeryText() {
      const attachmentsNames = getCurrentAttachments().map(f => f.name).join(", ") || "(none)";
      return [
        "SURGERY CASE",
        `Mode: ${getMode()}`,
        `Attachments: ${attachmentsNames}`,
        "",
        `Surgery type / template: ${sxType.value || "(not provided)"}`,
        `ASA status: ${sxASA.value || "(not provided)"}`,
        "",
        "Surgery notes:",
        sxNotes.value || "(not provided)",
        "",
        "Meds dispensed / recovery notes:",
        sxMeds.value || "(not provided)",
      ].join("\n");
    }

    function buildToolboxText() {
      const tool = toolboxTool.value;
      const ctx = toolboxContext.value;
      const attachmentsNames = getCurrentAttachments().map(f => f.name).join(", ") || "(none)";

      return [
        "TOOLBOX REQUEST",
        `Tool: ${tool}`,
        `Context: ${ctx}`,
        `Mode: ${getMode()}`,
        `Attachments: ${attachmentsNames}`,
        "",
        toolboxInput.value || "(no content provided)",
      ].join("\n");
    }

    function buildConsultText() {
      const attachmentsNames = getCurrentAttachments().map(f => f.name).join(", ") || "(none)";
      return [
        "CONSULT WITH DR. LOHIT",
        `Mode: ${getMode()}`,
        `Attachments: ${attachmentsNames}`,
        "",
        consultInput.value || "(no question provided)",
      ].join("\n");
    }

    // SOAP split / merge
    function syncSplitFromMain() {
      const text = soapOutput.value || "";
      // Very simple split on headings if they exist; otherwise just put everything in Subjective.
      const parts = { S: "", O: "", A: "", P: "" };
      const lines = text.split(/\r?\n/);
      let current = "S";
      lines.forEach((line) => {
        const trimmed = line.trim();
        const upper = trimmed.toUpperCase();
        if (upper.startsWith("SUBJECTIVE:")) current = "S";
        else if (upper.startsWith("OBJECTIVE:")) current = "O";
        else if (upper.startsWith("ASSESSMENT:")) current = "A";
        else if (upper.startsWith("PLAN:")) current = "P";
        parts[current] += line + "\n";
      });
      splitS.value = parts.S.trim();
      splitO.value = parts.O.trim();
      splitA.value = parts.A.trim();
      splitP.value = parts.P.trim();
    }

    function syncMainFromSplit() {
      const combined = [
        splitS.value ? "Subjective:\n" + splitS.value.trim() : "",
        splitO.value ? "\nObjective:\n" + splitO.value.trim() : "",
        splitA.value ? "\nAssessment:\n" + splitA.value.trim() : "",
        splitP.value ? "\nPlan:\n" + splitP.value.trim() : "",
      ]
        .filter(Boolean)
        .join("\n\n")
        .trim();
      soapOutput.value = combined;
    }

    // Toolbox context options
    function refreshToolboxContextOptions() {
      const tool = toolboxTool.value;
      toolboxContext.innerHTML = "";
      let options = [];
      if (tool === "bw-helper") {
        options = [
          ["general-bw", "General bloodwork"],
          ["pre-op-bw", "Pre-op bloodwork"],
          ["cbc-only", "CBC only"],
          ["chem-only", "Biochemistry only"],
          ["ua", "Urinalysis"],
        ];
      } else if (tool === "email-helper") {
        options = [
          ["bw-results", "Bloodwork results"],
          ["surgery-update", "Surgery update"],
          ["follow-up", "Follow-up / recheck"],
          ["med-instructions", "Medication instructions"],
        ];
      } else if (tool === "client-handout") {
        options = [
          ["derm", "Derm / allergy"],
          ["gi", "GI / vomiting / diarrhea"],
          ["dental", "Dental care"],
          ["behavior", "Behavior / anxiety"],
        ];
      } else if (tool === "soap-snippet") {
        options = [
          ["assessment-only", "Assessment only"],
          ["plan-only", "Plan only"],
          ["summary", "Short summary"],
        ];
      } else {
        options = [
          ["default", "General text"],
          ["simplify", "Simplify for client"],
        ];
      }
      options.forEach(([value, label]) => {
        const opt = document.createElement("option");
        opt.value = value;
        opt.textContent = label;
        toolboxContext.appendChild(opt);
      });
    }

    // LocalStorage templates
    const TEMPLATE_KEY = "lohit_toolbox_templates";

    function loadTemplatesFromStorage() {
      try {
        const raw = localStorage.getItem(TEMPLATE_KEY);
        const parsed = raw ? JSON.parse(raw) : {};
        return parsed && typeof parsed === "object" ? parsed : {};
      } catch {
        return {};
      }
    }

    function saveTemplatesToStorage(templates) {
      try {
        localStorage.setItem(TEMPLATE_KEY, JSON.stringify(templates));
      } catch (err) {
        console.error("Failed to save templates:", err);
      }
    }

    function refreshTemplateDropdown() {
      const templates = loadTemplatesFromStorage();
      const names = Object.keys(templates).sort((a, b) => a.localeCompare(b));

      templateSelect.innerHTML = "";
      const noneOpt = document.createElement("option");
      noneOpt.value = "";
      noneOpt.textContent = "(none)";
      templateSelect.appendChild(noneOpt);

      names.forEach((name) => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        templateSelect.appendChild(opt);
      });
    }

    // ========= EVENT HANDLERS =========

    // Tabs
    tabs.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tabName = btn.dataset.tab;
        currentTab = tabName;

        tabs.forEach((t) => t.classList.remove("active"));
        btn.classList.add("active");

        Object.entries(tabSections).forEach(([name, section]) => {
          if (name === tabName) section.classList.add("active");
          else section.classList.remove("active");
        });

        renderAttachments();
        setStatus(`Ready (${tabName}).`);
      });
    });

    // Attachments
    fileInputGlobal.addEventListener("change", (e) => {
      handleFilesSelected(e.target.files);
      fileInputGlobal.value = "";
    });

    btnShowQR.addEventListener("click", () => {
      // For now, just show an alert with current URL and instructions
      alert(
        "QR bridge v1: Open this same URL on your phone by scanning a QR that points to this page.\n\n1) On desktop: copy this URL.\n2) Use any QR generator (for now) to make a code.\n3) Scan with your phone and open the page.\n\nFuture version: this button will show a live QR automatically."
      );
    });

    // Appointment
    btnAppt.addEventListener("click", () => {
      const intakeText = buildAppointmentText();
      callBackend(getMode(), "appointment", intakeText);
    });

    // Surgery
    btnSx.addEventListener("click", () => {
      const intakeText = buildSurgeryText();
      callBackend(getMode(), "surgery", intakeText);
    });

    // Toolbox
    toolboxTool.addEventListener("change", () => {
      refreshToolboxContextOptions();
    });

    btnToolbox.addEventListener("click", () => {
      const intakeText = buildToolboxText();
      callBackend(getMode(), "toolbox", intakeText);
    });

    // Templates
    btnSaveTemplate.addEventListener("click", () => {
      const content = toolboxInput.value || "";
      if (!content.trim()) {
        alert("Nothing in Toolbox input to save as a template.");
        return;
      }
      const name = prompt("Template name?");
      if (!name) return;
      const templates = loadTemplatesFromStorage();
      templates[name] = content;
      saveTemplatesToStorage(templates);
      refreshTemplateDropdown();
      setStatus(`Saved template "${name}".`);
    });

    btnLoadTemplate.addEventListener("click", () => {
      const name = templateSelect.value;
      if (!name) return;
      const templates = loadTemplatesFromStorage();
      const content = templates[name];
      if (content) {
        toolboxInput.value = content;
        setStatus(`Loaded template "${name}".`);
      }
    });

    btnDeleteTemplate.addEventListener("click", () => {
      const name = templateSelect.value;
      if (!name) return;
      const confirmDelete = confirm(`Delete template "${name}"?`);
      if (!confirmDelete) return;
      const templates = loadTemplatesFromStorage();
      delete templates[name];
      saveTemplatesToStorage(templates);
      refreshTemplateDropdown();
      setStatus(`Deleted template "${name}".`);
    });

    // Consult
    btnConsult.addEventListener("click", () => {
      const intakeText = buildConsultText();
      callBackend(getMode(), "consult", intakeText);
    });

    // Copy
    btnCopyOutput.addEventListener("click", () => {
      if (!soapOutput.value) {
        setStatus("Nothing to copy.");
        return;
      }
      soapOutput.select();
      document.execCommand("copy");
      setStatus("Copied to clipboard.");
      window.getSelection().removeAllRanges();
    });

    // Split / merge toggle
    toggleSplitSoap.addEventListener("change", () => {
      if (toggleSplitSoap.checked) {
        syncSplitFromMain();
        outputMainWrapper.style.display = "none";
        outputSplitWrapper.style.display = "block";
      } else {
        syncMainFromSplit();
        outputMainWrapper.style.display = "block";
        outputSplitWrapper.style.display = "none";
      }
    });

    splitS.addEventListener("input", syncMainFromSplit);
    splitO.addEventListener("input", syncMainFromSplit);
    splitA.addEventListener("input", syncMainFromSplit);
    splitP.addEventListener("input", syncMainFromSplit);

    // Feedback
    btnSoapFeedback.addEventListener("click", () => {
      const currentSoap = soapOutput.value || "";
      if (!currentSoap.trim()) {
        setStatus("No SOAP to critique.");
        return;
      }
      const mode = getMode();
      const feedbackPrompt = [
        "SOAP FEEDBACK REQUEST",
        `Mode: ${mode}`,
        "",
        "Please critique the following SOAP based on Lohit's clinic rules and suggest specific improvements. Do not rewrite the SOAP; just give feedback.",
        "",
        currentSoap,
      ].join("\n");
      callBackend(mode, "feedback", feedbackPrompt);
    });

    btnRefineSoap.addEventListener("click", () => {
      const currentSoap = soapOutput.value || "";
      if (!currentSoap.trim()) {
        setStatus("No SOAP to refine.");
        return;
      }
      const fb = feedbackInput.value || "";
      const mode = getMode();
      const refinePrompt = [
        "SOAP REFINEMENT REQUEST",
        `Mode: ${mode}`,
        "",
        "Original SOAP:",
        currentSoap,
        "",
        "Doctor feedback / refine notes:",
        fb || "(none provided)",
        "",
        "Please return a revised SOAP that incorporates the feedback and keeps all clinic formatting rules.",
      ].join("\n");
      callBackend(mode, "refine", refinePrompt);
    });

    // ========= INIT =========
    (function init() {
      refreshToolboxContextOptions();
      refreshTemplateDropdown();
      renderAttachments();
      setStatus("Ready (appointment).");
    })();
  </script>
</body>
</html>